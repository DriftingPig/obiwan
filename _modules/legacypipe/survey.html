<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>legacypipe.survey &#8212; obiwan 1.2.0 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          Obiwan</a>
        <span class="navbar-text navbar-version pull-left"><b>1.2.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../api.html">API</a></li>
                <li><a href="../../tutorials.html">Tutorials</a></li>
                <li><a href="../../deeplearning.html">Deep Learning</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Pages <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">This Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for legacypipe.survey</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">fitsio</span>

<span class="kn">from</span> <span class="nn">astrometry.util.fits</span> <span class="k">import</span> <span class="n">fits_table</span><span class="p">,</span> <span class="n">merge_tables</span>
<span class="kn">from</span> <span class="nn">astrometry.util.starutil_numpy</span> <span class="k">import</span> <span class="n">degrees_between</span>

<span class="kn">from</span> <span class="nn">tractor.ellipses</span> <span class="k">import</span> <span class="n">EllipseESoft</span><span class="p">,</span> <span class="n">EllipseE</span>
<span class="kn">from</span> <span class="nn">tractor.galaxy</span> <span class="k">import</span> <span class="n">ExpGalaxy</span>
<span class="kn">from</span> <span class="nn">legacypipe.utils</span> <span class="k">import</span> <span class="n">EllipseWithPriors</span>

<span class="n">release_number</span> <span class="o">=</span> <span class="mi">5000</span>

<span class="c1"># search order: $TMPDIR, $TEMP, $TMP, then /tmp, /var/tmp, /usr/tmp</span>
<span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span>

<span class="c1"># The apertures we use in aperture photometry, in ARCSEC radius</span>
<span class="n">apertures_arcsec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">7.</span><span class="p">])</span>

<span class="c1"># Ugly hack: for sphinx documentation, the astrometry and tractor (and</span>
<span class="c1"># other) packages are replaced by mock objects.  But you can&#39;t</span>
<span class="c1"># subclass a mock object correctly, so we have to un-mock</span>
<span class="c1"># EllipseWithPriors here.</span>
<span class="k">if</span> <span class="s1">&#39;Mock&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">EllipseWithPriors</span><span class="p">)):</span>
    <span class="k">class</span> <span class="nc">duck</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="n">EllipseWithPriors</span> <span class="o">=</span> <span class="n">duck</span>

<span class="k">class</span> <span class="nc">LegacyEllipseWithPriors</span><span class="p">(</span><span class="n">EllipseWithPriors</span><span class="p">):</span>
    <span class="c1"># Prior on (softened) ellipticity: Gaussian with this standard deviation</span>
    <span class="n">ellipticityStd</span> <span class="o">=</span> <span class="mf">0.25</span>

<span class="k">class</span> <span class="nc">LogRadius</span><span class="p">(</span><span class="n">EllipseESoft</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Class used during fitting of the RexGalaxy type -- an ellipse</span>
<span class="sd">    type where only the radius is variable, and is represented in log</span>
<span class="sd">    space.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LogRadius</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lowers</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uppers</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getName</span><span class="p">():</span>
        <span class="k">return</span> <span class="s1">&#39;LogRadius&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getNamedParams</span><span class="p">():</span>
        <span class="c1"># log r: log of effective radius in arcsec</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">logre</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;log r_e=</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logre</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">theta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">e</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.</span>

<span class="k">class</span> <span class="nc">RexGalaxy</span><span class="p">(</span><span class="n">ExpGalaxy</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This defines the &#39;REX&#39; galaxy profile -- an exponential profile</span>
<span class="sd">    that is round (zero ellipticity) with variable radius.</span>
<span class="sd">    It is used to measure marginally-resolved galaxies.</span>

<span class="sd">    The real action (what makes it a Rex) happens when it is constructed,</span>
<span class="sd">    via, eg,</span>

<span class="sd">        rex = RexGalaxy(position, brightness, LogRadius(0.))</span>

<span class="sd">    (which happens in oneblob.py)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RexGalaxy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;RexGalaxy&#39;</span>

<span class="k">class</span> <span class="nc">SimpleGalaxy</span><span class="p">(</span><span class="n">ExpGalaxy</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This defines the &#39;SIMP&#39; galaxy profile -- an exponential profile</span>
<span class="sd">    with a fixed shape of a 0.45 arcsec effective radius and spherical</span>
<span class="sd">    shape.  It is used to detect marginally-resolved galaxies.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">EllipseE</span><span class="p">(</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SimpleGalaxy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">SimpleGalaxy</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; at &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
                <span class="o">+</span> <span class="s1">&#39; with &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brightness</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;(pos=&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">+</span>
                <span class="s1">&#39;, brightness=&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brightness</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getNamedParams</span><span class="p">():</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">brightness</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;SimpleGalaxy&#39;</span>

    <span class="c1">### HACK -- for Galaxy.getParamDerivatives()</span>
    <span class="k">def</span> <span class="nf">isParamFrozen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pname</span> <span class="o">==</span> <span class="s1">&#39;shape&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">SimpleGalaxy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">isParamFrozen</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BrickDuck</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A little duck-typing class when running on a custom RA,Dec center</span>
<span class="sd">    rather than a brick center.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">brickname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ra</span>  <span class="o">=</span> <span class="n">ra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">=</span> <span class="n">dec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brickname</span> <span class="o">=</span> <span class="n">brickname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brickid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>


<span class="k">def</span> <span class="nf">get_git_version</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Runs &#39;git describe&#39; in the current directory (or given dir) and</span>
<span class="sd">    returns the result as a string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir : string</span>
<span class="sd">        If non-None, &quot;cd&quot; to the given directory before running &#39;git describe&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Git version string</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">astrometry.util.run_command</span> <span class="k">import</span> <span class="n">run_command</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;cd &#39;</span><span class="si">%s</span><span class="s2">&#39; &amp;&amp; &quot;</span> <span class="o">%</span> <span class="nb">dir</span>
    <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39;git describe&#39;</span>
    <span class="n">rtn</span><span class="p">,</span><span class="n">version</span><span class="p">,</span><span class="n">err</span> <span class="o">=</span> <span class="n">run_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rtn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Failed to get version string (</span><span class="si">%s</span><span class="s1">): &#39;</span> <span class="o">%</span> <span class="n">cmd</span> <span class="o">+</span>
                           <span class="n">version</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">version</span>

<span class="k">def</span> <span class="nf">get_version_header</span><span class="p">(</span><span class="n">program_name</span><span class="p">,</span> <span class="n">survey_dir</span><span class="p">,</span> <span class="n">git_version</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Creates a fitsio header describing a DECaLS data product.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">datetime</span>

    <span class="k">if</span> <span class="n">program_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="n">program_name</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">git_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">git_version</span> <span class="o">=</span> <span class="n">get_git_version</span><span class="p">()</span>
        <span class="c1">#print(&#39;Version:&#39;, git_version)</span>

    <span class="n">hdr</span> <span class="o">=</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">FITSHDR</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s1">&#39;Data product of the DECam Legacy Survey (DECaLS)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Full documentation at http://legacysurvey.org&#39;</span><span class="p">,</span>
        <span class="p">]:</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">s</span><span class="p">))</span>
    <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;LEGPIPEV&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">git_version</span><span class="p">,</span>
                        <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;legacypipe git version&#39;</span><span class="p">))</span>
    <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SURVEYV&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">survey_dir</span><span class="p">,</span>
                        <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Legacy Survey directory&#39;</span><span class="p">))</span>
    <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;DECALSDR&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;DR5&#39;</span><span class="p">,</span>
                        <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;DECaLS release name&#39;</span><span class="p">))</span>
    <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;DECALSDT&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                        <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> run time&#39;</span> <span class="o">%</span> <span class="n">program_name</span><span class="p">))</span>
    <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SURVEY&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;DECaLS&#39;</span><span class="p">,</span>
                        <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;DECam Legacy Survey&#39;</span><span class="p">))</span>

    <span class="c1"># Requested by NOAO</span>
    <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SURVEYID&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;DECam Legacy Survey (DECaLS)&#39;</span><span class="p">,</span>
                        <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Survey name&#39;</span><span class="p">))</span>
    <span class="c1">#hdr.add_record(dict(name=&#39;SURVEYID&#39;, value=&#39;BASS MzLS&#39;,</span>
    <span class="c1">#                    comment=&#39;Survey name&#39;))</span>
    <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;DRVERSIO&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">release_number</span><span class="p">,</span>
                        <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Survey data release number&#39;</span><span class="p">))</span>
    <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;OBSTYPE&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">,</span>
                        <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Observation type&#39;</span><span class="p">))</span>
    <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;PROCTYPE&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;tile&#39;</span><span class="p">,</span>
                        <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Processing type&#39;</span><span class="p">))</span>

    <span class="kn">import</span> <span class="nn">socket</span>
    <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;HOSTNAME&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span>
                        <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Machine where runbrick.py was run&#39;</span><span class="p">))</span>
    <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;HOSTFQDN&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">(),</span>
                        <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Machine where runbrick.py was run&#39;</span><span class="p">))</span>
    <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;NERSC&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NERSC_HOST&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">),</span>
                        <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;NERSC machine where runbrick.py was run&#39;</span><span class="p">))</span>
    <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;JOB_ID&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;JOB_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">),</span>
                        <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;SLURM job id&#39;</span><span class="p">))</span>
    <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ARRAY_ID&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ARRAY_TASK_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">),</span>
                        <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;SLURM job array id&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">hdr</span>

<span class="k">class</span> <span class="nc">MyFITSHDR</span><span class="p">(</span><span class="n">fitsio</span><span class="o">.</span><span class="n">FITSHDR</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This is copied straight from fitsio, simply removing &quot;BUNIT&quot; from</span>
<span class="sd">    the list of headers to remove.  This is required to format the</span>
<span class="sd">    tractor catalogs the way we want them.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove reserved keywords from the header.</span>

<span class="sd">        These are keywords that the fits writer must write in order</span>
<span class="sd">        to maintain consistency between header and data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rmnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SIMPLE&#39;</span><span class="p">,</span><span class="s1">&#39;EXTEND&#39;</span><span class="p">,</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">,</span><span class="s1">&#39;BITPIX&#39;</span><span class="p">,</span><span class="s1">&#39;PCOUNT&#39;</span><span class="p">,</span><span class="s1">&#39;GCOUNT&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;THEAP&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;EXTNAME&#39;</span><span class="p">,</span>
                   <span class="c1">#&#39;BUNIT&#39;,</span>
                   <span class="s1">&#39;BSCALE&#39;</span><span class="p">,</span><span class="s1">&#39;BZERO&#39;</span><span class="p">,</span><span class="s1">&#39;BLANK&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;ZQUANTIZ&#39;</span><span class="p">,</span><span class="s1">&#39;ZDITHER0&#39;</span><span class="p">,</span><span class="s1">&#39;ZIMAGE&#39;</span><span class="p">,</span><span class="s1">&#39;ZCMPTYPE&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;ZSIMPLE&#39;</span><span class="p">,</span><span class="s1">&#39;ZTENSION&#39;</span><span class="p">,</span><span class="s1">&#39;ZPCOUNT&#39;</span><span class="p">,</span><span class="s1">&#39;ZGCOUNT&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;ZBITPIX&#39;</span><span class="p">,</span><span class="s1">&#39;ZEXTEND&#39;</span><span class="p">,</span>
                   <span class="c1">#&#39;FZTILELN&#39;,&#39;FZALGOR&#39;,</span>
                   <span class="s1">&#39;CHECKSUM&#39;</span><span class="p">,</span><span class="s1">&#39;DATASUM&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">rmnames</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">naxis</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">)</span>

            <span class="n">rmnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NAXIS</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">naxis</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">rmnames</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ZNAXIS&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;ZNAXIS&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">znaxis</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>

            <span class="n">rmnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ZNAXIS</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">znaxis</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">rmnames</span><span class="p">)</span>
            <span class="n">rmnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ZTILE</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">znaxis</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">rmnames</span><span class="p">)</span>
            <span class="n">rmnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ZNAME</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">znaxis</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">rmnames</span><span class="p">)</span>
            <span class="n">rmnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ZVAL</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">znaxis</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">rmnames</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TFIELDS&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tfields</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;TFIELDS&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">tfields</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="n">nbase</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TFORM&#39;</span><span class="p">,</span><span class="s1">&#39;TTYPE&#39;</span><span class="p">,</span><span class="s1">&#39;TDIM&#39;</span><span class="p">,</span><span class="s1">&#39;TUNIT&#39;</span><span class="p">,</span><span class="s1">&#39;TSCAL&#39;</span><span class="p">,</span><span class="s1">&#39;TZERO&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;TNULL&#39;</span><span class="p">,</span><span class="s1">&#39;TDISP&#39;</span><span class="p">,</span><span class="s1">&#39;TDMIN&#39;</span><span class="p">,</span><span class="s1">&#39;TDMAX&#39;</span><span class="p">,</span><span class="s1">&#39;TDESC&#39;</span><span class="p">,</span><span class="s1">&#39;TROTA&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;TRPIX&#39;</span><span class="p">,</span><span class="s1">&#39;TRVAL&#39;</span><span class="p">,</span><span class="s1">&#39;TDELT&#39;</span><span class="p">,</span><span class="s1">&#39;TCUNI&#39;</span><span class="p">,</span>
                         <span class="c1">#&#39;FZALG&#39;</span>
                        <span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">tfields</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nbase</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">bin_image</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">invvar</span><span class="p">,</span> <span class="n">S</span><span class="p">):</span>
    <span class="c1"># rebin image data</span>
    <span class="n">H</span><span class="p">,</span><span class="n">W</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sH</span><span class="p">,</span><span class="n">sW</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span><span class="o">+</span><span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">S</span><span class="p">,</span> <span class="p">(</span><span class="n">W</span><span class="o">+</span><span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">S</span>
    <span class="n">newdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sH</span><span class="p">,</span><span class="n">sW</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">newiv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sH</span><span class="p">,</span><span class="n">sW</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">invvar</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
            <span class="n">iv</span> <span class="o">=</span> <span class="n">invvar</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">S</span><span class="p">,</span> <span class="n">j</span><span class="p">::</span><span class="n">S</span><span class="p">]</span>
            <span class="n">subh</span><span class="p">,</span><span class="n">subw</span> <span class="o">=</span> <span class="n">iv</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">newdata</span><span class="p">[:</span><span class="n">subh</span><span class="p">,:</span><span class="n">subw</span><span class="p">]</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">S</span><span class="p">,</span> <span class="n">j</span><span class="p">::</span><span class="n">S</span><span class="p">]</span> <span class="o">*</span> <span class="n">iv</span>
            <span class="n">newiv</span>  <span class="p">[:</span><span class="n">subh</span><span class="p">,:</span><span class="n">subw</span><span class="p">]</span> <span class="o">+=</span> <span class="n">iv</span>
    <span class="n">newdata</span> <span class="o">/=</span> <span class="p">(</span><span class="n">newiv</span> <span class="o">+</span> <span class="p">(</span><span class="n">newiv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">newdata</span><span class="p">[</span><span class="n">newiv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">newdata</span><span class="p">,</span><span class="n">newiv</span>

<span class="k">def</span> <span class="nf">tim_get_resamp</span><span class="p">(</span><span class="n">tim</span><span class="p">,</span> <span class="n">targetwcs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">astrometry.util.resample</span> <span class="k">import</span> <span class="n">resample_with_wcs</span><span class="p">,</span><span class="n">OverlapError</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tim</span><span class="p">,</span> <span class="s1">&#39;resamp&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tim</span><span class="o">.</span><span class="n">resamp</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Yo</span><span class="p">,</span><span class="n">Xo</span><span class="p">,</span><span class="n">Yi</span><span class="p">,</span><span class="n">Xi</span><span class="p">,</span><span class="n">nil</span> <span class="o">=</span> <span class="n">resample_with_wcs</span><span class="p">(</span><span class="n">targetwcs</span><span class="p">,</span> <span class="n">tim</span><span class="o">.</span><span class="n">subwcs</span><span class="p">,</span> <span class="p">[],</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">OverlapError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No overlap&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Yo</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">resamp</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Yo</span><span class="p">,</span><span class="n">Xo</span><span class="p">,</span><span class="n">Yi</span><span class="p">,</span><span class="n">Xi</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">resamp</span>

<span class="k">def</span> <span class="nf">get_rgb</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">mnmx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arcsinh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a list of images in the given bands, returns a scaled RGB</span>
<span class="sd">    image.</span>

<span class="sd">    *imgs*  a list of numpy arrays, all the same size, in nanomaggies</span>
<span class="sd">    *bands* a list of strings, eg, [&#39;g&#39;,&#39;r&#39;,&#39;z&#39;]</span>
<span class="sd">    *mnmx*  = (min,max), values that will become black/white *after* scaling.</span>
<span class="sd">        Default is (-3,10)</span>
<span class="sd">    *arcsinh* use nonlinear scaling as in SDSS</span>
<span class="sd">    *scales*</span>

<span class="sd">    Returns a (H,W,3) numpy array with values between 0 and 1.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">bands</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>

    <span class="n">grzscales</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.0066</span><span class="p">),</span>
                      <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
                      <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">),</span>
                      <span class="p">)</span>

    <span class="c1"># print(&#39;get_rgb: bands&#39;, bands)</span>

    <span class="k">if</span> <span class="n">scales</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bands</span> <span class="o">==</span> <span class="s1">&#39;grz&#39;</span><span class="p">:</span>
            <span class="n">scales</span> <span class="o">=</span> <span class="n">grzscales</span>
        <span class="k">elif</span> <span class="n">bands</span> <span class="o">==</span> <span class="s1">&#39;urz&#39;</span><span class="p">:</span>
            <span class="n">scales</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.0066</span><span class="p">),</span>
                          <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
                          <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">),</span>
                          <span class="p">)</span>
        <span class="k">elif</span> <span class="n">bands</span> <span class="o">==</span> <span class="s1">&#39;gri&#39;</span><span class="p">:</span>
            <span class="c1"># scales = dict(g = (2, 0.004),</span>
            <span class="c1">#               r = (1, 0.0066),</span>
            <span class="c1">#               i = (0, 0.01),</span>
            <span class="c1">#               )</span>
            <span class="n">scales</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">),</span>
                          <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.004</span><span class="p">),</span>
                          <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">),</span>
                          <span class="p">)</span>
        <span class="k">elif</span> <span class="n">bands</span> <span class="o">==</span> <span class="s1">&#39;ugriz&#39;</span><span class="p">:</span>
            <span class="n">scales</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.0066</span><span class="p">),</span>
                          <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
                          <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
                          <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scales</span> <span class="o">=</span> <span class="n">grzscales</span>

    <span class="c1"># print(&#39;Using scales:&#39;, scales)</span>
    <span class="n">h</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">im</span><span class="p">,</span><span class="n">band</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">bands</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">scales</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: band&#39;</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="s1">&#39;not used in creating RGB image&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">plane</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scales</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.</span><span class="p">))</span>
        <span class="c1"># print(&#39;RGB: band&#39;, band, &#39;in plane&#39;, plane, &#39;scaled by&#39;, scale)</span>
        <span class="n">rgb</span><span class="p">[:,:,</span><span class="n">plane</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mnmx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mn</span><span class="p">,</span><span class="n">mx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mn</span><span class="p">,</span><span class="n">mx</span> <span class="o">=</span> <span class="n">mnmx</span>

    <span class="k">if</span> <span class="n">arcsinh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">nlmap</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsinh</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">arcsinh</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">arcsinh</span><span class="p">)</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">nlmap</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="n">nlmap</span><span class="p">(</span><span class="n">mn</span><span class="p">)</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="n">nlmap</span><span class="p">(</span><span class="n">mx</span><span class="p">)</span>

    <span class="n">rgb</span> <span class="o">=</span> <span class="p">(</span><span class="n">rgb</span> <span class="o">-</span> <span class="n">mn</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mx</span> <span class="o">-</span> <span class="n">mn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clip</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rgb</span>

<span class="k">def</span> <span class="nf">switch_to_soft_ellipses</span><span class="p">(</span><span class="n">cat</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Converts our softened-ellipticity EllipseESoft parameters into</span>
<span class="sd">    normal EllipseE ellipses.</span>

<span class="sd">    *cat*: an iterable of tractor Sources, which will be modified</span>
<span class="sd">     in-place.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">tractor.galaxy</span> <span class="k">import</span> <span class="n">DevGalaxy</span><span class="p">,</span> <span class="n">ExpGalaxy</span><span class="p">,</span> <span class="n">FixedCompositeGalaxy</span>
    <span class="kn">from</span> <span class="nn">tractor.ellipses</span> <span class="k">import</span> <span class="n">EllipseESoft</span>
    <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">cat</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">(</span><span class="n">DevGalaxy</span><span class="p">,</span> <span class="n">ExpGalaxy</span><span class="p">)):</span>
            <span class="n">src</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">EllipseESoft</span><span class="o">.</span><span class="n">fromEllipseE</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">FixedCompositeGalaxy</span><span class="p">):</span>
            <span class="n">src</span><span class="o">.</span><span class="n">shapeDev</span> <span class="o">=</span> <span class="n">EllipseESoft</span><span class="o">.</span><span class="n">fromEllipseE</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">shapeDev</span><span class="p">)</span>
            <span class="n">src</span><span class="o">.</span><span class="n">shapeExp</span> <span class="o">=</span> <span class="n">EllipseESoft</span><span class="o">.</span><span class="n">fromEllipseE</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">shapeExp</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">on_bricks_dependencies</span><span class="p">(</span><span class="n">brick</span><span class="p">,</span> <span class="n">survey</span><span class="p">,</span> <span class="n">bricks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Find nearby bricks from earlier brick phases</span>
    <span class="k">if</span> <span class="n">bricks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bricks</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">get_bricks_readonly</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bricks</span><span class="p">),</span> <span class="s1">&#39;bricks&#39;</span><span class="p">)</span>
    <span class="n">bricks</span> <span class="o">=</span> <span class="n">bricks</span><span class="p">[</span><span class="n">bricks</span><span class="o">.</span><span class="n">brickq</span> <span class="o">&lt;</span> <span class="n">brick</span><span class="o">.</span><span class="n">brickq</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bricks</span><span class="p">),</span> <span class="s1">&#39;from phases before this brickq:&#39;</span><span class="p">,</span> <span class="n">brick</span><span class="o">.</span><span class="n">brickq</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bricks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="kn">from</span> <span class="nn">astrometry.libkd.spherematch</span> <span class="k">import</span> <span class="n">match_radec</span>

    <span class="n">radius</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">bricksize</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.01</span>
    <span class="n">bricks</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">brick</span><span class="o">.</span><span class="n">dec</span> <span class="o">-</span> <span class="n">bricks</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">radius</span><span class="p">)</span>
    <span class="c1">#print(len(bricks), &#39;within %.2f degree of Dec&#39; % radius)</span>
    <span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">d</span> <span class="o">=</span> <span class="n">match_radec</span><span class="p">(</span><span class="n">brick</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">brick</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">bricks</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">bricks</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
    <span class="n">bricks</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bricks</span><span class="p">),</span> <span class="s1">&#39;within&#39;</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="s1">&#39;degrees&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bricks</span>

<span class="k">def</span> <span class="nf">brick_catalog_for_radec_box</span><span class="p">(</span><span class="n">ralo</span><span class="p">,</span> <span class="n">rahi</span><span class="p">,</span> <span class="n">declo</span><span class="p">,</span> <span class="n">dechi</span><span class="p">,</span>
                                <span class="n">survey</span><span class="p">,</span> <span class="n">catpattern</span><span class="p">,</span> <span class="n">bricks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Merges multiple Tractor brick catalogs to cover an RA,Dec</span>
<span class="sd">    bounding-box.</span>

<span class="sd">    No cleverness with RA wrap-around; assumes ralo &lt; rahi.</span>

<span class="sd">    survey: LegacySurveyData object</span>

<span class="sd">    bricks: table of bricks, eg from LegacySurveyData.get_bricks()</span>

<span class="sd">    catpattern: filename pattern of catalog files to read,</span>
<span class="sd">        eg &quot;pipebrick-cats/tractor-phot-%06i.its&quot;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">ralo</span> <span class="o">&lt;</span> <span class="n">rahi</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">declo</span> <span class="o">&lt;</span> <span class="n">dechi</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bricks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bricks</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">get_bricks_readonly</span><span class="p">()</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">bricks_touching_radec_box</span><span class="p">(</span><span class="n">bricks</span><span class="p">,</span> <span class="n">ralo</span><span class="p">,</span> <span class="n">rahi</span><span class="p">,</span> <span class="n">declo</span><span class="p">,</span> <span class="n">dechi</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">),</span> <span class="s1">&#39;bricks touch RA,Dec box&#39;</span><span class="p">)</span>
    <span class="n">TT</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">I</span><span class="p">:</span>
        <span class="n">brick</span> <span class="o">=</span> <span class="n">bricks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">catpattern</span> <span class="o">%</span> <span class="n">brick</span><span class="o">.</span><span class="n">brickid</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Catalog&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: catalog does not exist:&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">fits_table</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">T</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: empty catalog&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">T</span><span class="o">.</span><span class="n">cut</span><span class="p">((</span><span class="n">T</span><span class="o">.</span><span class="n">ra</span>  <span class="o">&gt;=</span> <span class="n">ralo</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">ra</span>  <span class="o">&lt;=</span> <span class="n">rahi</span><span class="p">)</span> <span class="o">*</span>
              <span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dec</span> <span class="o">&gt;=</span> <span class="n">declo</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dec</span> <span class="o">&lt;=</span> <span class="n">dechi</span><span class="p">))</span>
        <span class="n">TT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">merge_tables</span><span class="p">(</span><span class="n">TT</span><span class="p">)</span>
    <span class="c1"># arbitrarily keep the first header</span>
    <span class="n">T</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="n">TT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_header</span>
    <span class="k">return</span> <span class="n">T</span>

<span class="k">def</span> <span class="nf">ccd_map_image</span><span class="p">(</span><span class="n">valmap</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;valmap: { &#39;N7&#39; : 1., &#39;N8&#39; : 17.8 }</span>

<span class="sd">    Returns: a numpy image (shape (12,14)) with values mapped to their</span>
<span class="sd">    CCD locations.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">12</span><span class="p">,</span><span class="mi">14</span><span class="p">))</span>
    <span class="n">img</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">empty</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">valmap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span> <span class="o">=</span> <span class="n">ccd_map_extent</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="c1">#img[y0+6:y1+6, x0+7:x1+7] = v</span>
        <span class="n">img</span><span class="p">[</span><span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">img</span>

<span class="k">def</span> <span class="nf">ccd_map_center</span><span class="p">(</span><span class="n">ccdname</span><span class="p">):</span>
    <span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span> <span class="o">=</span> <span class="n">ccd_map_extent</span><span class="p">(</span><span class="n">ccdname</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="p">(</span><span class="n">y0</span><span class="o">+</span><span class="n">y1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>

<span class="k">def</span> <span class="nf">ccd_map_extent</span><span class="p">(</span><span class="n">ccdname</span><span class="p">,</span> <span class="n">inset</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">ccdname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ccdname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">))</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ccdname</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">num</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">13</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">19</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">13</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">24</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">-</span> <span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">19</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">28</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">24</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">28</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">if</span> <span class="n">ccdname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">):</span>
        <span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x0</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">y0</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">y0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x0</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y0</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Shift from being (0,0)-centered to being aligned with the</span>
    <span class="c1"># ccd_map_image() image.</span>
    <span class="n">x0</span> <span class="o">+=</span> <span class="mi">7</span>
    <span class="n">x1</span> <span class="o">+=</span> <span class="mi">7</span>
    <span class="n">y0</span> <span class="o">+=</span> <span class="mi">6</span>
    <span class="n">y1</span> <span class="o">+=</span> <span class="mi">6</span>

    <span class="k">if</span> <span class="n">inset</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">inset</span><span class="p">,</span> <span class="n">x1</span><span class="o">-</span><span class="n">inset</span><span class="p">,</span> <span class="n">y0</span><span class="o">+</span><span class="n">inset</span><span class="p">,</span> <span class="n">y1</span><span class="o">-</span><span class="n">inset</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">wcs_for_brick</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span> <span class="n">pixscale</span><span class="o">=</span><span class="mf">0.262</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns an astrometry.net style Tan WCS object for a given brick object.</span>

<span class="sd">    b: row from survey-bricks.fits file</span>
<span class="sd">    W,H: size in pixels</span>
<span class="sd">    pixscale: pixel scale in arcsec/pixel.</span>

<span class="sd">    Returns: Tan wcs object</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">astrometry.util.util</span> <span class="k">import</span> <span class="n">Tan</span>
    <span class="n">pixscale</span> <span class="o">=</span> <span class="n">pixscale</span> <span class="o">/</span> <span class="mf">3600.</span>
    <span class="k">return</span> <span class="n">Tan</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">W</span><span class="o">/</span><span class="mf">2.</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">H</span><span class="o">/</span><span class="mf">2.</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span>
               <span class="o">-</span><span class="n">pixscale</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">pixscale</span><span class="p">,</span>
               <span class="nb">float</span><span class="p">(</span><span class="n">W</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">H</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">bricks_touching_wcs</span><span class="p">(</span><span class="n">targetwcs</span><span class="p">,</span> <span class="n">survey</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Finds LegacySurvey bricks touching a given WCS header object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    targetwcs : astrometry.util.Tan object or similar</span>
<span class="sd">        The region of sky to search</span>
<span class="sd">    survey : legacypipe.survey.LegacySurveyData object</span>
<span class="sd">        From which the brick table will be retrieved</span>
<span class="sd">    B : FITS table</span>
<span class="sd">        The table of brick objects to search</span>
<span class="sd">    margin : int</span>
<span class="sd">        Margin in pixels around the outside of the WCS</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A table (subset of B, if given) containing the bricks touching the</span>
<span class="sd">    given WCS region + margin.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">astrometry.libkd.spherematch</span> <span class="k">import</span> <span class="n">match_radec</span>
    <span class="kn">from</span> <span class="nn">astrometry.util.miscutils</span> <span class="k">import</span> <span class="n">clip_wcs</span>

    <span class="k">if</span> <span class="n">B</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">survey</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">get_bricks_readonly</span><span class="p">()</span>

    <span class="n">ra</span><span class="p">,</span><span class="n">dec</span> <span class="o">=</span> <span class="n">targetwcs</span><span class="o">.</span><span class="n">radec_center</span><span class="p">()</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">targetwcs</span><span class="o">.</span><span class="n">radius</span><span class="p">()</span>

    <span class="c1"># MAGIC 0.4 degree search radius =</span>
    <span class="c1"># DECam hypot(1024,2048)*0.27/3600 + Brick hypot(0.25, 0.25) ~= 0.35 + margin</span>
    <span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">d</span> <span class="o">=</span> <span class="n">match_radec</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span>
                        <span class="n">radius</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">),</span> <span class="s1">&#39;bricks nearby&#39;</span><span class="p">)</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">I</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">brickwcs</span> <span class="o">=</span> <span class="n">wcs_for_brick</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="n">clip_wcs</span><span class="p">(</span><span class="n">targetwcs</span><span class="p">,</span> <span class="n">brickwcs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clip</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No overlap with brick&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">brickname</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">B</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">keep</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">ccds_touching_wcs</span><span class="p">(</span><span class="n">targetwcs</span><span class="p">,</span> <span class="n">ccds</span><span class="p">,</span> <span class="n">ccdrad</span><span class="o">=</span><span class="mf">0.17</span><span class="p">,</span> <span class="n">polygons</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    targetwcs: wcs object describing region of interest</span>
<span class="sd">    ccds: fits_table object of CCDs</span>

<span class="sd">    ccdrad: radius of CCDs, in degrees.  Default 0.17 is for DECam.</span>
<span class="sd">    #If None, computed from T.</span>

<span class="sd">    Returns: index array I of CCDs within range.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">astrometry.util.util</span> <span class="k">import</span> <span class="n">Tan</span>
    <span class="kn">from</span> <span class="nn">astrometry.util.miscutils</span> <span class="k">import</span> <span class="n">polygons_intersect</span>

    <span class="n">trad</span> <span class="o">=</span> <span class="n">targetwcs</span><span class="o">.</span><span class="n">radius</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ccdrad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ccdrad</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ccds</span><span class="o">.</span><span class="n">cd1_1</span> <span class="o">*</span> <span class="n">ccds</span><span class="o">.</span><span class="n">cd2_2</span> <span class="o">-</span>
                                    <span class="n">ccds</span><span class="o">.</span><span class="n">cd1_2</span> <span class="o">*</span> <span class="n">ccds</span><span class="o">.</span><span class="n">cd2_1</span><span class="p">))</span> <span class="o">*</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">ccds</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">ccds</span><span class="o">.</span><span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>

    <span class="n">rad</span> <span class="o">=</span> <span class="n">trad</span> <span class="o">+</span> <span class="n">ccdrad</span>
    <span class="n">r</span><span class="p">,</span><span class="n">d</span> <span class="o">=</span> <span class="n">targetwcs</span><span class="o">.</span><span class="n">radec_center</span><span class="p">()</span>
    <span class="n">I</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ccds</span><span class="o">.</span><span class="n">dec</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rad</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">degrees_between</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ccds</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">ccds</span><span class="o">.</span><span class="n">dec</span><span class="p">[</span><span class="n">I</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">rad</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">polygons</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">I</span>
    <span class="c1"># now check actual polygon intersection</span>
    <span class="n">tw</span><span class="p">,</span><span class="n">th</span> <span class="o">=</span> <span class="n">targetwcs</span><span class="o">.</span><span class="n">imagew</span><span class="p">,</span> <span class="n">targetwcs</span><span class="o">.</span><span class="n">imageh</span>
    <span class="n">targetpoly</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),(</span><span class="n">tw</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),(</span><span class="n">tw</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span><span class="n">th</span><span class="o">+</span><span class="mf">0.5</span><span class="p">),(</span><span class="mf">0.5</span><span class="p">,</span><span class="n">th</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)]</span>
    <span class="n">cd</span> <span class="o">=</span> <span class="n">targetwcs</span><span class="o">.</span><span class="n">get_cd</span><span class="p">()</span>
    <span class="n">tdet</span> <span class="o">=</span> <span class="n">cd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">cd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">cd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">cd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">tdet</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">targetpoly</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">targetpoly</span><span class="p">))</span>
    <span class="n">targetpoly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">targetpoly</span><span class="p">)</span>

    <span class="n">keep</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">I</span><span class="p">:</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">ccds</span><span class="o">.</span><span class="n">width</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ccds</span><span class="o">.</span><span class="n">height</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">wcs</span> <span class="o">=</span> <span class="n">Tan</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                    <span class="p">[</span><span class="n">ccds</span><span class="o">.</span><span class="n">crval1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ccds</span><span class="o">.</span><span class="n">crval2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ccds</span><span class="o">.</span><span class="n">crpix1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ccds</span><span class="o">.</span><span class="n">crpix2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                     <span class="n">ccds</span><span class="o">.</span><span class="n">cd1_1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ccds</span><span class="o">.</span><span class="n">cd1_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ccds</span><span class="o">.</span><span class="n">cd2_1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ccds</span><span class="o">.</span><span class="n">cd2_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">]])</span>
        <span class="n">cd</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">get_cd</span><span class="p">()</span>
        <span class="n">wdet</span> <span class="o">=</span> <span class="n">cd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">cd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">cd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">cd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="p">[(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),(</span><span class="n">W</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),(</span><span class="n">W</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span><span class="n">H</span><span class="o">+</span><span class="mf">0.5</span><span class="p">),(</span><span class="mf">0.5</span><span class="p">,</span><span class="n">H</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)]:</span>
            <span class="n">rr</span><span class="p">,</span><span class="n">dd</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">pixelxy2radec</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
            <span class="n">ok</span><span class="p">,</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span> <span class="o">=</span> <span class="n">targetwcs</span><span class="o">.</span><span class="n">radec2pixelxy</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span><span class="n">dd</span><span class="p">)</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">wdet</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">poly</span><span class="p">))</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">polygons_intersect</span><span class="p">(</span><span class="n">targetpoly</span><span class="p">,</span> <span class="n">poly</span><span class="p">):</span>
            <span class="n">keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">I</span>

<span class="k">def</span> <span class="nf">create_temp</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">f</span><span class="p">,</span><span class="n">fn</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">tempdir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fn</span>

<span class="k">def</span> <span class="nf">imsave_jpeg</span><span class="p">(</span><span class="n">jpegfn</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Saves a image in JPEG format.  Some matplotlib installations</span>
<span class="sd">    (notably at NERSC) don&#39;t support jpeg, so we write to PNG and then</span>
<span class="sd">    convert to JPEG using the venerable netpbm tools.</span>

<span class="sd">    *jpegfn*: JPEG filename</span>
<span class="sd">    *img*: image, in the typical matplotlib formats (see plt.imsave)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="n">tmpfn</span> <span class="o">=</span> <span class="n">create_temp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">tmpfn</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;pngtopnm </span><span class="si">%s</span><span class="s1"> | pnmtojpeg -quality 90 &gt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tmpfn</span><span class="p">,</span> <span class="n">jpegfn</span><span class="p">))</span>
    <span class="n">rtn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">rtn</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">tmpfn</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LegacySurveyData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A class describing the contents of a LEGACY_SURVEY_DIR directory --</span>
<span class="sd">    tables of CCDs and of bricks, and calibration data.  Methods for</span>
<span class="sd">    dealing with the CCDs and bricks tables.</span>

<span class="sd">    This class is also responsible for creating LegacySurveyImage</span>
<span class="sd">    objects (eg, DecamImage objects), which then allow data to be read</span>
<span class="sd">    from disk.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Bit codes for why a CCD got cut, used in cut_ccds().</span>
    <span class="n">ccd_cut_bits</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">BLACKLIST</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
        <span class="n">BAD_EXPID</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
        <span class="n">CCDNAME_HDU_MISMATCH</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
        <span class="n">BAD_ASTROMETRY</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
        <span class="n">THIRD_PIXEL</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span> <span class="c1"># Mosaic3 one-third-pixel interpolation problem</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">survey_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ccds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a LegacySurveyData object using data from the given</span>
<span class="sd">        *survey_dir* directory, or from the $LEGACY_SURVEY_DIR environment</span>
<span class="sd">        variable.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        survey_dir : string</span>
<span class="sd">            Defaults to $LEGACY_SURVEY_DIR environment variable.  Where to look for</span>
<span class="sd">            files including calibration files, tables of CCDs and bricks, image data,</span>
<span class="sd">            etc.</span>

<span class="sd">        cache_dir : string</span>
<span class="sd">            Directory to search for input files before looking in survey_dir.  Useful</span>
<span class="sd">            for, eg, Burst Buffer.</span>
<span class="sd">            </span>
<span class="sd">        output_dir : string</span>
<span class="sd">            Base directory for output files; default &quot;.&quot;.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">legacypipe.decam</span>  <span class="k">import</span> <span class="n">DecamImage</span>
        <span class="kn">from</span> <span class="nn">legacypipe.mosaic</span> <span class="k">import</span> <span class="n">MosaicImage</span>
        <span class="kn">from</span> <span class="nn">legacypipe.bok</span>    <span class="k">import</span> <span class="n">BokImage</span>
        <span class="kn">from</span> <span class="nn">legacypipe.ptf</span>    <span class="k">import</span> <span class="n">PtfImage</span>
        <span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>

        <span class="k">if</span> <span class="n">survey_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">survey_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LEGACY_SURVEY_DIR&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">survey_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;Warning: you should set the $LEGACY_SURVEY_DIR environment variable.</span>
<span class="s1">On NERSC, you can do:</span>
<span class="s1">  module use /project/projectdirs/cosmo/work/decam/versions/modules</span>
<span class="s1">  module load legacysurvey</span>

<span class="s1">Now using the current directory as LEGACY_SURVEY_DIR, but this is likely to fail.</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
                <span class="n">survey_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">survey_dir</span> <span class="o">=</span> <span class="n">survey_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span>

        <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_file_hashes</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccds</span> <span class="o">=</span> <span class="n">ccds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bricks</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create and cache a kd-tree for bricks_touching_radec_box ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_tree</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bricktree</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">### HACK! Hard-coded brick edge size, in degrees!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bricksize</span> <span class="o">=</span> <span class="mf">0.25</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_typemap</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;decam&#39;</span>  <span class="p">:</span> <span class="n">DecamImage</span><span class="p">,</span>
            <span class="s1">&#39;mosaic&#39;</span> <span class="p">:</span> <span class="n">MosaicImage</span><span class="p">,</span>
            <span class="s1">&#39;mosaic3&#39;</span><span class="p">:</span> <span class="n">MosaicImage</span><span class="p">,</span>
            <span class="s1">&#39;90prime&#39;</span><span class="p">:</span> <span class="n">BokImage</span><span class="p">,</span>
            <span class="s1">&#39;ptf&#39;</span>    <span class="p">:</span> <span class="n">PtfImage</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">allbands</span> <span class="o">=</span> <span class="s1">&#39;ugrizY&#39;</span>

        <span class="k">assert</span><span class="p">(</span><span class="n">version</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;dr2&#39;</span><span class="p">,</span> <span class="s1">&#39;dr1&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>

        <span class="c1"># Filename prefix for coadd files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_prefix</span> <span class="o">=</span> <span class="s1">&#39;legacysurvey&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dr1&#39;</span><span class="p">,</span><span class="s1">&#39;dr2&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_prefix</span> <span class="o">=</span> <span class="s1">&#39;decals&#39;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: dir </span><span class="si">%s</span><span class="s1">, out </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">survey_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ccds_for_fitting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">brick</span><span class="p">,</span> <span class="n">ccds</span><span class="p">):</span>
        <span class="c1"># By default, use all.</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">image_class_for_camera</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">camera</span><span class="p">):</span>
        <span class="c1"># Assert that we have correctly removed trailing spaces</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">camera</span> <span class="o">==</span> <span class="n">camera</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_typemap</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">sed_matched_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bands</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">legacypipe.detection</span> <span class="k">import</span> <span class="n">sed_matched_filters</span>
        <span class="k">return</span> <span class="n">sed_matched_filters</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">index_of_band</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">allbands</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_intermediate_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">brick</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reads the intermediate tractor catalog for the given brickname.</span>

<span class="sd">        *kwargs*: passed to self.find_file()</span>

<span class="sd">        Returns (T, hdr, primhdr)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_file</span><span class="p">(</span><span class="s1">&#39;tractor-intermediate&#39;</span><span class="p">,</span> <span class="n">brick</span><span class="o">=</span><span class="n">brick</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">fits_table</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">get_header</span><span class="p">()</span>
        <span class="n">primhdr</span> <span class="o">=</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">read_header</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="n">in_flux_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># Ensure flux arrays are 2d (N x 1)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_ivar&#39;</span><span class="p">,</span> <span class="s1">&#39;rchi2&#39;</span><span class="p">,</span> <span class="s1">&#39;fracflux&#39;</span><span class="p">,</span> <span class="s1">&#39;fracmasked&#39;</span><span class="p">,</span>
                <span class="s1">&#39;fracin&#39;</span><span class="p">,</span> <span class="s1">&#39;nobs&#39;</span><span class="p">,</span> <span class="s1">&#39;anymask&#39;</span><span class="p">,</span> <span class="s1">&#39;allmask&#39;</span><span class="p">,</span> <span class="s1">&#39;psfsize&#39;</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">,</span>
                <span class="s1">&#39;galdepth&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">incol</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">in_flux_prefix</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">incol</span><span class="p">)</span>
            <span class="c1"># Hmm, if we need to reshape one of these arrays, we will</span>
            <span class="c1"># need to do all of them.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="n">T</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">incol</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">T</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">primhdr</span>

    <span class="k">def</span> <span class="nf">find_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filetype</span><span class="p">,</span> <span class="n">brick</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">brickpre</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(band)s</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the filename of a Legacy Survey file.</span>

<span class="sd">        *filetype* : string, type of file to find, including:</span>
<span class="sd">             &quot;tractor&quot; -- Tractor catalogs</span>
<span class="sd">             &quot;depth&quot;   -- PSF depth maps</span>
<span class="sd">             &quot;galdepth&quot; -- Canonical galaxy depth maps</span>
<span class="sd">             &quot;nexp&quot; -- number-of-exposure maps</span>

<span class="sd">        *brick* : string, brick name such as &quot;0001p000&quot;</span>

<span class="sd">        *output*: True if we are about to write this file; will use self.outdir as</span>
<span class="sd">        the base directory rather than self.survey_dir.</span>

<span class="sd">        Returns: path to the specified file (whether or not it exists).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>

        <span class="k">if</span> <span class="n">brick</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">brick</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(brick)s</span><span class="s1">&#39;</span>
            <span class="n">brickpre</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(brick).3s</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">brickpre</span> <span class="o">=</span> <span class="n">brick</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">basedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">survey_dir</span>

        <span class="k">if</span> <span class="n">brick</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">codir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;coadd&#39;</span><span class="p">,</span> <span class="n">brickpre</span><span class="p">,</span> <span class="n">brick</span><span class="p">)</span>

        <span class="c1"># Swap in files in the self.cache_dir, if they exist.</span>
        <span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fn</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_cache</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">swaplist</span><span class="p">(</span><span class="n">fns</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">output</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fns</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">check_cache</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fns</span><span class="p">]</span>

        <span class="n">sname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_prefix</span>

        <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;bricks&#39;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;survey-bricks.fits.gz&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dr1&#39;</span><span class="p">,</span><span class="s1">&#39;dr2&#39;</span><span class="p">]:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;decals-bricks.fits&#39;</span>
            <span class="k">return</span> <span class="n">swap</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">fn</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;ccds&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dr1&#39;</span><span class="p">,</span><span class="s1">&#39;dr2&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">swaplist</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;decals-ccds.fits.gz&#39;</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">swaplist</span><span class="p">(</span>
                    <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;survey-ccds-*.fits.gz&#39;</span><span class="p">)))</span>

        <span class="k">elif</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;ccd-kds&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">swaplist</span><span class="p">(</span>
                <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;survey-ccds-*.kd.fits&#39;</span><span class="p">)))</span>

        <span class="k">elif</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;tycho2&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">swap</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;tycho2.fits.gz&#39;</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;annotated-ccds&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;dr2&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">swaplist</span><span class="p">(</span>
                    <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;decals-ccds-annotated.fits&#39;</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">swaplist</span><span class="p">(</span>
                <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;ccds-annotated-*.fits.gz&#39;</span><span class="p">)))</span>

        <span class="k">elif</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;tractor&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">swap</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;tractor&#39;</span><span class="p">,</span> <span class="n">brickpre</span><span class="p">,</span>
                                     <span class="s1">&#39;tractor-</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="n">brick</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;tractor-intermediate&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">swap</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;tractor-i&#39;</span><span class="p">,</span> <span class="n">brickpre</span><span class="p">,</span>
                                     <span class="s1">&#39;tractor-</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="n">brick</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;galaxy-sims&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">swap</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;tractor&#39;</span><span class="p">,</span> <span class="n">brickpre</span><span class="p">,</span>
                                     <span class="s1">&#39;galaxy-sims-</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="n">brick</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">filetype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ccds-table&#39;</span><span class="p">,</span> <span class="s1">&#39;depth-table&#39;</span><span class="p">]:</span>
            <span class="n">ty</span> <span class="o">=</span> <span class="n">filetype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">swap</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">codir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sname</span><span class="p">,</span> <span class="n">brick</span><span class="p">,</span> <span class="n">ty</span><span class="p">)))</span>

        <span class="k">elif</span> <span class="n">filetype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;image-jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;model-jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;resid-jpeg&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;imageblob-jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;simscoadd-jpeg&#39;</span><span class="p">,</span><span class="s1">&#39;imagecoadd-jpeg&#39;</span><span class="p">]:</span> 
            <span class="n">ty</span> <span class="o">=</span> <span class="n">filetype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">swap</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">codir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">.jpg&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sname</span><span class="p">,</span> <span class="n">brick</span><span class="p">,</span> <span class="n">ty</span><span class="p">)))</span>

        <span class="k">elif</span> <span class="n">filetype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;invvar&#39;</span><span class="p">,</span> <span class="s1">&#39;chi2&#39;</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="s1">&#39;galdepth&#39;</span><span class="p">,</span> <span class="s1">&#39;nexp&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">swap</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">codir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">.fits.fz&#39;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="n">sname</span><span class="p">,</span> <span class="n">brick</span><span class="p">,</span> <span class="n">filetype</span><span class="p">,</span><span class="n">band</span><span class="p">)))</span>

        <span class="k">elif</span> <span class="n">filetype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;blobmap&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">swap</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">,</span> <span class="n">brickpre</span><span class="p">,</span>
                                     <span class="s1">&#39;blobs-</span><span class="si">%s</span><span class="s1">.fits.gz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">brick</span><span class="p">)))</span>

        <span class="k">elif</span> <span class="n">filetype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all-models&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">swap</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">,</span> <span class="n">brickpre</span><span class="p">,</span>
                                     <span class="s1">&#39;all-models-</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">brick</span><span class="p">)))</span>

        <span class="k">elif</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;checksums&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">swap</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;tractor&#39;</span><span class="p">,</span> <span class="n">brickpre</span><span class="p">,</span>
                                     <span class="s1">&#39;brick-</span><span class="si">%s</span><span class="s1">.sha256sum&#39;</span> <span class="o">%</span> <span class="n">brick</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown filetype &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">filetype</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fn</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survey_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfn</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cfn</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="k">def</span> <span class="nf">get_compression_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filetype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="c1"># g: sigma ~ 0.002.  qz -1e-3: 6 MB, -1e-4: 10 MB</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="s1">&#39;[compress R 100,100; qz -1e-4]&#39;</span><span class="p">,</span>
                    <span class="c1"># g: qz -1e-3: 2 MB, -1e-4: 2.75 MB</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;[compress R 100,100; qz -1e-4]&#39;</span><span class="p">,</span>
                    <span class="n">chi2</span>  <span class="o">=</span> <span class="s1">&#39;[compress R 100,100; qz -0.1]&#39;</span><span class="p">,</span>
                    <span class="c1"># qz +8: 9 MB, qz +16: 10.5 MB</span>
                    <span class="n">invvar</span> <span class="o">=</span> <span class="s1">&#39;[compress R 100,100; qz 16]&#39;</span><span class="p">,</span>
                    <span class="n">nexp</span>   <span class="o">=</span> <span class="s1">&#39;[compress H 100,100]&#39;</span><span class="p">,</span>
                    <span class="n">depth</span>  <span class="o">=</span> <span class="s1">&#39;[compress G 100,100; qz 0]&#39;</span><span class="p">,</span>
                    <span class="n">galdepth</span> <span class="o">=</span> <span class="s1">&#39;[compress G 100,100; qz 0]&#39;</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">filetype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filetype</span><span class="p">,</span> <span class="n">hashsum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a context manager for writing an output file; use like:</span>

<span class="sd">        with survey.write_output(&#39;ccds&#39;, brick=brickname) as out:</span>
<span class="sd">            ccds.writeto(out.fn, primheader=primhdr)</span>

<span class="sd">        For FITS output, out.fits is a fitsio.FITS object.  The file</span>
<span class="sd">        contents will actually be written in memory, and then a</span>
<span class="sd">        sha256sum computed before the file contents are written out to</span>
<span class="sd">        the real disk file.  The &#39;out.fn&#39; member variable is NOT set.</span>

<span class="sd">        with survey.write_fits_output(&#39;ccds&#39;, brick=brickname) as out:</span>
<span class="sd">            ccds.writeto(None, fits_object=out.fits, primheader=primhdr)</span>

<span class="sd">        Does the following on entry:</span>
<span class="sd">        - calls self.find_file() to determine which filename to write to</span>
<span class="sd">        - ensures the output directory exists</span>
<span class="sd">        - appends a &quot;.tmp&quot; to the filename</span>

<span class="sd">        Does the following on exit:</span>
<span class="sd">        - moves the &quot;.tmp&quot; to the final filename (to make it atomic)</span>
<span class="sd">        - computes the sha256sum</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">class</span> <span class="nc">OutputFileContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">survey</span><span class="p">,</span> <span class="n">hashsum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">relative_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">compression</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                *compression*: a CFITSIO compression specification, eg:</span>
<span class="sd">                    &quot;[compress R 100,100; qz -0.05]&quot;</span>
<span class="sd">                &#39;&#39;&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">real_fn</span> <span class="o">=</span> <span class="n">fn</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">relative_fn</span> <span class="o">=</span> <span class="n">relative_fn</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">survey</span> <span class="o">=</span> <span class="n">survey</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_fits</span> <span class="o">=</span> <span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">)</span> <span class="ow">or</span>
                                <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fits.gz&#39;</span><span class="p">)</span> <span class="ow">or</span>
                                <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fits.fz&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tmpfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fn</span><span class="p">),</span>
                                          <span class="s1">&#39;tmp-&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fits</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fits</span> <span class="o">=</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">FITS</span><span class="p">(</span><span class="s1">&#39;mem://&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">compression</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                            <span class="s1">&#39;rw&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpfn</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hashsum</span> <span class="o">=</span> <span class="n">hashsum</span>

            <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">dirnm</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpfn</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirnm</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirnm</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">return</span> <span class="bp">self</span>

            <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
                <span class="c1"># If an exception was thrown, bail out</span>
                <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashsum</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">hashlib</span>
                    <span class="n">hashfunc</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span>
                    <span class="n">sha</span> <span class="o">=</span> <span class="n">hashfunc</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fits</span><span class="p">:</span>
                    <span class="c1"># Read back the data written into memory by the</span>
                    <span class="c1"># fitsio library</span>
                    <span class="n">rawdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">read_raw</span><span class="p">()</span>
                    <span class="c1"># close the fitsio file</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="c1"># If gzip, we now have to actually do the</span>
                    <span class="c1"># compression to gzip format...</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpfn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.gz&#39;</span><span class="p">):</span>
                        <span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">BytesIO</span>
                        <span class="kn">import</span> <span class="nn">gzip</span>
                        <span class="c1">#ulength = len(rawdata)</span>
                        <span class="c1"># We gzip to a memory file (BytesIO) so we can compute</span>
                        <span class="c1"># the hashcode before writing to disk for real</span>
                        <span class="n">gzipped</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
                        <span class="n">gzf</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">real_fn</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">gzipped</span><span class="p">)</span>
                        <span class="n">gzf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rawdata</span><span class="p">)</span>
                        <span class="n">gzf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">rawdata</span> <span class="o">=</span> <span class="n">gzipped</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
                        <span class="n">gzipped</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">del</span> <span class="n">gzipped</span>
                        <span class="c1">#clength = len(rawdata)</span>
                        <span class="c1">#print(&#39;Gzipped&#39;, ulength, &#39;to&#39;, clength)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashsum</span><span class="p">:</span>
                        <span class="n">sha</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rawdata</span><span class="p">)</span>

                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpfn</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rawdata</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrote&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpfn</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">rawdata</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpfn</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashsum</span><span class="p">:</span>
                        <span class="n">sha</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashsum</span><span class="p">:</span>
                    <span class="n">hashcode</span> <span class="o">=</span> <span class="n">sha</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
                    <span class="k">del</span> <span class="n">sha</span>

                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpfn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_fn</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Renamed to&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_fn</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashsum</span><span class="p">:</span>
                    <span class="c1"># List the relative filename (from output dir) in</span>
                    <span class="c1"># shasum file.</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_fn</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_fn</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">add_hashcode</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">hashcode</span><span class="p">)</span>
            <span class="c1"># end of OutputFileContext class</span>


        <span class="c1"># Get the output filename for this filetype</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_file</span><span class="p">(</span><span class="n">filetype</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">compress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compression_string</span><span class="p">(</span><span class="n">filetype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Find the relative path (relative to output_dir), which is the string</span>
        <span class="c1"># we will put in the shasum file.</span>
        <span class="n">relfn</span> <span class="o">=</span> <span class="n">fn</span>
        <span class="k">if</span> <span class="n">relfn</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">relfn</span> <span class="o">=</span> <span class="n">relfn</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">):]</span>
            <span class="k">if</span> <span class="n">relfn</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                <span class="n">relfn</span> <span class="o">=</span> <span class="n">relfn</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">OutputFileContext</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">hashsum</span><span class="o">=</span><span class="n">hashsum</span><span class="p">,</span> <span class="n">relative_fn</span><span class="o">=</span><span class="n">relfn</span><span class="p">,</span>
                                <span class="n">compression</span><span class="o">=</span><span class="n">compress</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">add_hashcode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">hashcode</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Callback to be called in the *write_output* routine.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_file_hashes</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span> <span class="o">=</span> <span class="n">hashcode</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        For pickling: clear the cached ZP and other tables.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;ccds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;bricks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;bricktree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">drop_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Clears all cached data contained in this object.  Useful for</span>
<span class="sd">        pickling / multiprocessing.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bricks</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bricktree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">astrometry.libkd.spherematch</span> <span class="k">import</span> <span class="n">tree_free</span>
            <span class="n">tree_free</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bricktree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bricktree</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_calib_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the directory containing calibration data.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survey_dir</span><span class="p">,</span> <span class="s1">&#39;calib&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_image_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the directory containing image data.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survey_dir</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_survey_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the base LEGACY_SURVEY_DIR directory.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">survey_dir</span>

    <span class="k">def</span> <span class="nf">get_se_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the directory containing SourceExtractor config files,</span>
<span class="sd">        used during calibration.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="k">import</span> <span class="n">resource_filename</span>
        <span class="k">return</span> <span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;legacypipe&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_bricks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a table of bricks.  The caller owns the table.</span>

<span class="sd">        For read-only purposes, see *get_bricks_readonly()*, which</span>
<span class="sd">        uses a cached version.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">fits_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">find_file</span><span class="p">(</span><span class="s1">&#39;bricks&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_bricks_readonly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a read-only (shared) copy of the table of bricks.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bricks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bricks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bricks</span><span class="p">()</span>
            <span class="c1"># Assert that bricks are the sizes we think they are.</span>
            <span class="c1"># ... except for the two poles, which are half-sized</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">bricks</span><span class="o">.</span><span class="n">dec2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bricks</span><span class="o">.</span><span class="n">dec1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">bricksize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bricks</span>

    <span class="k">def</span> <span class="nf">get_brick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">brickid</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a brick (as one row in a table) by *brickid* (integer).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bricks_readonly</span><span class="p">()</span>
        <span class="n">I</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">brickid</span> <span class="o">==</span> <span class="n">brickid</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">B</span><span class="p">[</span><span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">get_brick_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">brickname</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a brick (as one row in a table) by name (string).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bricks_readonly</span><span class="p">()</span>
        <span class="n">I</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">n</span> <span class="o">==</span> <span class="n">brickname</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">B</span><span class="o">.</span><span class="n">brickname</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">B</span><span class="p">[</span><span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">bricks_touching_radec_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bricks</span><span class="p">,</span>
                                  <span class="n">ralo</span><span class="p">,</span> <span class="n">rahi</span><span class="p">,</span> <span class="n">declo</span><span class="p">,</span> <span class="n">dechi</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns an index vector of the bricks that touch the given RA,Dec box.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">bricks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bricks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bricks_readonly</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_tree</span> <span class="ow">and</span> <span class="n">bricks</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bricks</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">astrometry.libkd.spherematch</span> <span class="k">import</span> <span class="n">tree_build_radec</span><span class="p">,</span> <span class="n">tree_search_radec</span>
            <span class="c1"># Use kdtree</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bricktree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bricktree</span> <span class="o">=</span> <span class="n">tree_build_radec</span><span class="p">(</span><span class="n">bricks</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">bricks</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>
            <span class="c1"># brick size</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bricksize</span>
            <span class="c1"># + RA,Dec box size</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">+</span> <span class="n">degrees_between</span><span class="p">(</span><span class="n">ralo</span><span class="p">,</span> <span class="n">declo</span><span class="p">,</span> <span class="n">rahi</span><span class="p">,</span> <span class="n">dechi</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="p">(</span><span class="n">dechi</span> <span class="o">+</span> <span class="n">declo</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">rahi</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ralo</span><span class="p">)))</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">rahi</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ralo</span><span class="p">)))</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">ra</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
            <span class="n">J</span> <span class="o">=</span> <span class="n">tree_search_radec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bricktree</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
            <span class="n">I</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">((</span><span class="n">bricks</span><span class="o">.</span><span class="n">ra1</span><span class="p">[</span><span class="n">J</span><span class="p">]</span>  <span class="o">&lt;=</span> <span class="n">rahi</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bricks</span><span class="o">.</span><span class="n">ra2</span><span class="p">[</span><span class="n">J</span><span class="p">]</span>  <span class="o">&gt;=</span> <span class="n">ralo</span><span class="p">)</span> <span class="o">*</span>
                             <span class="p">(</span><span class="n">bricks</span><span class="o">.</span><span class="n">dec1</span><span class="p">[</span><span class="n">J</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dechi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bricks</span><span class="o">.</span><span class="n">dec2</span><span class="p">[</span><span class="n">J</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">declo</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">return</span> <span class="n">I</span>

        <span class="k">if</span> <span class="n">rahi</span> <span class="o">&lt;</span> <span class="n">ralo</span><span class="p">:</span>
            <span class="c1"># Wrap-around</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;In Dec slice:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">((</span><span class="n">bricks</span><span class="o">.</span><span class="n">dec1</span> <span class="o">&lt;=</span> <span class="n">dechi</span><span class="p">)</span> <span class="o">*</span>
                                                      <span class="p">(</span><span class="n">bricks</span><span class="o">.</span><span class="n">dec2</span> <span class="o">&gt;=</span> <span class="n">declo</span><span class="p">))))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Above RAlo=&#39;</span><span class="p">,</span> <span class="n">ralo</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">bricks</span><span class="o">.</span><span class="n">ra2</span> <span class="o">&gt;=</span> <span class="n">ralo</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Below RAhi=&#39;</span><span class="p">,</span> <span class="n">rahi</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">bricks</span><span class="o">.</span><span class="n">ra1</span> <span class="o">&lt;=</span> <span class="n">rahi</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;In RA slice:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">bricks</span><span class="o">.</span><span class="n">ra2</span> <span class="o">&gt;=</span> <span class="n">ralo</span><span class="p">,</span>
                                                               <span class="n">bricks</span><span class="o">.</span><span class="n">ra1</span> <span class="o">&lt;=</span> <span class="n">rahi</span><span class="p">))))</span>

            <span class="n">I</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">bricks</span><span class="o">.</span><span class="n">ra2</span> <span class="o">&gt;=</span> <span class="n">ralo</span><span class="p">,</span> <span class="n">bricks</span><span class="o">.</span><span class="n">ra1</span> <span class="o">&lt;=</span> <span class="n">rahi</span><span class="p">)</span> <span class="o">*</span>
                            <span class="p">(</span><span class="n">bricks</span><span class="o">.</span><span class="n">dec1</span> <span class="o">&lt;=</span> <span class="n">dechi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bricks</span><span class="o">.</span><span class="n">dec2</span> <span class="o">&gt;=</span> <span class="n">declo</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;In RA&amp;Dec slice&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">I</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">((</span><span class="n">bricks</span><span class="o">.</span><span class="n">ra1</span>  <span class="o">&lt;=</span> <span class="n">rahi</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bricks</span><span class="o">.</span><span class="n">ra2</span>  <span class="o">&gt;=</span> <span class="n">ralo</span><span class="p">)</span> <span class="o">*</span>
                            <span class="p">(</span><span class="n">bricks</span><span class="o">.</span><span class="n">dec1</span> <span class="o">&lt;=</span> <span class="n">dechi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bricks</span><span class="o">.</span><span class="n">dec2</span> <span class="o">&gt;=</span> <span class="n">declo</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">I</span>

    <span class="k">def</span> <span class="nf">get_ccds_readonly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a shared copy of the table of CCDs.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ccds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ccds</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccds</span>

    <span class="k">def</span> <span class="nf">filter_ccds_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fns</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        When reading the list of CCDs, we find all files named</span>
<span class="sd">        survey-ccds-*.fits.gz, then filter that list using this function.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">fns</span>

    <span class="k">def</span> <span class="nf">filter_ccd_kd_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fns</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fns</span>

    <span class="k">def</span> <span class="nf">get_ccds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the table of CCDs.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">fns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_file</span><span class="p">(</span><span class="s1">&#39;ccd-kds&#39;</span><span class="p">)</span>
        <span class="n">fns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_ccd_kd_files</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span>
        <span class="c1"># If &#39;ccd-kds&#39; files exist, read the CCDs tables from them!</span>
        <span class="c1"># Otherwise, fall back to survey-ccds-*.fits.gz files.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_file</span><span class="p">(</span><span class="s1">&#39;ccds&#39;</span><span class="p">)</span>
            <span class="n">fns</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">fns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_ccds_files</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span>

        <span class="n">TT</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading CCDs from&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
            <span class="c1"># cols = (</span>
            <span class="c1">#     &#39;exptime filter propid crpix1 crpix2 crval1 crval2 &#39; +</span>
            <span class="c1">#     &#39;cd1_1 cd1_2 cd2_1 cd2_2 ccdname ccdzpt ccdraoff ccddecoff &#39; +</span>
            <span class="c1">#     &#39;ccdnmatch camera image_hdu image_filename width height &#39; +</span>
            <span class="c1">#     &#39;ra dec zpt expnum fwhm mjd_obs&#39;).split()</span>
            <span class="c1">#T = fits_table(fn, columns=cols)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">fits_table</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Got&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="s1">&#39;CCDs&#39;</span><span class="p">)</span>
            <span class="n">TT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">merge_tables</span><span class="p">(</span><span class="n">TT</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;fillzero&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total of&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="s1">&#39;CCDs&#39;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">TT</span>

        <span class="n">cols</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">columns</span><span class="p">()</span>
        <span class="c1"># Make DR1 CCDs table somewhat compatible with DR2</span>
        <span class="k">if</span> <span class="s1">&#39;extname&#39;</span> <span class="ow">in</span> <span class="n">cols</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;ccdname&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">T</span><span class="o">.</span><span class="n">ccdname</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">extname</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;camera&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">T</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;decam&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;cpimage&#39;</span> <span class="ow">in</span> <span class="n">cols</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;image_filename&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">T</span><span class="o">.</span><span class="n">image_filename</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">cpimage</span>
        <span class="k">if</span> <span class="s1">&#39;cpimage_hdu&#39;</span> <span class="ow">in</span> <span class="n">cols</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;image_hdu&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">T</span><span class="o">.</span><span class="n">image_hdu</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">cpimage_hdu</span>

        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_ccds_table</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">T</span>

    <span class="k">def</span> <span class="nf">get_annotated_ccds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the annotated table of CCDs.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">fns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_file</span><span class="p">(</span><span class="s1">&#39;annotated-ccds&#39;</span><span class="p">)</span>
        <span class="n">TT</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading annotated CCDs from&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">fits_table</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Got&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="s1">&#39;CCDs&#39;</span><span class="p">)</span>
            <span class="n">TT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">merge_tables</span><span class="p">(</span><span class="n">TT</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;fillzero&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total of&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="s1">&#39;CCDs&#39;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">TT</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_ccds_table</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">T</span>

    <span class="k">def</span> <span class="nf">cleanup_ccds_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ccds</span><span class="p">):</span>
        <span class="c1"># Remove trailing spaces from &#39;ccdname&#39; column</span>
        <span class="k">if</span> <span class="s1">&#39;ccdname&#39;</span> <span class="ow">in</span> <span class="n">ccds</span><span class="o">.</span><span class="n">columns</span><span class="p">():</span>
            <span class="c1"># &quot;N4 &quot; -&gt; &quot;N4&quot;</span>
            <span class="n">ccds</span><span class="o">.</span><span class="n">ccdname</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ccds</span><span class="o">.</span><span class="n">ccdname</span><span class="p">])</span>
        <span class="c1"># Remove trailing spaces from &#39;camera&#39; column.</span>
        <span class="n">ccds</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ccds</span><span class="o">.</span><span class="n">camera</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ccds</span>

    <span class="k">def</span> <span class="nf">ccds_touching_wcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wcs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a table of the CCDs touching the given *wcs* region.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">fns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_file</span><span class="p">(</span><span class="s1">&#39;ccd-kds&#39;</span><span class="p">)</span>
        <span class="n">fns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_ccd_kd_files</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fns</span><span class="p">):</span>
            <span class="c1"># Assume that if &gt;= 1 survey-ccds-*.kd.fits files exist,</span>
            <span class="c1"># then we should read all CCDs from there rather than</span>
            <span class="c1"># survey-ccds-*.fits.gz.</span>
            <span class="c1"># This file was created via:</span>
            <span class="c1"># python&gt;&gt; from legacypipe.survey import *</span>
            <span class="c1"># &gt;&gt; survey=LegacySurveyData(survey_dir=&#39;/global/cscratch1/sd/desiproc/dr5&#39;)</span>
            <span class="c1"># &gt;&gt; ccds = survey.get_ccds()</span>
            <span class="c1"># &gt;&gt; ccds.writeto(&#39;/tmp/ccds-dr5.fits&#39;)</span>
            <span class="c1"># Astrometry.net&#39;s &#39;startree&#39; program:</span>
            <span class="c1"># &gt; startree -i /tmp/ccds-dr5.fits -o /tmp/dr5.kd -P -k -n ccds</span>
            <span class="c1"># &gt; fitsgetext -i /tmp/dr5.kd -o /tmp/survey-ccds-dr5.kd.fits -e 0 -e 6 -e 1 -e 2 -e 3 -e 4 -e 5</span>
            <span class="kn">from</span> <span class="nn">astrometry.libkd.spherematch</span> <span class="k">import</span> <span class="n">tree_open</span><span class="p">,</span> <span class="n">tree_search_radec</span>

            <span class="c1"># MAGIC number: we&#39;ll search a 1-degree radius for CCDs</span>
            <span class="c1"># roughly in range, then refine using the</span>
            <span class="c1"># ccds_touching_wcs() function.</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">1.</span>

            <span class="n">ra</span><span class="p">,</span><span class="n">dec</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">radec_center</span><span class="p">()</span>
            <span class="n">TT</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Searching&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
                <span class="n">kd</span> <span class="o">=</span> <span class="n">tree_open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;ccds&#39;</span><span class="p">)</span>
                <span class="n">I</span> <span class="o">=</span> <span class="n">tree_search_radec</span><span class="p">(</span><span class="n">kd</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">),</span> <span class="s1">&#39;CCDs within&#39;</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="s1">&#39;deg of RA,Dec (</span><span class="si">%.3f</span><span class="s1">, </span><span class="si">%.3f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># Read only the CCD-table rows within range.</span>
                <span class="n">TT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits_table</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">I</span><span class="p">))</span>
            <span class="n">ccds</span> <span class="o">=</span> <span class="n">merge_tables</span><span class="p">(</span><span class="n">TT</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;fillzero&#39;</span><span class="p">)</span>
            <span class="n">ccds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_ccds_table</span><span class="p">(</span><span class="n">ccds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ccds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ccds_readonly</span><span class="p">()</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">ccds_touching_wcs</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">ccds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">ccds</span><span class="p">[</span><span class="n">I</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_image_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a DecamImage or similar object for one row of the CCDs table.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># get Image subclass</span>
        <span class="n">imageType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_class_for_camera</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">camera</span><span class="p">)</span>
        <span class="c1"># call Image subclass constructor</span>
        <span class="k">return</span> <span class="n">imageType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_approx_wcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ccd</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">astrometry.util.util</span> <span class="k">import</span> <span class="n">Tan</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">width</span><span class="p">,</span><span class="n">ccd</span><span class="o">.</span><span class="n">height</span>
        <span class="n">wcs</span> <span class="o">=</span> <span class="n">Tan</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                    <span class="p">[</span><span class="n">ccd</span><span class="o">.</span><span class="n">crval1</span><span class="p">,</span> <span class="n">ccd</span><span class="o">.</span><span class="n">crval2</span><span class="p">,</span> <span class="n">ccd</span><span class="o">.</span><span class="n">crpix1</span><span class="p">,</span> <span class="n">ccd</span><span class="o">.</span><span class="n">crpix2</span><span class="p">,</span>
                     <span class="n">ccd</span><span class="o">.</span><span class="n">cd1_1</span><span class="p">,</span>  <span class="n">ccd</span><span class="o">.</span><span class="n">cd1_2</span><span class="p">,</span>  <span class="n">ccd</span><span class="o">.</span><span class="n">cd2_1</span><span class="p">,</span> <span class="n">ccd</span><span class="o">.</span><span class="n">cd2_2</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">wcs</span>

    <span class="k">def</span> <span class="nf">tims_touching_wcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetwcs</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Creates tractor.Image objects for CCDs touching the given</span>
<span class="sd">        *targetwcs* region.</span>

<span class="sd">        mp: multiprocessing object</span>

<span class="sd">        kwargs are passed to LegacySurveyImage.get_tractor_image() and</span>
<span class="sd">        may include:</span>

<span class="sd">        * gaussPsf</span>
<span class="sd">        * pixPsf</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Read images</span>
        <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccds_touching_wcs</span><span class="p">(</span><span class="n">targetwcs</span><span class="p">)</span>
        <span class="c1"># Sort by band</span>
        <span class="k">if</span> <span class="n">bands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">C</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">filter</span> <span class="o">==</span> <span class="n">band</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">]))</span>
        <span class="n">ims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">C</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image file&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">image_filename</span><span class="p">,</span> <span class="s1">&#39;hdu&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">image_hdu</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">DecamImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="n">ims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="c1"># Read images, clip to ROI</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">targetwcs</span><span class="o">.</span><span class="n">get_width</span><span class="p">(),</span> <span class="n">targetwcs</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
        <span class="n">targetrd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">targetwcs</span><span class="o">.</span><span class="n">pixelxy2radec</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span>
                             <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="n">W</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="n">W</span><span class="p">,</span><span class="n">H</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="n">H</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]])</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[(</span><span class="n">im</span><span class="p">,</span> <span class="n">targetrd</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">ims</span><span class="p">]</span>
        <span class="n">tims</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">read_one_tim</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tims</span>

    <span class="k">def</span> <span class="nf">find_ccds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ccdname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">camera</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a table of CCDs matching the given *expnum* (exposure</span>
<span class="sd">        number, integer), *ccdname* (string), and *camera* (string),</span>
<span class="sd">        if given.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ccds_readonly</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">expnum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">expnum</span> <span class="o">==</span> <span class="n">expnum</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ccdname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">ccdname</span> <span class="o">==</span> <span class="n">ccdname</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">camera</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">camera</span> <span class="o">==</span> <span class="n">camera</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">T</span>

    <span class="k">def</span> <span class="nf">photometric_ccds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ccds</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns an index array for the members of the table &quot;ccds&quot; that</span>
<span class="sd">        are photometric.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Make the is-photometric check camera-specific, handled by the</span>
        <span class="c1"># Image subclass.</span>
        <span class="n">cameras</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ccds</span><span class="o">.</span><span class="n">camera</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finding photometric CCDs.  Cameras:&#39;</span><span class="p">,</span> <span class="n">cameras</span><span class="p">)</span>
        <span class="n">good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ccds</span><span class="p">),</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cam</span> <span class="ow">in</span> <span class="n">cameras</span><span class="p">:</span>
            <span class="n">imclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_class_for_camera</span><span class="p">(</span><span class="n">cam</span><span class="p">)</span>
            <span class="n">Icam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">ccds</span><span class="o">.</span><span class="n">camera</span> <span class="o">==</span> <span class="n">cam</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Icam</span><span class="p">),</span> <span class="s1">&#39;images from camera&#39;</span><span class="p">,</span> <span class="n">cam</span><span class="p">)</span>
            <span class="n">Igood</span> <span class="o">=</span> <span class="n">imclass</span><span class="o">.</span><span class="n">photometric_ccds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ccds</span><span class="p">[</span><span class="n">Icam</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">Igood</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No photometric cut for camera&#39;</span><span class="p">,</span> <span class="n">cam</span><span class="p">)</span>
                <span class="n">good</span><span class="p">[</span><span class="n">Icam</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Keeping&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Igood</span><span class="p">),</span> <span class="s1">&#39;photometric CCDs from camera&#39;</span><span class="p">,</span> <span class="n">cam</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Igood</span><span class="p">):</span>
                <span class="n">good</span><span class="p">[</span><span class="n">Icam</span><span class="p">[</span><span class="n">Igood</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">good</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ccd_cuts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ccds</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a bitmask of reasons the given *ccds* would be cut</span>
<span class="sd">        (excluded from legacypipe processing).  These bits are defined</span>
<span class="sd">        in LegacySurveyData.ccd_cut_bits.</span>

<span class="sd">        This just delegates to the LegacySurveyImage subclasses based</span>
<span class="sd">        on camera.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cameras</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ccds</span><span class="o">.</span><span class="n">camera</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Computing CCD cuts.  Cameras:&#39;</span><span class="p">,</span> <span class="n">cameras</span><span class="p">)</span>
        <span class="n">ccdcuts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ccds</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cam</span> <span class="ow">in</span> <span class="n">cameras</span><span class="p">:</span>
            <span class="n">imclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_class_for_camera</span><span class="p">(</span><span class="n">cam</span><span class="p">)</span>
            <span class="n">Icam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">ccds</span><span class="o">.</span><span class="n">camera</span> <span class="o">==</span> <span class="n">cam</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Icam</span><span class="p">),</span> <span class="s1">&#39;images from camera&#39;</span><span class="p">,</span> <span class="n">cam</span><span class="p">)</span>
            <span class="n">cuts</span> <span class="o">=</span> <span class="n">imclass</span><span class="o">.</span><span class="n">ccd_cuts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ccds</span><span class="p">[</span><span class="n">Icam</span><span class="p">])</span>
            <span class="n">ccdcuts</span><span class="p">[</span><span class="n">Icam</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuts</span>
            <span class="c1">#print(&#39;Keeping&#39;, sum(cuts==0), &#39;unflagged CCDs from camera&#39;, cam)</span>
        <span class="k">return</span> <span class="n">ccdcuts</span>

<span class="k">def</span> <span class="nf">exposure_metadata</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">hdus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Creates a CCD table row object by reading metadata from a FITS</span>
<span class="sd">    file header.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filenames : list of strings</span>
<span class="sd">        Filenames to read</span>
<span class="sd">    hdus : list of integers; None to read all HDUs</span>
<span class="sd">        List of FITS extensions (HDUs) to read</span>
<span class="sd">    trim : string</span>
<span class="sd">        String to trim off the start of the *filenames* for the</span>
<span class="sd">        *image_filename* table entry</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A table that looks like the CCDs table.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">astrometry.util.util</span> <span class="k">import</span> <span class="n">Tan</span>
    <span class="kn">from</span> <span class="nn">astrometry.util.starutil_numpy</span> <span class="k">import</span> <span class="n">hmsstring2ra</span><span class="p">,</span> <span class="n">dmsstring2dec</span>

    <span class="n">nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">primkeys</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;FILTER&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="n">nan</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;DEC&#39;</span><span class="p">,</span> <span class="n">nan</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;AIRMASS&#39;</span><span class="p">,</span> <span class="n">nan</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">,</span> <span class="n">nan</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;EXPNUM&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;PROPID&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;INSTRUME&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;SEEING&#39;</span><span class="p">,</span> <span class="n">nan</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">hdrkeys</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;AVSKY&#39;</span><span class="p">,</span> <span class="n">nan</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">&#39;ARAWGAIN&#39;</span><span class="p">,</span> <span class="n">nan</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">&#39;FWHM&#39;</span><span class="p">,</span> <span class="n">nan</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">,</span><span class="n">nan</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">,</span><span class="n">nan</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">,</span><span class="n">nan</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">,</span><span class="n">nan</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">&#39;CD1_1&#39;</span><span class="p">,</span><span class="n">nan</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">&#39;CD1_2&#39;</span><span class="p">,</span><span class="n">nan</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">&#39;CD2_1&#39;</span><span class="p">,</span><span class="n">nan</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">&#39;CD2_2&#39;</span><span class="p">,</span><span class="n">nan</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">&#39;EXTNAME&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">&#39;CCDNUM&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
               <span class="p">]</span>

    <span class="n">otherkeys</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;IMAGE_FILENAME&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMAGE_HDU&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;HEIGHT&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="s1">&#39;WIDTH&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                 <span class="p">]</span>

    <span class="n">allkeys</span> <span class="o">=</span> <span class="n">primkeys</span> <span class="o">+</span> <span class="n">hdrkeys</span> <span class="o">+</span> <span class="n">otherkeys</span>

    <span class="n">vals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,[])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">allkeys</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">fn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">FITS</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">primhdr</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">read_header</span><span class="p">()</span>
        <span class="n">expstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%08i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">primhdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;EXPNUM&#39;</span><span class="p">)</span>

        <span class="n">cpfn</span> <span class="o">=</span> <span class="n">fn</span>
        <span class="k">if</span> <span class="n">trim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cpfn</span> <span class="o">=</span> <span class="n">cpfn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">trim</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CP fn&#39;</span><span class="p">,</span> <span class="n">cpfn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hdus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hdulist</span> <span class="o">=</span> <span class="n">hdus</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdulist</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">F</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">hdulist</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">read_header</span><span class="p">()</span>

            <span class="n">info</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">get_info</span><span class="p">()</span>
            <span class="c1">#&#39;extname&#39;: &#39;S1&#39;, &#39;dims&#39;: [4146L, 2160L]</span>
            <span class="n">H</span><span class="p">,</span><span class="n">W</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">primkeys</span><span class="p">:</span>
                <span class="n">vals</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">primhdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">hdrkeys</span><span class="p">:</span>
                <span class="n">vals</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>

            <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;IMAGE_FILENAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cpfn</span><span class="p">)</span>
            <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;IMAGE_HDU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>
            <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;WIDTH&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">W</span><span class="p">))</span>
            <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;HEIGHT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">H</span><span class="p">))</span>

    <span class="n">T</span> <span class="o">=</span> <span class="n">fits_table</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">allkeys</span><span class="p">:</span>
        <span class="n">T</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="c1">#T.about()</span>

    <span class="c1"># DECam: INSTRUME = &#39;DECam&#39;</span>
    <span class="n">T</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;instrume&#39;</span><span class="p">,</span> <span class="s1">&#39;camera&#39;</span><span class="p">)</span>
    <span class="n">T</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">camera</span><span class="p">])</span>
    <span class="c1">#T.rename(&#39;extname&#39;, &#39;ccdname&#39;)</span>
    <span class="n">T</span><span class="o">.</span><span class="n">ccdname</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">extname</span><span class="p">])</span>

    <span class="n">T</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">filter</span><span class="p">])</span>
    <span class="n">T</span><span class="o">.</span><span class="n">ra_bore</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">hmsstring2ra</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">ra</span> <span class="p">])</span>
    <span class="n">T</span><span class="o">.</span><span class="n">dec_bore</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dmsstring2dec</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">dec</span><span class="p">])</span>

    <span class="n">T</span><span class="o">.</span><span class="n">ra</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
    <span class="n">T</span><span class="o">.</span><span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">)):</span>
        <span class="n">W</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">width</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">T</span><span class="o">.</span><span class="n">height</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">wcs</span> <span class="o">=</span> <span class="n">Tan</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">crval1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">T</span><span class="o">.</span><span class="n">crval2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">T</span><span class="o">.</span><span class="n">crpix1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">T</span><span class="o">.</span><span class="n">crpix2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                  <span class="n">T</span><span class="o">.</span><span class="n">cd1_1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">T</span><span class="o">.</span><span class="n">cd1_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">T</span><span class="o">.</span><span class="n">cd2_1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">T</span><span class="o">.</span><span class="n">cd2_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">W</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">H</span><span class="p">))</span>
        <span class="n">xc</span><span class="p">,</span><span class="n">yc</span> <span class="o">=</span> <span class="n">W</span><span class="o">/</span><span class="mf">2.</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">H</span><span class="o">/</span><span class="mf">2.</span><span class="o">+</span><span class="mf">0.5</span>
        <span class="n">rc</span><span class="p">,</span><span class="n">dc</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">pixelxy2radec</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span>
        <span class="n">T</span><span class="o">.</span><span class="n">ra</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rc</span>
        <span class="n">T</span><span class="o">.</span><span class="n">dec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span>

    <span class="k">return</span> <span class="n">T</span>

<span class="k">def</span> <span class="nf">run_calibs</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">noraise</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;noraise&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;run_calibs for image&#39;</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">im</span><span class="o">.</span><span class="n">run_calibs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exception in run_calibs:&#39;</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">traceback</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">noraise</span><span class="p">:</span>
            <span class="k">raise</span>

<span class="k">def</span> <span class="nf">read_one_tim</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">targetrd</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="o">=</span> <span class="n">X</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading&#39;</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>
    <span class="n">tim</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">get_tractor_image</span><span class="p">(</span><span class="n">radecpoly</span><span class="o">=</span><span class="n">targetrd</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tim</span>

<span class="kn">from</span> <span class="nn">tractor.psfex</span> <span class="k">import</span> <span class="n">PsfExModel</span>

<span class="k">class</span> <span class="nc">SchlegelPsfModel</span><span class="p">(</span><span class="n">PsfExModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        `ext` is ignored.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">astrometry.util.fits</span> <span class="k">import</span> <span class="n">fits_table</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">fits_table</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">T</span><span class="o">.</span><span class="n">about</span><span class="p">()</span>

            <span class="n">ims</span> <span class="o">=</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Eigen-images&#39;</span><span class="p">,</span> <span class="n">ims</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">nsch</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">ims</span><span class="o">.</span><span class="n">shape</span>

            <span class="n">hdr</span> <span class="o">=</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">read_header</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">xscale</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;XSCALE&#39;</span><span class="p">]</span>
            <span class="n">yscale</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;YSCALE&#39;</span><span class="p">]</span>
            <span class="n">degree</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">xexp</span> <span class="o">+</span> <span class="n">T</span><span class="o">.</span><span class="n">yexp</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span> <span class="o">=</span> <span class="mf">1.</span>

            <span class="c1"># Reorder the &#39;ims&#39; to match the way PsfEx sorts its polynomial terms</span>

            <span class="c1"># number of terms in polynomial</span>
            <span class="n">ne</span> <span class="o">=</span> <span class="p">(</span><span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">degree</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of eigen-PSFs required for degree=&#39;</span><span class="p">,</span> <span class="n">degree</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">psfbases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ne</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># x polynomial degree = j</span>
                <span class="c1"># y polynomial degree = k</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="n">j</span>
                    <span class="n">ii</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="p">(</span><span class="n">degree</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span> <span class="o">-</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span> <span class="mi">2</span>

                    <span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">((</span><span class="n">T</span><span class="o">.</span><span class="n">xexp</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">yexp</span> <span class="o">==</span> <span class="n">k</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Schlegel image for power&#39;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;not found&#39;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">ims</span><span class="p">[</span><span class="n">jj</span><span class="p">,:,:]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Schlegel image for power&#39;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;has range&#39;</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">im</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">psfbases</span><span class="p">[</span><span class="n">ii</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">ims</span><span class="p">[</span><span class="n">jj</span><span class="p">,:,:]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">xscale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yscale</span> <span class="o">=</span> <span class="n">xscale</span><span class="p">,</span> <span class="n">yscale</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="n">x0</span><span class="p">,</span><span class="n">y0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="n">degree</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SchlegelPsfEx degree:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>
            <span class="n">bh</span><span class="p">,</span><span class="n">bw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psfbases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="n">bh</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>

</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2014-2018, Kaylan Burleigh, John Moustakas.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6.<br/>
    </p>
  </div>
</footer>
  </body>
</html>