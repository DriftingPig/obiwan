<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>legacypipe.image &#8212; obiwan 1.2.0 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          Obiwan</a>
        <span class="navbar-text navbar-version pull-left"><b>1.2.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../api.html">API</a></li>
                <li><a href="../../tutorials.html">Tutorials</a></li>
                <li><a href="../../deeplearning.html">Deep Learning</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Pages <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">This Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for legacypipe.image</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">fitsio</span>
<span class="kn">from</span> <span class="nn">tractor.utils</span> <span class="k">import</span> <span class="n">get_class_from_name</span>
<span class="kn">from</span> <span class="nn">tractor.basics</span> <span class="k">import</span> <span class="n">NanoMaggies</span><span class="p">,</span> <span class="n">ConstantFitsWcs</span><span class="p">,</span> <span class="n">LinearPhotoCal</span>
<span class="kn">from</span> <span class="nn">tractor.image</span> <span class="k">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">tractor.sky</span> <span class="k">import</span> <span class="n">ConstantSky</span>
<span class="kn">from</span> <span class="nn">tractor.tractortime</span> <span class="k">import</span> <span class="n">TAITime</span>
<span class="kn">from</span> <span class="nn">astrometry.util.file</span> <span class="k">import</span> <span class="n">trymakedirs</span>
<span class="kn">from</span> <span class="nn">astrometry.util.fits</span> <span class="k">import</span> <span class="n">fits_table</span>
<span class="kn">from</span> <span class="nn">legacypipe.survey</span> <span class="k">import</span> <span class="n">SimpleGalaxy</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Generic image handling code.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">astrometry.util.plotutils</span> <span class="k">import</span> <span class="n">PlotSequence</span>
<span class="n">psgalnorm</span> <span class="o">=</span> <span class="n">PlotSequence</span><span class="p">(</span><span class="s1">&#39;norms&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LegacySurveyImage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A base class containing common code for the images we handle.</span>

<span class="sd">    You probably shouldn&#39;t need to directly instantiate this class,</span>
<span class="sd">    but rather use the recipe described in the __init__ method.</span>

<span class="sd">    Objects of this class represent the metadata we have on an image,</span>
<span class="sd">    and are used to handle some of the details of going from an entry</span>
<span class="sd">    in the CCDs table to a tractor Image object.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">survey</span><span class="p">,</span> <span class="n">ccd</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create a new LegacySurveyImage object, from a LegacySurveyData object,</span>
<span class="sd">        and one row of a CCDs fits_table object.</span>

<span class="sd">        You may not need to instantiate this class directly, instead using</span>
<span class="sd">        survey.get_image_object():</span>

<span class="sd">            survey = LegacySurveyData()</span>
<span class="sd">            # targetwcs = ....</span>
<span class="sd">            # ccds = survey.ccds_touching_wcs(targetwcs, ccdrad=None)</span>
<span class="sd">            ccds = survey.get_ccds()</span>
<span class="sd">            im = survey.get_image_object(ccds[0])</span>
<span class="sd">            # which does the same thing as:</span>
<span class="sd">            im = DecamImage(survey, ccds[0])</span>

<span class="sd">        Or, if you have a Community Pipeline-processed input file and</span>
<span class="sd">        FITS HDU extension number:</span>

<span class="sd">            survey = LegacySurveyData()</span>
<span class="sd">            ccds = exposure_metadata([filename], hdus=[hdu])</span>
<span class="sd">            im = DecamImage(survey, ccds[0])</span>

<span class="sd">        Perhaps the most important method in this class is</span>
<span class="sd">        *get_tractor_image*.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">survey</span> <span class="o">=</span> <span class="n">survey</span>

        <span class="n">imgfn</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">image_filename</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">imgfn</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imgfn</span> <span class="o">=</span> <span class="n">imgfn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imgfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">get_image_dir</span><span class="p">(),</span> <span class="n">imgfn</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span>     <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">image_hdu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expnum</span>  <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">expnum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccdname</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">ccdname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">band</span>    <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exptime</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">exptime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera</span>  <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Photometric and astrometric zeropoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccdzpt</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">ccdzpt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dradec</span> <span class="o">=</span> <span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">ccdraoff</span> <span class="o">/</span> <span class="mf">3600.</span><span class="p">,</span> <span class="n">ccd</span><span class="o">.</span><span class="n">ccddecoff</span> <span class="o">/</span> <span class="mf">3600.</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span>    <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">fwhm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propid</span>  <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">propid</span>
        <span class="c1"># in arcsec/pixel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixscale</span> <span class="o">=</span> <span class="mf">3600.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">cd1_1</span> <span class="o">*</span> <span class="n">ccd</span><span class="o">.</span><span class="n">cd2_2</span> <span class="o">-</span>
                                               <span class="n">ccd</span><span class="o">.</span><span class="n">cd1_2</span> <span class="o">*</span> <span class="n">ccd</span><span class="o">.</span><span class="n">cd2_1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mjdobs</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">mjd_obs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span>  <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">height</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">LegacySurveyImage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">photometric_ccds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">survey</span><span class="p">,</span> <span class="n">ccds</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns an index array for the members of the table &#39;ccds&#39; that are</span>
<span class="sd">        photometric.</span>

<span class="sd">        Default is to return None, meaning keep all CCDs.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">ccd_cuts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">survey</span><span class="p">,</span> <span class="n">ccds</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ccds</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_for_cached_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">survey</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cacheable_filename_variables</span><span class="p">():</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">cfn</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">check_cache</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking for cached&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cfn</span> <span class="o">!=</span> <span class="n">fn</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_cacheable_filename_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        These are names of self.X variables that are filenames that</span>
<span class="sd">        could be cached.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;imgfn&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_good_image_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">get_extent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        extent = None or extent = [x0,x1,y0,y1]</span>

<span class="sd">        If *get_extent* = True, returns the new [x0,x1,y0,y1] extent.</span>

<span class="sd">        Returns a new pair of slices, or *extent* if the whole image is good.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">gx0</span><span class="p">,</span><span class="n">gx1</span><span class="p">,</span><span class="n">gy0</span><span class="p">,</span><span class="n">gy1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_good_image_subregion</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gx0</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">gx1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">gy0</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">gy1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">extent</span>
        <span class="k">if</span> <span class="n">extent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">imh</span><span class="p">,</span><span class="n">imw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image_shape</span><span class="p">()</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">imw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imh</span><span class="p">)</span>
        <span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span> <span class="o">=</span> <span class="n">extent</span>
        <span class="k">if</span> <span class="n">gx0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">gx0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gy0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">gy0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gx1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">gx1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gy1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">gy1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">get_extent</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_good_image_subregion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns x0,x1,y0,y1 of the good region of this chip,</span>
<span class="sd">        or None if no cut should be applied to that edge; returns</span>
<span class="sd">        (None,None,None,None) if the whole chip is good.</span>

<span class="sd">        This cut is applied in addition to any masking in the mask or</span>
<span class="sd">        invvar map.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_tractor_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">radecpoly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">gaussPsf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pixPsf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hybridPsf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">splinesky</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">nanomaggies</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subsky</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tiny</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                          <span class="n">dq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">invvar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pixels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">constant_invvar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a tractor.Image (&quot;tim&quot;) object for this image.</span>
<span class="sd">        </span>
<span class="sd">        Options describing a subimage to return:</span>

<span class="sd">        - *slc*: y,x slice objects</span>
<span class="sd">        - *radecpoly*: numpy array, shape (N,2), RA,Dec polygon describing</span>
<span class="sd">            bounding box to select.</span>

<span class="sd">        Options determining the PSF model to use:</span>

<span class="sd">        - *gaussPsf*: single circular Gaussian PSF based on header FWHM value.</span>
<span class="sd">        - *pixPsf*: pixelized PsfEx model.</span>
<span class="sd">        - *hybridPsf*: combo pixelized PsfEx + Gaussian approx.</span>

<span class="sd">        Options determining the sky model to use:</span>
<span class="sd">        </span>
<span class="sd">        - *splinesky*: median filter chunks of the image, then spline those.</span>

<span class="sd">        Options determining the units of the image:</span>

<span class="sd">        - *nanomaggies*: convert the image to be in units of NanoMaggies;</span>
<span class="sd">          *tim.zpscale* contains the scale value the image was divided by.</span>

<span class="sd">        - *subsky*: instantiate and subtract the initial sky model,</span>
<span class="sd">          leaving a constant zero sky model?</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">get_dq</span> <span class="o">=</span> <span class="n">dq</span>
        <span class="n">get_invvar</span> <span class="o">=</span> <span class="n">invvar</span>

        <span class="n">band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span>
        <span class="n">wcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wcs</span><span class="p">()</span>

        <span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">slc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image_extent</span><span class="p">(</span><span class="n">wcs</span><span class="o">=</span><span class="n">wcs</span><span class="p">,</span> <span class="n">slc</span><span class="o">=</span><span class="n">slc</span><span class="p">,</span> <span class="n">radecpoly</span><span class="o">=</span><span class="n">radecpoly</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span> <span class="o">&lt;</span> <span class="n">tiny</span> <span class="ow">or</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span> <span class="o">&lt;</span> <span class="n">tiny</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping tiny subimage&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Read image pixels</span>
        <span class="k">if</span> <span class="n">pixels</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading image slice:&#39;</span><span class="p">,</span> <span class="n">slc</span><span class="p">)</span>
            <span class="n">img</span><span class="p">,</span><span class="n">imghdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_image</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="n">slc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_image_header</span><span class="p">(</span><span class="n">imghdr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">y1</span><span class="o">-</span><span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">imghdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_image_header</span><span class="p">()</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">img</span><span class="p">)))</span>
            
        <span class="c1"># Read inverse-variance (weight) map</span>
        <span class="k">if</span> <span class="n">get_invvar</span><span class="p">:</span>
            <span class="n">invvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_invvar</span><span class="p">(</span><span class="nb">slice</span><span class="o">=</span><span class="n">slc</span><span class="p">,</span> <span class="n">clipThresh</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">invvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">invvar</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">invvar</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping zero-invvar image&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Negative invvars (from, eg, fpack decompression noise) cause havoc</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">invvar</span> <span class="o">&gt;=</span> <span class="mf">0.</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not np.all(invvar &gt;= 0.), hdu=</span><span class="si">%d</span><span class="s1"> fn=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">wtfn</span><span class="p">))</span>

        <span class="c1"># Read data-quality (flags) map and zero out the invvars of masked pixels</span>
        <span class="k">if</span> <span class="n">get_dq</span><span class="p">:</span>
            <span class="n">dq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dq</span><span class="p">(</span><span class="nb">slice</span><span class="o">=</span><span class="n">slc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">invvar</span><span class="p">[</span><span class="n">dq</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">invvar</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping zero-invvar image (after DQ masking)&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># header &#39;FWHM&#39; is in pixels</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">psf_fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> 
        <span class="n">psf_sigma</span> <span class="o">=</span> <span class="n">psf_fwhm</span> <span class="o">/</span> <span class="mf">2.35</span>
        <span class="n">primhdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_image_primary_header</span><span class="p">()</span>

        <span class="c1">#</span>
        <span class="n">invvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remap_invvar</span><span class="p">(</span><span class="n">invvar</span><span class="p">,</span> <span class="n">primhdr</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">dq</span><span class="p">)</span>


        <span class="n">sky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_sky_model</span><span class="p">(</span><span class="n">splinesky</span><span class="o">=</span><span class="n">splinesky</span><span class="p">,</span> <span class="n">slc</span><span class="o">=</span><span class="n">slc</span><span class="p">,</span>
                                  <span class="n">primhdr</span><span class="o">=</span><span class="n">primhdr</span><span class="p">,</span> <span class="n">imghdr</span><span class="o">=</span><span class="n">imghdr</span><span class="p">)</span>
        <span class="n">skysig1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sky</span><span class="p">,</span> <span class="s1">&#39;sig1&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
        <span class="n">midsky</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="n">subsky</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Instantiating and subtracting sky model&#39;</span><span class="p">)</span>
            <span class="n">skymod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">sky</span><span class="o">.</span><span class="n">addTo</span><span class="p">(</span><span class="n">skymod</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">-=</span> <span class="n">skymod</span>
            <span class="n">midsky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">skymod</span><span class="p">)</span>
            <span class="n">zsky</span> <span class="o">=</span> <span class="n">ConstantSky</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
            <span class="n">zsky</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sky</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">zsky</span><span class="o">.</span><span class="n">plver</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sky</span><span class="p">,</span> <span class="s1">&#39;plver&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">skymod</span>
            <span class="n">sky</span> <span class="o">=</span> <span class="n">zsky</span>
            <span class="k">del</span> <span class="n">zsky</span>

        <span class="n">orig_zpscale</span> <span class="o">=</span> <span class="n">zpscale</span> <span class="o">=</span> <span class="n">NanoMaggies</span><span class="o">.</span><span class="n">zeropointToScale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ccdzpt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nanomaggies</span><span class="p">:</span>
            <span class="c1"># Scale images to Nanomaggies</span>
            <span class="n">img</span> <span class="o">/=</span> <span class="n">zpscale</span>
            <span class="n">invvar</span> <span class="o">=</span> <span class="n">invvar</span> <span class="o">*</span> <span class="n">zpscale</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">subsky</span><span class="p">:</span>
                <span class="n">sky</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">zpscale</span><span class="p">)</span>
            <span class="n">zpscale</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="c1"># Compute &#39;sig1&#39;, scalar typical per-pixel noise</span>
        <span class="k">if</span> <span class="n">get_invvar</span><span class="p">:</span>
            <span class="n">sig1</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">invvar</span><span class="p">[</span><span class="n">invvar</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">skysig1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sig1</span> <span class="o">=</span> <span class="n">skysig1</span>
            <span class="k">if</span> <span class="n">nanomaggies</span><span class="p">:</span>
                <span class="c1"># skysig1 is in the native units</span>
                <span class="n">sig1</span> <span class="o">/=</span> <span class="n">orig_zpscale</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Estimate per-pixel noise via Blanton&#39;s 5-pixel MAD</span>
            <span class="n">slice1</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
            <span class="n">slice2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="nb">slice</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
            <span class="n">mad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">slice1</span><span class="p">]</span> <span class="o">-</span> <span class="n">img</span><span class="p">[</span><span class="n">slice2</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">sig1</span> <span class="o">=</span> <span class="mf">1.4826</span> <span class="o">*</span> <span class="n">mad</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sig1 estimate:&#39;</span><span class="p">,</span> <span class="n">sig1</span><span class="p">)</span>
            <span class="n">invvar</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">sig1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sig1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">constant_invvar</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting constant invvar&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">sig1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">invvar</span><span class="p">[</span><span class="n">invvar</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">sig1</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">if</span> <span class="n">subsky</span><span class="p">:</span>
            <span class="c1"># Warn if the subtracted sky doesn&#39;t seem to work well</span>
            <span class="c1"># (can happen, eg, if sky calibration product is inconsistent with</span>
            <span class="c1">#  the data)</span>
            <span class="n">imgmed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">invvar</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imgmed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sig1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: image median&#39;</span><span class="p">,</span> <span class="n">imgmed</span><span class="p">,</span> <span class="s1">&#39;is more than 1 sigma&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;away from zero!&#39;</span><span class="p">)</span>

        <span class="c1"># tractor WCS object</span>
        <span class="n">twcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tractor_wcs</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">primhdr</span><span class="o">=</span><span class="n">primhdr</span><span class="p">,</span> <span class="n">imghdr</span><span class="o">=</span><span class="n">imghdr</span><span class="p">)</span>
                                    
        <span class="n">psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_psf_model</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">gaussPsf</span><span class="o">=</span><span class="n">gaussPsf</span><span class="p">,</span> <span class="n">pixPsf</span><span class="o">=</span><span class="n">pixPsf</span><span class="p">,</span>
                                  <span class="n">hybridPsf</span><span class="o">=</span><span class="n">hybridPsf</span><span class="p">,</span>
                                  <span class="n">psf_sigma</span><span class="o">=</span><span class="n">psf_sigma</span><span class="p">,</span>
                                  <span class="n">w</span><span class="o">=</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span>

        <span class="n">tim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">invvar</span><span class="o">=</span><span class="n">invvar</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">twcs</span><span class="p">,</span> <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="p">,</span>
                    <span class="n">photocal</span><span class="o">=</span><span class="n">LinearPhotoCal</span><span class="p">(</span><span class="n">zpscale</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">),</span>
                    <span class="n">sky</span><span class="o">=</span><span class="n">sky</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">band</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">getInvError</span><span class="p">())))</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">band</span>

        <span class="c1"># HACK -- create a local PSF model to instantiate the PsfEx</span>
        <span class="c1"># model, which handles non-unit pixel scaling.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-- creating constant PSF model for norms...&#39;</span><span class="p">)</span>
        <span class="n">fullpsf</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">psf</span>
        <span class="n">th</span><span class="p">,</span><span class="n">tw</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">psf</span> <span class="o">=</span> <span class="n">fullpsf</span><span class="o">.</span><span class="n">constantPsfAt</span><span class="p">(</span><span class="n">tw</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">th</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">psfnorm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_norm</span><span class="p">(</span><span class="n">tim</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PSF norm:&#39;</span><span class="p">,</span> <span class="n">tim</span><span class="o">.</span><span class="n">psfnorm</span><span class="p">)</span>
        <span class="c1"># Galaxy-detection norm</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">galnorm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galaxy_norm</span><span class="p">(</span><span class="n">tim</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Galaxy norm&#39;</span><span class="p">,</span> <span class="n">tim</span><span class="o">.</span><span class="n">galnorm</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">galnorm</span> <span class="o">&lt;</span> <span class="n">tim</span><span class="o">.</span><span class="n">psfnorm</span><span class="p">)</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">psf</span> <span class="o">=</span> <span class="n">fullpsf</span>

        <span class="c1"># CP (DECam) images include DATE-OBS and MJD-OBS, in UTC.</span>
        <span class="kn">import</span> <span class="nn">astropy.time</span>
        <span class="n">mjd_tai</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mjdobs</span><span class="p">,</span>
                                    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tai</span><span class="o">.</span><span class="n">mjd</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">TAITime</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">mjd_tai</span><span class="p">)</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">slice</span> <span class="o">=</span> <span class="n">slc</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">zpscale</span> <span class="o">=</span> <span class="n">orig_zpscale</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">midsky</span> <span class="o">=</span> <span class="n">midsky</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">sig1</span> <span class="o">=</span> <span class="n">sig1</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">psf_fwhm</span> <span class="o">=</span> <span class="n">psf_fwhm</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">psf_sigma</span> <span class="o">=</span> <span class="n">psf_sigma</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">propid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propid</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">sip_wcs</span> <span class="o">=</span> <span class="n">wcs</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span><span class="n">tim</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x0</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">y0</span><span class="p">)</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">imobj</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">primhdr</span> <span class="o">=</span> <span class="n">primhdr</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">imghdr</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">plver</span> <span class="o">=</span> <span class="n">primhdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PLVER&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">skyver</span> <span class="o">=</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">sky</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sky</span><span class="p">,</span> <span class="s1">&#39;plver&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">wcsver</span> <span class="o">=</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="s1">&#39;plver&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">psfver</span> <span class="o">=</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="s1">&#39;plver&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">get_dq</span><span class="p">:</span>
            <span class="n">tim</span><span class="o">.</span><span class="n">dq</span> <span class="o">=</span> <span class="n">dq</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">dq_saturation_bits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dq_saturation_bits</span>
        <span class="n">subh</span><span class="p">,</span><span class="n">subw</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">tim</span><span class="o">.</span><span class="n">subwcs</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">sip_wcs</span><span class="o">.</span><span class="n">get_subimage</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">tim</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">subw</span><span class="p">,</span> <span class="n">subh</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tim</span>

    <span class="k">def</span> <span class="nf">get_image_extent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">slc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">radecpoly</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns x0,x1,y0,y1,slc</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#slc = None</span>
        <span class="n">imh</span><span class="p">,</span><span class="n">imw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image_shape</span><span class="p">()</span>
        <span class="n">x0</span><span class="p">,</span><span class="n">y0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">imw</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">imh</span>

        <span class="c1"># Clip to RA,Dec polygon?</span>
        <span class="k">if</span> <span class="n">slc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">radecpoly</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">astrometry.util.miscutils</span> <span class="k">import</span> <span class="n">clip_polygon</span>
            <span class="n">imgpoly</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="n">imh</span><span class="p">),(</span><span class="n">imw</span><span class="p">,</span><span class="n">imh</span><span class="p">),(</span><span class="n">imw</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">ok</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="n">ty</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">radec2pixelxy</span><span class="p">(</span><span class="n">radecpoly</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">radecpoly</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">tpoly</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span><span class="n">ty</span><span class="p">))</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="n">clip_polygon</span><span class="p">(</span><span class="n">imgpoly</span><span class="p">,</span> <span class="n">tpoly</span><span class="p">)</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clip</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clip</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span>
            <span class="n">x0</span><span class="p">,</span><span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">clip</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">x1</span><span class="p">,</span><span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span> <span class="p">(</span><span class="n">clip</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">slc</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Slice?</span>
        <span class="k">if</span> <span class="n">slc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sy</span><span class="p">,</span><span class="n">sx</span> <span class="o">=</span> <span class="n">slc</span>
            <span class="n">y0</span><span class="p">,</span><span class="n">y1</span> <span class="o">=</span> <span class="n">sy</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">sy</span><span class="o">.</span><span class="n">stop</span>
            <span class="n">x0</span><span class="p">,</span><span class="n">x1</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">sx</span><span class="o">.</span><span class="n">stop</span>

        <span class="c1"># Is part of this image bad?</span>
        <span class="n">old_extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span><span class="p">)</span>
        <span class="n">new_extent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_good_image_slice</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span><span class="p">),</span> <span class="n">get_extent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_extent</span> <span class="o">!=</span> <span class="n">old_extent</span><span class="p">:</span>
            <span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span> <span class="o">=</span> <span class="n">new_extent</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Applying good subregion of CCD: slice is&#39;</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x0</span> <span class="o">&gt;=</span> <span class="n">x1</span> <span class="ow">or</span> <span class="n">y0</span> <span class="o">&gt;=</span> <span class="n">y1</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span>
            <span class="n">slc</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">slc</span>

    <span class="k">def</span> <span class="nf">remap_invvar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invvar</span><span class="p">,</span> <span class="n">primhdr</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">dq</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">invvar</span>

    <span class="k">def</span> <span class="nf">check_image_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imghdr</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">psf_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tim</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># PSF norm</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">psf</span>
        <span class="n">h</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">w</span><span class="o">/</span><span class="mf">2.</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">h</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">getPointSourcePatch</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">patch</span>
        <span class="c1"># Clamp up to zero and normalize before taking the norm</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">patch</span><span class="p">)</span>
        <span class="n">patch</span> <span class="o">/=</span> <span class="n">patch</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">psfnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">patch</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">psfnorm</span>

    <span class="k">def</span> <span class="nf">galaxy_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tim</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Galaxy-detection norm</span>
        <span class="kn">from</span> <span class="nn">tractor.galaxy</span> <span class="k">import</span> <span class="n">ExpGalaxy</span>
        <span class="kn">from</span> <span class="nn">tractor.ellipses</span> <span class="k">import</span> <span class="n">EllipseE</span>
        <span class="kn">from</span> <span class="nn">tractor.patch</span> <span class="k">import</span> <span class="n">ModelMask</span>
        <span class="n">h</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">band</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">w</span><span class="o">//</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">h</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">pixelToPosition</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">gal</span> <span class="o">=</span> <span class="n">SimpleGalaxy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">NanoMaggies</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">band</span><span class="p">:</span><span class="mf">1.</span><span class="p">}))</span>
        <span class="n">S</span> <span class="o">=</span> <span class="mi">32</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="n">ModelMask</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">S</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">S</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="n">S</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">S</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">galmod</span> <span class="o">=</span> <span class="n">gal</span><span class="o">.</span><span class="n">getModelPatch</span><span class="p">(</span><span class="n">tim</span><span class="p">,</span> <span class="n">modelMask</span><span class="o">=</span><span class="n">mm</span><span class="p">)</span><span class="o">.</span><span class="n">patch</span>
        <span class="n">galmod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">galmod</span><span class="p">)</span>
        <span class="n">galmod</span> <span class="o">/=</span> <span class="n">galmod</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">galnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">galmod</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">galnorm</span>
    
    <span class="k">def</span> <span class="nf">_read_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">hdu</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">FITS</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="n">hdu</span><span class="p">]</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="nb">slice</span><span class="p">]</span>
            <span class="n">rtn</span> <span class="o">=</span> <span class="n">img</span>
            <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_header</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">hdr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">img</span>
        <span class="k">return</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">hdu</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reads the image file from disk.</span>

<span class="sd">        The image is read from FITS file self.imgfn HDU self.hdu.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        slice : slice, optional</span>
<span class="sd">            2-dimensional slice of the subimage to read.</span>
<span class="sd">        header : boolean, optional</span>
<span class="sd">            Return the image header also, as tuple (image, header) ?</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        image : numpy array</span>
<span class="sd">            The image pixels.</span>
<span class="sd">        (image, header) : (numpy array, fitsio header)</span>
<span class="sd">            If `header = True`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading image from&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgfn</span><span class="p">,</span> <span class="s1">&#39;hdu&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_fits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_image_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns image shape H,W.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the full shape of the image, (H,W).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image_shape</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">read_image_primary_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reads the FITS primary (HDU 0) header from self.imgfn.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        primary_header : fitsio header</span>
<span class="sd">            The FITS header</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_primary_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_primary_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reads the FITS primary header (HDU 0) from the given filename.</span>
<span class="sd">        This is just a faster version of fitsio.read_header(fn).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.gz&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">read_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span>

        <span class="c1"># Weirdly, this can be MUCH faster than letting fitsio do it...</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">FITSHDR</span><span class="p">()</span>
        <span class="n">foundEnd</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">+</span> <span class="n">ff</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">32768</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">h</span><span class="p">[:</span><span class="mi">80</span><span class="p">]</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="mi">80</span><span class="p">:]</span>
                <span class="c1">#print(&#39;Header line &quot;%s&quot;&#39; % line)</span>
                <span class="c1"># HACK -- fitsio apparently can&#39;t handle CONTINUE.</span>
                <span class="c1"># It also has issues with slightly malformed cards, like</span>
                <span class="c1"># KEYWORD  =      / no value</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;CONTINUE&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: failed to parse FITS header line: &#39;</span> <span class="o">+</span>
                              <span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;; skipped&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
                        <span class="kn">import</span> <span class="nn">traceback</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                              
                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;END&#39;</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="mi">77</span><span class="p">):</span>
                    <span class="n">foundEnd</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">foundEnd</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">hdr</span>

    <span class="k">def</span> <span class="nf">read_image_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reads the FITS image header from self.imgfn HDU self.hdu.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        header : fitsio header</span>
<span class="sd">            The FITS header</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">read_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfn</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_dq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reads the Data Quality (DQ) mask image.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">read_invvar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reads the inverse-variance (weight) map image.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_tractor_wcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wcs</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span>
                        <span class="n">primhdr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imghdr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">twcs</span> <span class="o">=</span> <span class="n">ConstantFitsWcs</span><span class="p">(</span><span class="n">wcs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x0</span> <span class="ow">or</span> <span class="n">y0</span><span class="p">:</span>
            <span class="n">twcs</span><span class="o">.</span><span class="n">setX0Y0</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">twcs</span>

    <span class="k">def</span> <span class="nf">get_wcs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1">### Yuck, this is not much better than just doing read_sky_model().sig1 ...</span>
    <span class="k">def</span> <span class="nf">get_sky_sig1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">splinesky</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the per-pixel noise estimate, which (for historical</span>
<span class="sd">        reasons) is stored in the sky model.  NOTE that this is in</span>
<span class="sd">        image pixel counts, NOT calibrated nanomaggies.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">splinesky</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;merged_splineskyfn&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merged_splineskyfn</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Merged spline sky model does not exist:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">merged_splineskyfn</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">splinesky</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;merged_splineskyfn&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merged_splineskyfn</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading merged spline sky models from&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">merged_splineskyfn</span><span class="p">)</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">fits_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merged_splineskyfn</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;sig1&#39;</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">get_columns</span><span class="p">():</span>
                    <span class="n">I</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">((</span><span class="n">T</span><span class="o">.</span><span class="n">expnum</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">expnum</span><span class="p">)</span> <span class="o">*</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccdname</span>
                                              <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">ccdname</span><span class="p">]))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">),</span> <span class="s1">&#39;matching CCD&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">sig1</span><span class="p">[</span><span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">splinesky</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splineskyfn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyfn</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading sky model from&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">read_header</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">sig1</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SIG1&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sig1</span>

    <span class="k">def</span> <span class="nf">read_sky_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">splinesky</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">slc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reads the sky model, returning a Tractor Sky object.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sky</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">splinesky</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;merged_splineskyfn&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merged_splineskyfn</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Merged spline sky model does not exist:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">merged_splineskyfn</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">splinesky</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;merged_splineskyfn&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merged_splineskyfn</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading merged spline sky models from&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">merged_splineskyfn</span><span class="p">)</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">fits_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merged_splineskyfn</span><span class="p">)</span>
                <span class="n">I</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">((</span><span class="n">T</span><span class="o">.</span><span class="n">expnum</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">expnum</span><span class="p">)</span> <span class="o">*</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccdname</span>
                                          <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">ccdname</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">),</span> <span class="s1">&#39;matching CCD&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">Ti</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="c1"># Ti.about()</span>
                    <span class="c1"># print(&#39;Spline w,h&#39;, Ti.gridw, Ti.gridh)</span>
                    <span class="c1"># print(&#39;xgrid:&#39;, Ti.xgrid.shape)</span>
                    <span class="c1"># print(&#39;ygrid:&#39;, Ti.ygrid.shape)</span>
                    <span class="c1"># print(&#39;gridvals:&#39;, Ti.gridvals.shape)</span>

                    <span class="c1"># Remove any padding</span>
                    <span class="n">h</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">Ti</span><span class="o">.</span><span class="n">gridh</span><span class="p">,</span> <span class="n">Ti</span><span class="o">.</span><span class="n">gridw</span>
                    <span class="n">Ti</span><span class="o">.</span><span class="n">gridvals</span> <span class="o">=</span> <span class="n">Ti</span><span class="o">.</span><span class="n">gridvals</span><span class="p">[:</span><span class="n">h</span><span class="p">,</span> <span class="p">:</span><span class="n">w</span><span class="p">]</span>
                    <span class="n">Ti</span><span class="o">.</span><span class="n">xgrid</span> <span class="o">=</span> <span class="n">Ti</span><span class="o">.</span><span class="n">xgrid</span><span class="p">[:</span><span class="n">w</span><span class="p">]</span>
                    <span class="n">Ti</span><span class="o">.</span><span class="n">ygrid</span> <span class="o">=</span> <span class="n">Ti</span><span class="o">.</span><span class="n">ygrid</span><span class="p">[:</span><span class="n">h</span><span class="p">]</span>

                    <span class="n">skyclass</span> <span class="o">=</span> <span class="n">Ti</span><span class="o">.</span><span class="n">skyclass</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">clazz</span> <span class="o">=</span> <span class="n">get_class_from_name</span><span class="p">(</span><span class="n">skyclass</span><span class="p">)</span>
                    <span class="n">fromfits</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s1">&#39;from_fits_row&#39;</span><span class="p">)</span>
                    <span class="n">sky</span> <span class="o">=</span> <span class="n">fromfits</span><span class="p">(</span><span class="n">Ti</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">slc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">sy</span><span class="p">,</span><span class="n">sx</span> <span class="o">=</span> <span class="n">slc</span>
                        <span class="n">x0</span><span class="p">,</span><span class="n">y0</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">start</span><span class="p">,</span><span class="n">sy</span><span class="o">.</span><span class="n">start</span>
                        <span class="n">sky</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>
                    <span class="n">sky</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">Ti</span><span class="o">.</span><span class="n">legpipev</span>
                    <span class="n">sky</span><span class="o">.</span><span class="n">plver</span> <span class="o">=</span> <span class="n">Ti</span><span class="o">.</span><span class="n">plver</span>
                    <span class="k">if</span> <span class="s1">&#39;sig1&#39;</span> <span class="ow">in</span> <span class="n">Ti</span><span class="o">.</span><span class="n">get_columns</span><span class="p">():</span>
                        <span class="n">sky</span><span class="o">.</span><span class="n">sig1</span> <span class="o">=</span> <span class="n">Ti</span><span class="o">.</span><span class="n">sig1</span>
                    <span class="k">return</span> <span class="n">sky</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">traceback</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyfn</span>
        <span class="k">if</span> <span class="n">splinesky</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splineskyfn</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading sky model from&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">read_header</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">skyclass</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;SKY&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;SKY not in header: skyfn=</span><span class="si">%s</span><span class="s1">, imgfn=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfn</span><span class="p">))</span>
        <span class="n">clazz</span> <span class="o">=</span> <span class="n">get_class_from_name</span><span class="p">(</span><span class="n">skyclass</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s1">&#39;from_fits&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fromfits</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s1">&#39;from_fits&#39;</span><span class="p">)</span>
            <span class="n">sky</span> <span class="o">=</span> <span class="n">fromfits</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">hdr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fromfits</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s1">&#39;fromFitsHeader&#39;</span><span class="p">)</span>
            <span class="n">sky</span> <span class="o">=</span> <span class="n">fromfits</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;SKY_&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">slc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sy</span><span class="p">,</span><span class="n">sx</span> <span class="o">=</span> <span class="n">slc</span>
            <span class="n">x0</span><span class="p">,</span><span class="n">y0</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">start</span><span class="p">,</span><span class="n">sy</span><span class="o">.</span><span class="n">start</span>
            <span class="n">sky</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>

        <span class="n">sky</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LEGPIPEV&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sky</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sky</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TRACTORV&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sky</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sky</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span>
        <span class="n">sky</span><span class="o">.</span><span class="n">plver</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PLVER&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">sig1</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SIG1&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sig1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sky</span><span class="o">.</span><span class="n">sig1</span> <span class="o">=</span> <span class="n">sig1</span>
        <span class="k">return</span> <span class="n">sky</span>

    <span class="k">def</span> <span class="nf">read_psf_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span>
                       <span class="n">gaussPsf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pixPsf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hybridPsf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">psf_sigma</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">gaussPsf</span> <span class="ow">or</span> <span class="n">pixPsf</span> <span class="ow">or</span> <span class="n">hybridPsf</span><span class="p">)</span>
        <span class="n">psffn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">gaussPsf</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">tractor</span> <span class="k">import</span> <span class="n">GaussianMixturePSF</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">psf_sigma</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">psf</span> <span class="o">=</span> <span class="n">GaussianMixturePSF</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: using mock PSF:&#39;</span><span class="p">,</span> <span class="n">psf</span><span class="p">)</span>
            <span class="n">psf</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
            <span class="n">psf</span><span class="o">.</span><span class="n">plver</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">return</span> <span class="n">psf</span>

        <span class="c1"># spatially varying pixelized PsfEx</span>
        <span class="kn">from</span> <span class="nn">tractor</span> <span class="k">import</span> <span class="n">PixelizedPsfEx</span><span class="p">,</span> <span class="n">PsfExModel</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;merged_psffn&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merged_psffn</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Merged PsfEx model does not exist:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">merged_psffn</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;merged_psffn&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merged_psffn</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading merged PsfEx models from&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">merged_psffn</span><span class="p">)</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">fits_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merged_psffn</span><span class="p">)</span>
                <span class="n">I</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">((</span><span class="n">T</span><span class="o">.</span><span class="n">expnum</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">expnum</span><span class="p">)</span> <span class="o">*</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccdname</span>
                                          <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">ccdname</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">),</span> <span class="s1">&#39;matching CCD&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">Ti</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

                    <span class="c1"># Remove any padding</span>
                    <span class="n">degree</span> <span class="o">=</span> <span class="n">Ti</span><span class="o">.</span><span class="n">poldeg1</span>
                    <span class="c1"># number of terms in polynomial</span>
                    <span class="n">ne</span> <span class="o">=</span> <span class="p">(</span><span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">degree</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="c1">#print(&#39;PSF_mask shape&#39;, Ti.psf_mask.shape)</span>
                    <span class="n">Ti</span><span class="o">.</span><span class="n">psf_mask</span> <span class="o">=</span> <span class="n">Ti</span><span class="o">.</span><span class="n">psf_mask</span><span class="p">[:</span><span class="n">ne</span><span class="p">,</span> <span class="p">:</span><span class="n">Ti</span><span class="o">.</span><span class="n">psfaxis1</span><span class="p">,</span> <span class="p">:</span><span class="n">Ti</span><span class="o">.</span><span class="n">psfaxis2</span><span class="p">]</span>

                    <span class="n">psfex</span> <span class="o">=</span> <span class="n">PsfExModel</span><span class="p">(</span><span class="n">Ti</span><span class="o">=</span><span class="n">Ti</span><span class="p">)</span>
                    <span class="n">psf</span> <span class="o">=</span> <span class="n">PixelizedPsfEx</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">psfex</span><span class="o">=</span><span class="n">psfex</span><span class="p">)</span>
                    <span class="n">psf</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">Ti</span><span class="o">.</span><span class="n">legpipev</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">psf</span><span class="o">.</span><span class="n">plver</span> <span class="o">=</span> <span class="n">Ti</span><span class="o">.</span><span class="n">plver</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">traceback</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">psf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading PsfEx model from&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psffn</span><span class="p">)</span>
            <span class="n">psf</span> <span class="o">=</span> <span class="n">PixelizedPsfEx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psffn</span><span class="p">)</span>

            <span class="n">hdr</span> <span class="o">=</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">read_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psffn</span><span class="p">)</span>
            <span class="n">psf</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LEGSURV&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">psf</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">psf</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psffn</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span>
            <span class="n">psf</span><span class="o">.</span><span class="n">plver</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PLVER&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">psf</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hybridPsf</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">tractor.psf</span> <span class="k">import</span> <span class="n">HybridPixelizedPSF</span>
            <span class="n">psf</span> <span class="o">=</span> <span class="n">HybridPixelizedPSF</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">cx</span><span class="o">=</span><span class="n">w</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">cy</span><span class="o">=</span><span class="n">h</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using PSF model&#39;</span><span class="p">,</span> <span class="n">psf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">psf</span>

    <span class="k">def</span> <span class="nf">run_calibs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Runs any required calibration processes for this image.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;run_calibs for&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(not implemented)&#39;</span><span class="p">)</span>
        <span class="k">pass</span>

<span class="k">class</span> <span class="nc">CalibMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A class to hold common calibration tasks between the different</span>
<span class="sd">    surveys / image subclasses.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CalibMixin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">check_psf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psffn</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns True if the PsfEx file is ok.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Sometimes SourceExtractor gets interrupted or something and</span>
        <span class="c1"># writes out 0 detections.  Then PsfEx fails but in a way that</span>
        <span class="c1"># an output file is still written.  Try to detect &amp; fix this</span>
        <span class="c1"># case.</span>
        <span class="c1"># Check the PsfEx output file for POLNAME1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">read_header</span><span class="p">(</span><span class="n">psffn</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to read header from existing PSF model file&#39;</span><span class="p">,</span> <span class="n">psffn</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;POLNAME1&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Did not find POLNAME1 in PsfEx header&#39;</span><span class="p">,</span><span class="n">psffn</span><span class="p">,</span><span class="s1">&#39;-- deleting&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">psffn</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">check_se_cat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">astrometry.util.fits</span> <span class="k">import</span> <span class="n">fits_table</span>
        <span class="kn">from</span> <span class="nn">astrometry.util.file</span> <span class="k">import</span> <span class="n">file_size</span>
        <span class="c1"># Check SourceExtractor catalog for file size = 0 or FITS table</span>
        <span class="c1"># length = 0</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">and</span> <span class="n">file_size</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">fits_table</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">hdu</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Read&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="s1">&#39;sources from SE catalog&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">T</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SourceExtractor catalog&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;has no sources -- deleting&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">funpack_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgfn</span><span class="p">,</span> <span class="n">maskfn</span><span class="p">,</span> <span class="n">hdu</span><span class="p">,</span> <span class="n">todelete</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">legacypipe.survey</span> <span class="k">import</span> <span class="n">create_temp</span>

        <span class="n">tmpimgfn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tmpmaskfn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># For FITS files that are not actually fpack&#39;ed, funpack -E</span>
        <span class="c1"># fails.  Check whether actually fpacked.</span>
        <span class="n">fcopy</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">read_header</span><span class="p">(</span><span class="n">imgfn</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">hdu</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;BINTABLE&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ZIMAGE&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image </span><span class="si">%s</span><span class="s1">, HDU </span><span class="si">%i</span><span class="s1"> is not fpacked; just imcopying.&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">imgfn</span><span class="p">,</span>  <span class="n">hdu</span><span class="p">))</span>
            <span class="n">fcopy</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">tmpimgfn</span>  <span class="o">=</span> <span class="n">create_temp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
        <span class="n">tmpmaskfn</span> <span class="o">=</span> <span class="n">create_temp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
        <span class="n">todelete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpimgfn</span><span class="p">)</span>
        <span class="n">todelete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpmaskfn</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fcopy</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;imcopy </span><span class="si">%s</span><span class="s1">&quot;+</span><span class="si">%i</span><span class="s1">&quot; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imgfn</span><span class="p">,</span> <span class="n">hdu</span><span class="p">,</span> <span class="n">tmpimgfn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;funpack -E </span><span class="si">%i</span><span class="s1"> -O </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hdu</span><span class="p">,</span> <span class="n">tmpimgfn</span><span class="p">,</span> <span class="n">imgfn</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Command failed: &#39;</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fcopy</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;imcopy </span><span class="si">%s</span><span class="s1">&quot;+</span><span class="si">%i</span><span class="s1">&quot; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maskfn</span><span class="p">,</span> <span class="n">hdu</span><span class="p">,</span> <span class="n">tmpmaskfn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;funpack -E </span><span class="si">%i</span><span class="s1"> -O </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hdu</span><span class="p">,</span> <span class="n">tmpmaskfn</span><span class="p">,</span> <span class="n">maskfn</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Command failed: &#39;</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="n">M</span><span class="p">,</span><span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_fits</span><span class="p">(</span><span class="n">maskfn</span><span class="p">,</span> <span class="n">hdu</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Read&#39;</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">fitsio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tmpmaskfn</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">hdr</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrote&#39;</span><span class="p">,</span> <span class="n">tmpmaskfn</span><span class="p">,</span> <span class="s1">&#39;with fitsio&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tmpimgfn</span><span class="p">,</span><span class="n">tmpmaskfn</span>

    <span class="k">def</span> <span class="nf">run_se</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surveyname</span><span class="p">,</span> <span class="n">imgfn</span><span class="p">,</span> <span class="n">maskfn</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">astrometry.util.file</span> <span class="k">import</span> <span class="n">trymakedirs</span>
        <span class="c1"># grab header values...</span>
        <span class="n">primhdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_image_primary_header</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">magzp</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">primhdr</span><span class="p">[</span><span class="s1">&#39;MAGZERO&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">magzp</span> <span class="o">=</span> <span class="mf">25.</span>
        <span class="n">seeing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixscale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FWHM&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span><span class="p">,</span> <span class="s1">&#39;pix&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pixscale&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixscale</span><span class="p">,</span> <span class="s1">&#39;arcsec/pix&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Seeing&#39;</span><span class="p">,</span> <span class="n">seeing</span><span class="p">,</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;magzp&#39;</span><span class="p">,</span> <span class="n">magzp</span><span class="p">)</span>
        
        <span class="n">sedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">get_se_dir</span><span class="p">()</span>
        <span class="n">trymakedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sefn</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># We write the SE catalog to a temp file then rename, to avoid</span>
        <span class="c1"># partially-written outputs.</span>
        <span class="n">tmpfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sefn</span><span class="p">),</span>
                             <span class="s1">&#39;tmp-&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sefn</span><span class="p">))</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="s1">&#39;sex&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sedir</span><span class="p">,</span> <span class="n">surveyname</span> <span class="o">+</span> <span class="s1">&#39;.se&#39;</span><span class="p">),</span>
            <span class="s1">&#39;-PARAMETERS_NAME&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sedir</span><span class="p">,</span> <span class="n">surveyname</span> <span class="o">+</span> <span class="s1">&#39;.param&#39;</span><span class="p">),</span>
            <span class="s1">&#39;-FILTER_NAME </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sedir</span><span class="p">,</span> <span class="n">surveyname</span> <span class="o">+</span> <span class="s1">&#39;.conv&#39;</span><span class="p">),</span>
            <span class="s1">&#39;-FLAG_IMAGE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">maskfn</span><span class="p">,</span>
            <span class="s1">&#39;-CATALOG_NAME </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tmpfn</span><span class="p">,</span>
            <span class="s1">&#39;-SEEING_FWHM </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">seeing</span><span class="p">,</span>
            <span class="s1">&#39;-MAG_ZEROPOINT </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">magzp</span><span class="p">,</span>
            <span class="n">imgfn</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rtn</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Command failed: &#39;</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">tmpfn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sefn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_psfex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surveyname</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">astrometry.util.file</span> <span class="k">import</span> <span class="n">trymakedirs</span>
        <span class="kn">from</span> <span class="nn">legacypipe.survey</span> <span class="k">import</span> <span class="n">get_git_version</span>
        <span class="n">sedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">get_se_dir</span><span class="p">()</span>
        <span class="n">trymakedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psffn</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">primhdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_image_primary_header</span><span class="p">()</span>
        <span class="n">plver</span> <span class="o">=</span> <span class="n">primhdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PLVER&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">verstr</span> <span class="o">=</span> <span class="n">get_git_version</span><span class="p">()</span>
        <span class="c1"># We write the PSF model to a .fits.tmp file, then rename to .fits</span>
        <span class="n">psfdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psffn</span><span class="p">)</span>
        <span class="n">psfoutfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">psfdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sefn</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;psfex -c </span><span class="si">%s</span><span class="s1"> -PSF_DIR </span><span class="si">%s</span><span class="s1"> -PSF_SUFFIX .fits.tmp </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sedir</span><span class="p">,</span> <span class="n">surveyname</span> <span class="o">+</span> <span class="s1">&#39;.psfex&#39;</span><span class="p">),</span>
                 <span class="n">psfdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sefn</span><span class="p">),</span>
                <span class="s1">&#39;mv </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">psfoutfn</span> <span class="o">+</span> <span class="s1">&#39;.tmp&#39;</span><span class="p">,</span> <span class="n">psfoutfn</span><span class="p">),</span>
                <span class="s1">&#39;modhead </span><span class="si">%s</span><span class="s1"> LEGPIPEV </span><span class="si">%s</span><span class="s1"> &quot;legacypipe git version&quot;&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psffn</span><span class="p">,</span> <span class="n">verstr</span><span class="p">),</span>
                <span class="s1">&#39;modhead </span><span class="si">%s</span><span class="s1"> PLVER </span><span class="si">%s</span><span class="s1"> &quot;CP ver of image file&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psffn</span><span class="p">,</span> <span class="n">plver</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">rtn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rtn</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Command failed: </span><span class="si">%s</span><span class="s1">: return value: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span>
                                   <span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="n">rtn</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">run_sky</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surveyname</span><span class="p">,</span> <span class="n">splinesky</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">git_version</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">legacypipe.survey</span> <span class="k">import</span> <span class="n">get_version_header</span>

        <span class="n">slc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_good_image_slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_image</span><span class="p">(</span><span class="nb">slice</span><span class="o">=</span><span class="n">slc</span><span class="p">)</span>
        <span class="n">wt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_invvar</span><span class="p">(</span><span class="nb">slice</span><span class="o">=</span><span class="n">slc</span><span class="p">)</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">get_version_header</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">get_survey_dir</span><span class="p">(),</span>
                                 <span class="n">git_version</span><span class="o">=</span><span class="n">git_version</span><span class="p">)</span>
        <span class="n">primhdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_image_primary_header</span><span class="p">()</span>
        <span class="n">plver</span> <span class="o">=</span> <span class="n">primhdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PLVER&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;PROCTYPE&#39;</span><span class="p">)</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;PROCTYPE&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;ccd&#39;</span><span class="p">,</span>
                            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;NOAO processing type&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;PRODTYPE&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;skymodel&#39;</span><span class="p">,</span>
                            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;NOAO product type&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;PLVER&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">plver</span><span class="p">,</span>
                            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;CP ver of image file&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">splinesky</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">tractor.splinesky</span> <span class="k">import</span> <span class="n">SplineSky</span>
            <span class="kn">from</span> <span class="nn">scipy.ndimage.morphology</span> <span class="k">import</span> <span class="n">binary_dilation</span>

            <span class="n">boxsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splinesky_boxsize</span>
            
            <span class="c1"># Start by subtracting the overall median</span>
            <span class="n">good</span> <span class="o">=</span> <span class="p">(</span><span class="n">wt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">good</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No pixels with weight &gt; 0 in: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="n">med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">good</span><span class="p">])</span>
            <span class="c1"># Compute initial model...</span>
            <span class="n">skyobj</span> <span class="o">=</span> <span class="n">SplineSky</span><span class="o">.</span><span class="n">BlantonMethod</span><span class="p">(</span><span class="n">img</span> <span class="o">-</span> <span class="n">med</span><span class="p">,</span> <span class="n">good</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">)</span>
            <span class="n">skymod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">skyobj</span><span class="o">.</span><span class="n">addTo</span><span class="p">(</span><span class="n">skymod</span><span class="p">)</span>
            <span class="c1"># Now mask bright objects in (image - initial sky model)</span>
            <span class="n">sig1</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">wt</span><span class="p">[</span><span class="n">good</span><span class="p">]))</span>
            <span class="n">masked</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span> <span class="o">-</span> <span class="n">med</span> <span class="o">-</span> <span class="n">skymod</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">5.</span><span class="o">*</span><span class="n">sig1</span><span class="p">)</span>
            <span class="n">masked</span> <span class="o">=</span> <span class="n">binary_dilation</span><span class="p">(</span><span class="n">masked</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">masked</span><span class="p">[</span><span class="n">wt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">sig1b</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">wt</span><span class="p">[</span><span class="n">masked</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sig1 vs sig1b:&#39;</span><span class="p">,</span> <span class="n">sig1</span><span class="p">,</span> <span class="n">sig1b</span><span class="p">)</span>

            <span class="c1"># Now find the final sky model using that more extensive mask</span>
            <span class="n">skyobj</span> <span class="o">=</span> <span class="n">SplineSky</span><span class="o">.</span><span class="n">BlantonMethod</span><span class="p">(</span>
                <span class="n">img</span> <span class="o">-</span> <span class="n">med</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">masked</span><span class="p">),</span> <span class="n">boxsize</span><span class="p">)</span>
            <span class="c1"># add the overall median back in</span>
            <span class="n">skyobj</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">med</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">slc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sy</span><span class="p">,</span><span class="n">sx</span> <span class="o">=</span> <span class="n">slc</span>
                <span class="n">y0</span> <span class="o">=</span> <span class="n">sy</span><span class="o">.</span><span class="n">start</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">start</span>
                <span class="n">skyobj</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">x0</span><span class="p">,</span> <span class="o">-</span><span class="n">y0</span><span class="p">)</span>

            <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SIG1&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">sig1</span><span class="p">,</span>
                                <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Median stdev of unmasked pixels&#39;</span><span class="p">))</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SIG1B&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">sig1</span><span class="p">,</span>
                                <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Median stdev of unmasked pixels+&#39;</span><span class="p">))</span>
                
            <span class="n">trymakedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splineskyfn</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">skyobj</span><span class="o">.</span><span class="n">write_fits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splineskyfn</span><span class="p">,</span> <span class="n">primhdr</span><span class="o">=</span><span class="n">hdr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrote sky model&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">splineskyfn</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">skyval</span> <span class="o">=</span> <span class="n">estimate_mode</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">wt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="n">raiseOnWarn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">skymeth</span> <span class="o">=</span> <span class="s1">&#39;mode&#39;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">skyval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">wt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">skymeth</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span>
            <span class="n">tsky</span> <span class="o">=</span> <span class="n">ConstantSky</span><span class="p">(</span><span class="n">skyval</span><span class="p">)</span>

            <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SKYMETH&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">skymeth</span><span class="p">,</span>
                                <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;estimate_mode, or fallback to median?&#39;</span><span class="p">))</span>

            <span class="n">sig1</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">wt</span><span class="p">[</span><span class="n">wt</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">masked</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span> <span class="o">-</span> <span class="n">skyval</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">5.</span><span class="o">*</span><span class="n">sig1</span><span class="p">)</span>
            <span class="n">masked</span> <span class="o">=</span> <span class="n">binary_dilation</span><span class="p">(</span><span class="n">masked</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">masked</span><span class="p">[</span><span class="n">wt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">sig1b</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">wt</span><span class="p">[</span><span class="n">masked</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sig1 vs sig1b:&#39;</span><span class="p">,</span> <span class="n">sig1</span><span class="p">,</span> <span class="n">sig1b</span><span class="p">)</span>

            <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SIG1&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">sig1</span><span class="p">,</span>
                                <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Median stdev of unmasked pixels&#39;</span><span class="p">))</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;SIG1B&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">sig1</span><span class="p">,</span>
                                <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Median stdev of unmasked pixels+&#39;</span><span class="p">))</span>
            
            <span class="n">trymakedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyfn</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">tsky</span><span class="o">.</span><span class="n">write_fits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyfn</span><span class="p">,</span> <span class="n">hdr</span><span class="o">=</span><span class="n">hdr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrote sky model&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyfn</span><span class="p">)</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2014-2018, Kaylan Burleigh, John Moustakas.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6.<br/>
    </p>
  </div>
</footer>
  </body>
</html>