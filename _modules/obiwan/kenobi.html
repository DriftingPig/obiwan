
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>obiwan.kenobi &#8212; obiwan 1.2.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for obiwan.kenobi</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;This is obiwan.kenobi</span>
<span class="sd">...it runs the legacypipe/Tractor pipeline on images containing artificial sources</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">galsim</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">photutils</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="k">import</span> <span class="n">resource_filename</span>
<span class="kn">from</span> <span class="nn">pickle</span> <span class="k">import</span> <span class="n">dump</span>


<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="k">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">vstack</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="c1">#from astropy import wcs as astropy_wcs</span>
<span class="kn">from</span> <span class="nn">fitsio</span> <span class="k">import</span> <span class="n">FITSHDR</span>
<span class="kn">import</span> <span class="nn">fitsio</span>

<span class="kn">from</span> <span class="nn">astropy</span> <span class="k">import</span> <span class="n">units</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="k">import</span> <span class="n">SkyCoord</span>

<span class="kn">from</span> <span class="nn">tractor.psfex</span> <span class="k">import</span> <span class="n">PsfEx</span><span class="p">,</span> <span class="n">PsfExModel</span>
<span class="kn">from</span> <span class="nn">tractor.basics</span> <span class="k">import</span> <span class="n">GaussianMixtureEllipsePSF</span><span class="p">,</span> <span class="n">RaDecPos</span>

<span class="kn">from</span> <span class="nn">legacypipe.runbrick</span> <span class="k">import</span> <span class="n">run_brick</span>
<span class="kn">from</span> <span class="nn">legacypipe.decam</span> <span class="k">import</span> <span class="n">DecamImage</span>
<span class="kn">from</span> <span class="nn">legacypipe.survey</span> <span class="k">import</span> <span class="n">LegacySurveyData</span><span class="p">,</span> <span class="n">wcs_for_brick</span>

<span class="kn">import</span> <span class="nn">obiwan.priors</span> <span class="k">as</span> <span class="nn">priors</span>
<span class="kn">from</span> <span class="nn">obiwan.db_tools</span> <span class="k">import</span> <span class="n">getSrcsInBrick</span> 

<span class="kn">from</span> <span class="nn">astrometry.util.fits</span> <span class="k">import</span> <span class="n">fits_table</span><span class="p">,</span> <span class="n">merge_tables</span>
<span class="kn">from</span> <span class="nn">astrometry.util.ttime</span> <span class="k">import</span> <span class="n">Time</span>

<span class="kn">import</span> <span class="nn">csv</span>

<div class="viewcode-block" id="write_dict"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.write_dict">[docs]</a><span class="k">def</span> <span class="nf">write_dict</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;d -- dictionary&#39;&#39;&#39;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">w</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">])</span></div>

<span class="k">def</span> <span class="nf">read_dict</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)):</span>
        <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">imshow_stamp</span><span class="p">(</span><span class="n">stamp</span><span class="p">,</span><span class="n">fn</span><span class="o">=</span><span class="s1">&#39;test.png&#39;</span><span class="p">,</span><span class="n">galsimobj</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">galsimobj</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">stamp</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">img</span><span class="o">=</span> <span class="n">stamp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">img</span><span class="o">=</span><span class="n">img</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">+</span><span class="mi">1</span> 
    <span class="n">plt</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">img</span><span class="p">),</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="c1">#plt.imshow(np.log10(img),origin=&#39;lower&#39;,cmap=&#39;gray&#39;)</span>
    <span class="c1">#plt.savefig(fn)</span>
    <span class="c1">#plt.close()</span>
    <span class="c1">#print(&#39;Wrote %s&#39; % fn)</span>

<span class="k">def</span> <span class="nf">plot_radial_profs</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">profs</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">profs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">r</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">profs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">lab</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">),[</span><span class="s1">&#39;src&#39;</span><span class="p">,</span><span class="s1">&#39;srcnoise&#39;</span><span class="p">,</span><span class="s1">&#39;srcnoiseimg&#39;</span><span class="p">]):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">profs</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<div class="viewcode-block" id="ptime"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.ptime">[docs]</a><span class="k">def</span> <span class="nf">ptime</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="n">t0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Timer&#39;&#39;&#39;</span>    
    <span class="n">tnow</span><span class="o">=</span><span class="n">Time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TIMING:</span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">text</span><span class="p">,</span><span class="n">tnow</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tnow</span></div>



<span class="k">def</span> <span class="nf">get_savedir</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;decals_sim_dir&#39;</span><span class="p">],</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;objtype&#39;</span><span class="p">],</span>\
                        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;brickname&#39;</span><span class="p">][:</span><span class="mi">3</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;brickname&#39;</span><span class="p">],</span>\
                        <span class="s2">&quot;rs</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;rowst&#39;</span><span class="p">])</span>    

<span class="k">def</span> <span class="nf">get_fnsuffix</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;-</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;objtype&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;brickname&#39;</span><span class="p">])</span>
                                   <span class="c1">#&#39;rs%d&#39; % kwargs[&#39;rowst&#39;])</span>

<div class="viewcode-block" id="SimDecals"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.SimDecals">[docs]</a><span class="k">class</span> <span class="nc">SimDecals</span><span class="p">(</span><span class="n">LegacySurveyData</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;Top level object that specifying which data to run through pipeline</span>

<span class="sd">	Same behavior as legacypipe.runs.Dr3DecalsSurvey which chooses which</span>
<span class="sd">		CCDs to include. But this also stores all the relevant obiwan</span>
<span class="sd">		objects</span>

<span class="sd">	Args:</span>
<span class="sd">		DR: which Data-Release to consider. e.g. if DR=3, then only </span>
<span class="sd">			images included in DR3 will be considered </span>
<span class="sd">		survey_dir: as used by legacypipe.runbrick.run_brick()</span>
<span class="sd">			Defaults to $LEGACY_SURVEY_DIR environment variable.  Where to look for</span>
<span class="sd">			files including calibration files, tables of CCDs and bricks, image data</span>
<span class="sd">		metacat: fits_table </span>
<span class="sd">			configuration-like params for the simulated sources</span>
<span class="sd">		simcat: fits_table</span>
<span class="sd">			simulated source catalog for a given brick (not CCD).</span>
<span class="sd">		output_dir: legacypipe&#39;s outdir</span>
<span class="sd">		add_sim_noise: add Poisson noise from the simulated source to the image </span>
<span class="sd">		folding_threshold: how close the simulated source flux is to the requested flux</span>
<span class="sd">			make smaller to increase simulated source flux/requested flux</span>
<span class="sd">		image_eq_model: referred to as &#39;testA&#39;</span>
<span class="sd">			wherever add a simulated source, replace both image and invvar of the image</span>
<span class="sd">			with that of the simulated source only</span>

<span class="sd">	Attributes:</span>
<span class="sd">		DR: which Data-Release to consider. e.g. if DR=3, then only </span>
<span class="sd">			images included in DR3 will be considered </span>
<span class="sd">		metacat: fits_table </span>
<span class="sd">			configuration-like params for the simulated sources</span>
<span class="sd">		simcat: fits_table</span>
<span class="sd">			simulated source catalog for a given brick (not CCD).</span>
<span class="sd">		output_dir: legacypipe&#39;s outdir</span>
<span class="sd">		add_sim_noise: add Poisson noise from the simulated source to the image </span>
<span class="sd">		folding_threshold: how close the simulated source flux is to the requested flux</span>
<span class="sd">			make smaller to increase simulated source flux/requested flux</span>
<span class="sd">		image_eq_model: referred to as &#39;testA&#39;</span>
<span class="sd">			wherever add a simulated source, replace both image and invvar of the image</span>
<span class="sd">			with that of the simulated source only</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">DR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">survey_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metacat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simcat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>\
					   <span class="n">add_sim_noise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">folding_threshold</span><span class="o">=</span><span class="mf">1.e-5</span><span class="p">,</span> <span class="n">image_eq_model</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">(</span><span class="n">SimDecals</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">survey_dir</span><span class="o">=</span><span class="n">survey_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">DR</span><span class="o">=</span> <span class="n">DR</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">metacat</span> <span class="o">=</span> <span class="n">metacat</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">simcat</span> <span class="o">=</span> <span class="n">simcat</span>
		<span class="c1"># Additional options from command line</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">add_sim_noise</span><span class="o">=</span> <span class="n">add_sim_noise</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">folding_threshold</span><span class="o">=</span> <span class="n">folding_threshold</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">image_eq_model</span><span class="o">=</span> <span class="n">image_eq_model</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SimDecals: self.image_eq_model=&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">image_eq_model</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">get_image_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">SimImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

	<span class="c1">#######</span>
	<span class="c1"># see legacypipe/runs.py</span>
	<span class="k">def</span> <span class="nf">filter_ccds_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fns</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">DR</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
			<span class="k">return</span> <span class="p">[</span><span class="n">fn</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fns</span> <span class="k">if</span>
					<span class="p">(</span><span class="s1">&#39;survey-ccds-decals.fits.gz&#39;</span> <span class="ow">in</span> <span class="n">fn</span>  <span class="ow">or</span>
					 <span class="s1">&#39;survey-ccds-nondecals.fits.gz&#39;</span> <span class="ow">in</span> <span class="n">fn</span> <span class="ow">or</span>
					 <span class="s1">&#39;survey-ccds-extra.fits.gz&#39;</span> <span class="ow">in</span> <span class="n">fn</span><span class="p">)]</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">DR</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
			<span class="k">return</span> <span class="p">[</span><span class="n">fn</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fns</span> <span class="k">if</span>
					<span class="p">(</span><span class="s1">&#39;survey-ccds-dr4-90prime.fits.gz&#39;</span> <span class="ow">in</span> <span class="n">fn</span> <span class="ow">or</span>
					<span class="s1">&#39;survey-ccds-dr4-mzlsv2.fits.gz&#39;</span> <span class="ow">in</span> <span class="n">fn</span><span class="p">)]</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">DR</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">fns</span>

	<span class="k">def</span> <span class="nf">ccds_for_fitting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">brick</span><span class="p">,</span> <span class="n">ccds</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">DR</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]:</span>
			<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">ccds</span><span class="o">.</span><span class="n">camera</span> <span class="o">==</span> <span class="s1">&#39;decam&#39;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">DR</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">ccds</span><span class="o">.</span><span class="n">camera</span> <span class="o">==</span> <span class="s1">&#39;mosaic&#39;</span><span class="p">,</span>
								  <span class="n">ccds</span><span class="o">.</span><span class="n">camera</span> <span class="o">==</span> <span class="s1">&#39;90prime&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="SimDecals.filter_ccd_kd_files"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.SimDecals.filter_ccd_kd_files">[docs]</a>	<span class="k">def</span> <span class="nf">filter_ccd_kd_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fns</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;introduced in DR5&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="p">[]</span></div></div>
	<span class="c1">#######</span>

<div class="viewcode-block" id="get_srcimg_invvar"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.get_srcimg_invvar">[docs]</a><span class="k">def</span> <span class="nf">get_srcimg_invvar</span><span class="p">(</span><span class="n">stamp_ivar</span><span class="p">,</span><span class="n">img_ivar</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;stamp_ivar, img_ivar -- galsim Image objects&#39;&#39;&#39;</span>
    <span class="c1"># Use img_ivar when stamp_ivar == 0, both otherwise</span>
    <span class="n">use_img_ivar</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">img_ivar</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">use_img_ivar</span><span class="p">[</span> <span class="n">stamp_ivar</span><span class="o">.</span><span class="n">array</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># First compute using both</span>
    <span class="n">ivar</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">stamp_ivar</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">img_ivar</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    <span class="n">ivar</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">ivar</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    <span class="n">keep</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ivar</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">keep</span><span class="p">[</span> <span class="p">(</span><span class="n">stamp_ivar</span><span class="o">.</span><span class="n">array</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span>\
          <span class="p">(</span><span class="n">img_ivar</span><span class="o">.</span><span class="n">array</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ivar</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="c1"># Now use img_ivar only where need to</span>
    <span class="n">ivar</span><span class="p">[</span> <span class="n">use_img_ivar</span> <span class="p">]</span> <span class="o">=</span> <span class="n">img_ivar</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span> <span class="n">use_img_ivar</span> <span class="p">]</span>
    <span class="c1"># return </span>
    <span class="n">obj_ivar</span> <span class="o">=</span> <span class="n">stamp_ivar</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">obj_ivar</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
    <span class="n">obj_ivar</span><span class="o">+=</span> <span class="n">ivar</span>
    <span class="k">return</span> <span class="n">obj_ivar</span></div>

<span class="k">def</span> <span class="nf">saturation_e</span><span class="p">(</span><span class="n">camera</span><span class="p">):</span>
	<span class="c1"># Saturation limit</span>
	<span class="n">d</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">decam</span><span class="o">=</span><span class="mf">3e4</span><span class="p">)</span> <span class="c1"># e-</span>
	<span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">ivar_to_var</span><span class="p">(</span><span class="n">ivar</span><span class="p">,</span><span class="n">nano2e</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">camera</span><span class="o">=</span><span class="s1">&#39;decam&#39;</span><span class="p">):</span>
	<span class="k">assert</span><span class="p">(</span><span class="n">nano2e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
	<span class="n">flag</span><span class="o">=</span> <span class="n">ivar</span> <span class="o">==</span> <span class="mf">0.</span>
	<span class="n">var</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">ivar</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="c1"># Set 0 ivar pixels to satuation limit</span>
	<span class="c1"># var * nano2e^2 = e-^2</span>
	<span class="n">sat</span><span class="o">=</span> <span class="n">saturation_e</span><span class="p">(</span><span class="n">camera</span><span class="p">)</span> <span class="o">/</span> <span class="n">nano2e</span><span class="o">**</span><span class="mi">2</span>
	<span class="n">var</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span><span class="o">=</span> <span class="n">sat</span>
	<span class="k">return</span> <span class="n">var</span> 

<div class="viewcode-block" id="SimImage"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.SimImage">[docs]</a><span class="k">class</span> <span class="nc">SimImage</span><span class="p">(</span><span class="n">DecamImage</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;Adds simulated sources to a single exposure</span>

<span class="sd">	Similar behavior as legacypipe.decam.DecamImage. Instead of </span>
<span class="sd">		loading images specifically from DECam, this  loads images</span>
<span class="sd">		with simulated sources added in </span>

<span class="sd">	Args:</span>
<span class="sd">		survey: SimDecals() object</span>
<span class="sd">		t: as used by DecamImage</span>
<span class="sd">			a single row fits_table for a specific CCD</span>

<span class="sd">	Attributes:</span>
<span class="sd">		inherits: DecamImage</span>
<span class="sd">		t: as used by DecamImage</span>
<span class="sd">			a single row fits_table for a specific CCD</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">survey</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">(</span><span class="n">SimImage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>

	<span class="k">def</span> <span class="nf">get_tractor_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="n">tim</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">SimImage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_tractor_image</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">tim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># this can be None when the edge of a CCD overlaps</span>
			<span class="k">return</span> <span class="n">tim</span>

		<span class="c1"># Seed</span>
		<span class="c1">#if &#39;SEED&#39; in self.survey.metacat.columns:</span>
		<span class="c1">#    seed = self.survey.metacat[&#39;SEED&#39;]</span>
		<span class="c1">#else:</span>
		<span class="c1">#    seed = None</span>

		<span class="n">objtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">metacat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;objtype&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">objstamp</span> <span class="o">=</span> <span class="n">BuildStamp</span><span class="p">(</span><span class="n">tim</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">arawgain</span><span class="p">,</span> \
							  <span class="n">folding_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">folding_threshold</span><span class="p">,</span>\
							  <span class="n">stamp_size</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">metacat</span><span class="o">.</span><span class="n">stamp_size</span><span class="p">)</span>

		<span class="c1"># Grab the data and inverse variance images [nanomaggies!]</span>
		<span class="n">tim_image</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">getImage</span><span class="p">())</span>
		<span class="n">tim_invvar</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">getInvvar</span><span class="p">())</span>
		<span class="n">tim_dq</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">dq</span><span class="p">)</span>
		<span class="c1"># Also store galaxy sims and sims invvar</span>
		<span class="n">sims_image</span> <span class="o">=</span> <span class="n">tim_image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
		<span class="n">sims_image</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
		<span class="n">sims_ivar</span> <span class="o">=</span> <span class="n">sims_image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="c1"># To make cutout for deeplearning</span>
		<span class="n">tim</span><span class="o">.</span><span class="n">sims_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">simcat</span><span class="p">),</span><span class="mi">4</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span> 
		<span class="n">tim</span><span class="o">.</span><span class="n">sims_xyc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">simcat</span><span class="p">),</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>
		<span class="n">tim</span><span class="o">.</span><span class="n">sims_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">simcat</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
		<span class="n">tim</span><span class="o">.</span><span class="n">sims_added_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">simcat</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>

		<span class="c1"># Store simulated galaxy images in tim object </span>
		<span class="c1"># Loop on each object.</span>
		<span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">simcat</span><span class="p">):</span>
			<span class="c1"># Print timing</span>
			<span class="n">t0</span><span class="o">=</span> <span class="n">Time</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">objtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lrg&#39;</span><span class="p">,</span><span class="s1">&#39;elg&#39;</span><span class="p">]:</span>
				<span class="n">strin</span><span class="o">=</span> <span class="s1">&#39;Drawing 1 </span><span class="si">%s</span><span class="s1">: sersicn=</span><span class="si">%.2f</span><span class="s1">, rhalf=</span><span class="si">%.2f</span><span class="s1">, ba=</span><span class="si">%.2f</span><span class="s1">, phi=</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> \
						<span class="p">(</span><span class="n">objtype</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">obj</span><span class="o">.</span><span class="n">sersicn</span><span class="p">,</span><span class="n">obj</span><span class="o">.</span><span class="n">rhalf</span><span class="p">,</span><span class="n">obj</span><span class="o">.</span><span class="n">ba</span><span class="p">,</span><span class="n">obj</span><span class="o">.</span><span class="n">phi</span><span class="p">)</span>
				<span class="nb">print</span><span class="p">(</span><span class="n">strin</span><span class="p">)</span>
			<span class="c1"># Before drawing we can check if the obj is near CCD</span>
			<span class="c1">#if self.survey.metacat.cutouts[0]: </span>
			<span class="c1">#    #draw_it= isNearCCD(tim,obj,</span>
			<span class="c1">#    junk,xx,yy = tim.wcs.wcs.radec2pixelxy(obj.ra,obj.dec)</span>
			<span class="c1">#    xx,yy= int(xx),int(yy)</span>
			<span class="c1">#    min_stamp_pixels= 16  # 200. / 3600. # arcsec -&gt; deg</span>
			<span class="c1">#    obj_bounds= galsim.BoundsI(xmin= xx - min_stamp_pixels/2,\</span>
			<span class="c1">#                            xmax= xx + min_stamp_pixels/2,\</span>
			<span class="c1">#                            ymin= yy - min_stamp_pixels/2,\</span>
			<span class="c1">#                            ymax= yy + min_stamp_pixels/2)</span>
			<span class="c1">#    overlap = obj_bounds &amp; tim_image.bounds</span>
			<span class="c1">#    # Even the SMALLEST stamp fits entirely within image</span>
			<span class="c1">#    # High prob teh full size stamp will  </span>
			<span class="c1">#    draw_it= obj_bounds == overlap</span>
			<span class="c1">#    #x1, y1 = tim.wcs.positionToPixel(RaDecPos(obj.ra-max_stamp_size/2, obj.dec-max_stamp_size/2))</span>

			<span class="k">if</span> <span class="n">objtype</span> <span class="o">==</span> <span class="s1">&#39;star&#39;</span><span class="p">:</span>
				<span class="n">stamp</span> <span class="o">=</span> <span class="n">objstamp</span><span class="o">.</span><span class="n">star</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">objtype</span> <span class="o">==</span> <span class="s1">&#39;elg&#39;</span><span class="p">:</span>
				<span class="n">stamp</span> <span class="o">=</span> <span class="n">objstamp</span><span class="o">.</span><span class="n">elg</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">objtype</span> <span class="o">==</span> <span class="s1">&#39;lrg&#39;</span><span class="p">:</span>
				<span class="n">stamp</span> <span class="o">=</span> <span class="n">objstamp</span><span class="o">.</span><span class="n">lrg</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">objtype</span> <span class="o">==</span> <span class="s1">&#39;qso&#39;</span><span class="p">:</span>
				<span class="n">stamp</span> <span class="o">=</span> <span class="n">objstamp</span><span class="o">.</span><span class="n">qso</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
			<span class="n">t0</span><span class="o">=</span> <span class="n">ptime</span><span class="p">(</span><span class="s1">&#39;Drew the </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">objtype</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span><span class="n">t0</span><span class="p">)</span>
			<span class="c1">#print(&#39;I predict we draw it&#39;,draw_it)</span>
			<span class="c1"># Save radial profiles after draw, addNoise, etc. for unit tests</span>
			<span class="c1">#rad_profs=np.zeros((stamp.array.shape[0],3))</span>
			<span class="c1">#rad_profs[:,0]= stamp.array.copy()[ stamp.array.shape[0]/2,: ]</span>
			<span class="c1"># Want to save flux actually added too</span>
			<span class="n">added_flux</span><span class="o">=</span> <span class="n">stamp</span><span class="o">.</span><span class="n">added_flux</span>
			<span class="n">stamp_nonoise</span><span class="o">=</span> <span class="n">stamp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">add_sim_noise</span><span class="p">:</span>
				<span class="c1">#stamp2,stamp3= objstamp.addGaussNoise(stamp, ivarstamp)</span>
				<span class="n">ivarstamp</span><span class="o">=</span> <span class="n">objstamp</span><span class="o">.</span><span class="n">addGaussNoise</span><span class="p">(</span><span class="n">stamp</span><span class="p">)</span>
			<span class="c1"># Add source if EVEN 1 pix falls on the CCD</span>
			<span class="n">overlap</span> <span class="o">=</span> <span class="n">stamp</span><span class="o">.</span><span class="n">bounds</span> <span class="o">&amp;</span> <span class="n">tim_image</span><span class="o">.</span><span class="n">bounds</span>
			<span class="n">add_source</span> <span class="o">=</span> <span class="n">overlap</span><span class="o">.</span><span class="n">area</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
			<span class="c1"># For Deep learning: only add source if entire thing fits on image</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">metacat</span><span class="o">.</span><span class="n">cutouts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
				<span class="c1"># this is a deep learning run</span>
				<span class="n">add_source</span><span class="o">=</span> <span class="n">stamp</span><span class="o">.</span><span class="n">bounds</span> <span class="o">==</span> <span class="n">overlap</span>
			<span class="k">if</span> <span class="n">add_source</span><span class="p">:</span>
				<span class="n">stamp</span> <span class="o">=</span> <span class="n">stamp</span><span class="p">[</span><span class="n">overlap</span><span class="p">]</span>      
				<span class="n">ivarstamp</span> <span class="o">=</span> <span class="n">ivarstamp</span><span class="p">[</span><span class="n">overlap</span><span class="p">]</span>      
				<span class="n">stamp_nonoise</span><span class="o">=</span> <span class="n">stamp_nonoise</span><span class="p">[</span><span class="n">overlap</span><span class="p">]</span>
				
				<span class="c1">#rad_profs[:,1]= stamp.array.copy()[ stamp.array.shape[0]/2,: ]</span>

				<span class="c1"># Zero out invvar where bad pixel mask is flagged (&gt; 0)</span>
				<span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tim_dq</span><span class="p">[</span><span class="n">overlap</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
				<span class="n">keep</span><span class="p">[</span> <span class="n">tim_dq</span><span class="p">[</span><span class="n">overlap</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
				<span class="n">ivarstamp</span> <span class="o">*=</span> <span class="n">keep</span>
				<span class="c1">#tim_invvar[overlap] *= keep # don&#39;t modify tim_invvar unless adding stamp ivar</span>

				<span class="c1"># Stamp ivar can get messed up at edges</span>
				<span class="c1"># especially when needed stamp smaller than args.stamp_size</span>
				<span class="n">cent</span><span class="o">=</span> <span class="n">ivarstamp</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
				<span class="n">med</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ivarstamp</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">cent</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">cent</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">cent</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">cent</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="p">)</span>
				<span class="c1"># 100x median fainter gets majority of star,qso OR elg,lrg profile</span>
				<span class="n">ivarstamp</span><span class="o">.</span><span class="n">array</span><span class="p">[</span> <span class="n">ivarstamp</span><span class="o">.</span><span class="n">array</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">med</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

				<span class="c1"># Add stamp to image</span>
				<span class="n">back</span><span class="o">=</span> <span class="n">tim_image</span><span class="p">[</span><span class="n">overlap</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="n">tim_image</span><span class="p">[</span><span class="n">overlap</span><span class="p">]</span> <span class="o">=</span> <span class="n">back</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">+</span> <span class="n">stamp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="c1"># Add variances</span>
				<span class="n">back_ivar</span><span class="o">=</span> <span class="n">tim_invvar</span><span class="p">[</span><span class="n">overlap</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="n">tot_ivar</span><span class="o">=</span> <span class="n">get_srcimg_invvar</span><span class="p">(</span><span class="n">ivarstamp</span><span class="p">,</span> <span class="n">back_ivar</span><span class="p">)</span>
				<span class="n">tim_invvar</span><span class="p">[</span><span class="n">overlap</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot_ivar</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

				<span class="c1">#rad_profs[:,2]= tim_image[overlap].array.copy()[ stamp.array.shape[0]/2,: ]</span>
				<span class="c1"># Save sims info</span>
				<span class="n">tim</span><span class="o">.</span><span class="n">sims_xy</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">overlap</span><span class="o">.</span><span class="n">xmin</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">overlap</span><span class="o">.</span><span class="n">xmax</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
									  <span class="n">overlap</span><span class="o">.</span><span class="n">ymin</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">overlap</span><span class="o">.</span><span class="n">ymax</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># galsim 1st index is 1</span>
				<span class="n">tim</span><span class="o">.</span><span class="n">sims_xyc</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">overlap</span><span class="o">.</span><span class="n">trueCenter</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">overlap</span><span class="o">.</span><span class="n">trueCenter</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
				<span class="c1">#tim.sims_radec[ii, :] = [obj.ra,obj.dec]</span>
				<span class="n">tim</span><span class="o">.</span><span class="n">sims_id</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">id</span>
				<span class="n">tim</span><span class="o">.</span><span class="n">sims_added_flux</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">added_flux</span>

				<span class="c1"># For cutouts we only care about src, background, var (not ivar)</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">metacat</span><span class="o">.</span><span class="n">cutouts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
					<span class="c1"># Data for training: src+noise (cutout) and backgrn (cutout,var,badpix)</span>
					<span class="n">data</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">stamp</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">stamp</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">))</span>
					<span class="c1"># FIX ME, add extra rotations for galaxies?</span>
					<span class="n">data</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="n">stamp</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># src+noise</span>
					<span class="c1">#data[:,:,1]= np.sqrt( np.power(stamp.array.copy(),2) )#src+noise var  #ivarstamp.array.copy() </span>
					<span class="n">data</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="n">back</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># back</span>
					<span class="n">data</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span> <span class="n">tim_dq</span><span class="p">[</span><span class="n">overlap</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># bad pix</span>
					<span class="n">data</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span> <span class="n">stamp_nonoise</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Stamp w/out noise, sanity check</span>
					<span class="c1">#data[:,:,2]= ivar_to_var(back_ivar.array.copy(),nano2e=objstamp.nano2e) # back var</span>
					<span class="c1">#data[:,:,3]= tim_image[overlap].array.copy() # src+noise+background</span>
					<span class="c1">#data[:,:,4]= tim_invvar[overlap].array.copy() # src+noise+background_ nvvar</span>
					<span class="c1"># Save fn</span>
					<span class="n">brick</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">output_dir</span><span class="p">))</span>
					<span class="n">hdf5_fn</span><span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">objtype</span><span class="p">,</span><span class="n">brick</span><span class="p">)</span>  <span class="c1">#&#39;%s_%d_%s&#39; % (tim.band,obj.id,expid)</span>
					<span class="n">hdf5_fn</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span><span class="n">hdf5_fn</span><span class="p">)</span>
					<span class="n">expid</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">imobj</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
					<span class="n">node</span><span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">tim</span><span class="o">.</span><span class="n">band</span><span class="p">,</span><span class="n">expid</span><span class="p">)</span>
					<span class="n">fobj</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">hdf5_fn</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
					<span class="n">dset</span> <span class="o">=</span> <span class="n">fobj</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="n">chunks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
					<span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">dtype</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>\
							<span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;flux_added&#39;</span><span class="p">],</span>\
							<span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">added_flux</span><span class="p">],</span>\
							<span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]):</span>
						<span class="n">dset</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
					<span class="c1">#if objtype in [&#39;lrg&#39;,&#39;elg&#39;]:</span>
					<span class="c1">#    for name,val in zip(\</span>
					<span class="c1">#            [&#39;rhalf&#39;,&#39;sersicn&#39;,&#39;phi&#39;,&#39;ba&#39;],\</span>
					<span class="c1">#            [obj.rhalf,obj.sersicn,obj.phi,obj.ba]):</span>
					<span class="c1">#        dset.attrs.create(name,val,dtype=np.float32)</span>
						<span class="c1">#d.update(dict(rhalf=obj.rhalf,\</span>
						<span class="c1">#              sersicn=obj.sersicn,\</span>
						<span class="c1">#              phi=obj.phi,\</span>
						<span class="c1">#              ba=obj.ba))</span>
					<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saved </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="n">hdf5_fn</span><span class="p">))</span>
					<span class="c1">#np.save(fn+&#39;.npy&#39;,data,allow_pickle=False)</span>
					<span class="c1"># Save enough metadata to classify image quality later</span>
					<span class="c1">#x1,x2,y1,y2= tuple(tim.sims_xy[ii,:])</span>
					<span class="c1">#xc,yc= tuple(tim.sims_xyc[ii,:])</span>
					<span class="c1">#d = dict(band=tim.band,\</span>
					<span class="c1">#		 expid=expid,\</span>
					<span class="c1">#         addedflux= added_flux,\</span>
					<span class="c1">#         id=obj.id,\</span>
					<span class="c1">#         ra=obj.ra,\</span>
					<span class="c1">#         dec=obj.dec)</span>
							 <span class="c1">#xc=xc,yc=yc,\</span>
							 <span class="c1">#(x1=x1,x2=x2,y1=y1,y2=y2,\</span>
							 <span class="c1">#gflux=obj.gflux,\</span>
							 <span class="c1">#rflux=obj.rflux,\</span>
							 <span class="c1">#zflux=obj.zflux)</span>
					<span class="c1">#write_dict(fn+&#39;.csv&#39;,d)</span>
					<span class="c1"># Write sanity checks if they don&#39;t exists</span>
					<span class="c1">#fns= glob(os.path.join(self.survey.output_dir,&#39;*_src.fits&#39;))</span>
					<span class="c1">#if len(fns) == 0:</span>
					<span class="c1">#    # Also write fits file for easier image stretching</span>
					<span class="c1">#    fitsio.write(fn+&#39;_src.fits&#39;,data[...,0],clobber=True)</span>
					<span class="c1">#    fitsio.write(fn+&#39;_src_invvar.fits&#39;,data[...,1],clobber=True)</span>
					<span class="c1">#    fitsio.write(fn+&#39;_img.fits&#39;,data[...,2],clobber=True)</span>
					<span class="c1">#    fitsio.write(fn+&#39;_img_invvar.fits&#39;,data[...,3],clobber=True)</span>
					<span class="c1">#    fitsio.write(fn+&#39;_srcimg.fits&#39;,data[...,4],clobber=True)</span>
					<span class="c1">#    fitsio.write(fn+&#39;_srcimg_invvar.fits&#39;,data[...,5],clobber=True)</span>
					<span class="c1">#    # Draw Radial Profiles</span>
					<span class="c1">#    plot_radial_profs(fn+&#39;_profiles.png&#39;,rad_profs)</span>
				
				<span class="c1">#Extra</span>
				<span class="n">sims_image</span><span class="p">[</span><span class="n">overlap</span><span class="p">]</span> <span class="o">+=</span> <span class="n">stamp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
				<span class="n">sims_ivar</span><span class="p">[</span><span class="n">overlap</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ivarstamp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				
					
				<span class="c1">#print(&#39;HACK!!!&#39;)</span>
				<span class="c1">#galsim.fits.write(stamp, &#39;stamp-{:02d}.fits&#39;.format(ii), clobber=True)</span>
				<span class="c1">#galsim.fits.write(ivarstamp, &#39;ivarstamp-{:02d}.fits&#39;.format(ii), clobber=True)</span>

				<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sims_ivar</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Negative invvar!&#39;</span><span class="p">)</span>
					<span class="kn">import</span> <span class="nn">pdb</span> <span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
		<span class="n">tim</span><span class="o">.</span><span class="n">sims_image</span> <span class="o">=</span> <span class="n">sims_image</span><span class="o">.</span><span class="n">array</span>
		<span class="n">tim</span><span class="o">.</span><span class="n">sims_inverr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sims_ivar</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
		<span class="n">tim</span><span class="o">.</span><span class="n">sims_xy</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">sims_xy</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
		<span class="n">tim</span><span class="o">.</span><span class="n">sims_xyc</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">sims_xyc</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
		<span class="c1"># Can set image=model, ivar=1/model for testing</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">survey</span><span class="o">.</span><span class="n">image_eq_model</span><span class="p">:</span>
			<span class="n">tim</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">sims_image</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="n">tim</span><span class="o">.</span><span class="n">inverr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
			<span class="n">tim</span><span class="o">.</span><span class="n">inverr</span><span class="p">[</span><span class="n">sims_image</span><span class="o">.</span><span class="n">array</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">sims_image</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">sims_image</span><span class="o">.</span><span class="n">array</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">])</span> 
		<span class="k">else</span><span class="p">:</span>
			<span class="n">tim</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">tim_image</span><span class="o">.</span><span class="n">array</span>
			<span class="n">tim</span><span class="o">.</span><span class="n">inverr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tim_invvar</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
		 
		<span class="c1">#print(&#39;HACK!!!&#39;)</span>
		<span class="c1">#galsim.fits.write(invvar, &#39;invvar.fits&#39;.format(ii), clobber=True)</span>
		<span class="c1">#import pdb ; pdb.set_trace()</span>
		<span class="k">return</span> <span class="n">tim</span></div>

<div class="viewcode-block" id="BuildStamp"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.BuildStamp">[docs]</a><span class="k">class</span> <span class="nc">BuildStamp</span><span class="p">():</span>
	<span class="sd">&quot;&quot;&quot;Does the drawing of simulated sources on a single exposure</span>

<span class="sd">	Args: </span>
<span class="sd">		tim: Tractor Image Object for a specific CCD</span>
<span class="sd">		gain: gain of the CCD</span>
<span class="sd">		folding_threshold: how close the simulated source flux is to the requested flux</span>
<span class="sd">			make smaller to increase simulated source flux/requested flux</span>
<span class="sd">		stamp_size: pixels, width and height of simulated images</span>

<span class="sd">	Attributes:</span>
<span class="sd">		band: g,r,z</span>
<span class="sd">		stamp_size: pixels, width and height of simulated images</span>
<span class="sd">		gsparams: galsim object that configures how accurate simulated source will be</span>
<span class="sd">		gsdeviate: galsim object that configures its random number generator</span>
<span class="sd">		wcs: WCS from tim</span>
<span class="sd">		psf: psf from tim</span>
<span class="sd">		galsim_wcs: wcs repackaged into galsim compatible object</span>
<span class="sd">		zpscale: conversion factor &#39;nanomaggies&#39; to &#39;ADU&#39;</span>
<span class="sd">		nano2e: conversion factor &#39;nanomaggies&#39; to &#39;e-&#39;</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tim</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">folding_threshold</span><span class="o">=</span><span class="mf">1.e-5</span><span class="p">,</span> <span class="n">stamp_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span> <span class="o">=</span> <span class="n">stamp_size</span>
		<span class="c1"># GSParams should be used when galsim object is initialized</span>
		<span class="c1"># MAX size for sersic: </span>
		<span class="c1"># https://github.com/GalSim-developers/GalSim/pull/450/commits/755bcfdca25afe42cccfd6a7f8660da5ecda2a65</span>
		<span class="n">MAX_FFT_SIZE</span><span class="o">=</span><span class="mi">1048576</span><span class="n">L</span> <span class="c1">#2^16=65536</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">gsparams</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">GSParams</span><span class="p">(</span><span class="n">maximum_fft_size</span><span class="o">=</span><span class="n">MAX_FFT_SIZE</span><span class="p">,</span>\
										<span class="n">folding_threshold</span><span class="o">=</span><span class="n">folding_threshold</span><span class="p">)</span> 
		<span class="c1">#print(&#39;FIX ME!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">gsdeviate</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">BaseDeviate</span><span class="p">()</span>
		<span class="c1">#if seed is None:</span>
		<span class="c1">#    self.gsdeviate = galsim.BaseDeviate()</span>
		<span class="c1">#else:</span>
		<span class="c1">#    self.gsdeviate = galsim.BaseDeviate(seed)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">getWcs</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">psf</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">getPsf</span><span class="p">()</span>
		<span class="c1"># Tractor wcs object -&gt; galsim wcs object</span>
		<span class="n">temp_hdr</span> <span class="o">=</span> <span class="n">FITSHDR</span><span class="p">()</span>
		<span class="n">subwcs</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_subimage</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">tim</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span>
								  <span class="nb">int</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_width</span><span class="p">())</span><span class="o">-</span><span class="n">tim</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span>
								  <span class="nb">int</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_height</span><span class="p">())</span><span class="o">-</span><span class="n">tim</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">y0</span><span class="p">)</span>
		<span class="n">subwcs</span><span class="o">.</span><span class="n">add_to_header</span><span class="p">(</span><span class="n">temp_hdr</span><span class="p">)</span>
		<span class="c1"># Galsim uses astropy header, not fitsio</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">temp_hdr</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="n">hdr</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">temp_hdr</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">galsim_wcs</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">GSFitsWCS</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">hdr</span><span class="p">)</span>
		<span class="k">del</span> <span class="n">subwcs</span><span class="p">,</span><span class="n">temp_hdr</span><span class="p">,</span><span class="n">hdr</span>
		
		<span class="c1"># zpscale equivalent to magzpt = self.t.ccdzpt+2.5*np.log10(self.t.exptime)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">zpscale</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">zpscale</span>      <span class="c1"># nanomaggies--&gt;ADU conversion factor</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nano2e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zpscale</span><span class="o">*</span><span class="n">gain</span> <span class="c1"># nanomaggies--&gt;electrons conversion factor</span>

<div class="viewcode-block" id="BuildStamp.setlocal"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.BuildStamp.setlocal">[docs]</a>	<span class="k">def</span> <span class="nf">setlocal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Get the pixel positions, local wcs, local PSF.&quot;&quot;&quot;</span> 

		<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">positionToPixel</span><span class="p">(</span><span class="n">RaDecPos</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">),</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dec&#39;</span><span class="p">)))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">PositionD</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">xpos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ypos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">PositionD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">y</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ypos</span><span class="p">)</span>

		<span class="c1"># galsim.drawImage() requires local (linear) wcs</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">localwcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galsim_wcs</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="n">image_pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
		<span class="c1">#cd = self.wcs.cdAtPixel(self.pos.x, self.pos.y)</span>
		<span class="c1">#self.pixscale = np.sqrt(np.linalg.det(cd))*3600.0</span>
		
		<span class="c1"># Get the local PSF</span>
		<span class="n">psfim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf</span><span class="o">.</span><span class="n">getPointSourcePatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypos</span><span class="p">)</span><span class="o">.</span><span class="n">getImage</span><span class="p">()</span>
		<span class="c1">#plt.imshow(psfim) ; plt.show()</span>
		
		<span class="c1"># make galsim PSF object</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">localpsf</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">InterpolatedImage</span><span class="p">(</span><span class="n">galsim</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">psfim</span><span class="p">),</span> <span class="n">wcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">galsim_wcs</span><span class="p">,</span>\
												 <span class="n">gsparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gsparams</span><span class="p">)</span></div>

<div class="viewcode-block" id="BuildStamp.addGaussNoise"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.BuildStamp.addGaussNoise">[docs]</a>	<span class="k">def</span> <span class="nf">addGaussNoise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stamp</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Adds gaussian noise to perfect source (in place)</span>

<span class="sd">                STAMP and IVARSTAMP are in units of nanomaggies and </span>
<span class="sd">                  1/nanomaggies**2, respectively.</span>
<span class="sd">		</span>
<span class="sd">                Returns:</span>
<span class="sd">                  invvar for the stamp</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1">#stamp= stamp_backup.copy()</span>
		<span class="c1">#ivarstamp= ivarstamp_backup.copy()</span>

		
		<span class="c1">#varstamp = ivarstamp.copy()</span>
		<span class="c1">#ivarstamp.invertSelf() # input data, convert to variance</span>
		<span class="c1">#ivarstamp *= self.nano2e**2 # [electron^2]</span>
			 
		<span class="c1"># Add the variance of the object to the variance image (in electrons).</span>
		<span class="n">stamp</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nano2e</span>       <span class="c1"># [noiseless stamp, electron]</span>
		<span class="n">stamp_var</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">stamp</span><span class="o">.</span><span class="n">array</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">wcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">galsim_wcs</span><span class="p">)</span> 
		<span class="n">stamp_var</span><span class="o">.</span><span class="n">setOrigin</span><span class="p">(</span><span class="n">galsim</span><span class="o">.</span><span class="n">PositionI</span><span class="p">(</span><span class="n">stamp</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">stamp</span><span class="o">.</span><span class="n">ymin</span><span class="p">))</span>

		<span class="c1"># Add Poisson noise</span>
		<span class="n">noise</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">VariableGaussianNoise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gsdeviate</span><span class="p">,</span> <span class="n">stamp_var</span><span class="p">)</span>
		<span class="c1">#stamp2= stamp.copy()</span>
		<span class="n">stamp</span><span class="o">.</span><span class="n">addNoise</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span>
		<span class="c1">#stamp3= stamp2.copy()</span>
		<span class="c1">#c=np.random.normal(loc=0,scale=np.sqrt(objvar.array),size=objvar.array.shape)</span>
		<span class="c1">#noise = galsim.Image(c, wcs=self.galsim_wcs)</span>
		<span class="c1">#noise.setOrigin(galsim.PositionI(stamp.xmin, stamp.ymin))</span>
		<span class="c1">#stamp3+= noise</span>
		
		<span class="c1"># Variance of stamp+noise</span>
		<span class="n">stamp_var</span> <span class="o">=</span> <span class="n">stamp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="n">stamp_var</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
		<span class="n">stamp_var</span><span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">stamp</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="p">)</span>
		
		<span class="c1">#imshow_stamp(stamp,fn=&#39;std.png&#39;)</span>
		<span class="c1">#imshow_stamp(stamp_backup,&#39;img.png&#39;)</span>
		
		<span class="c1">#b = galsim.Image(np.zeros(stamp.array.shape), wcs=self.galsim_wcs) </span>
		<span class="c1">#b.array+= stamp.array.copy() </span>
		<span class="c1">#b.array+= stamp_backup.array.copy() </span>
		<span class="c1">#b= stamp.array.copy() + stamp_backup.array.copy()</span>
		<span class="c1">#b= stamp.copy()</span>
		<span class="c1">#b.drawImage(stamp_backup.copy(),add_to_image=True)</span>
		<span class="c1">#imshow_stamp(b,fn=&#39;std_img.png&#39;)</span>
		<span class="c1"># hists</span>
		<span class="c1">#for data,nam in zip([stamp.array.copy(),stamp_backup.array.copy(),b],[&#39;std&#39;,&#39;img&#39;,&#39;std_img&#39;]):</span>
		<span class="c1">#    j=plt.hist(data)</span>
		<span class="c1">#    plt.savefig(nam+&#39;_hist.png&#39;)</span>
		<span class="c1">#    plt.close(nam+&#39;_hist.png&#39;)</span>
		<span class="c1"># Convert back to [nanomaggies]</span>
		<span class="n">stamp</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nano2e</span>      
		<span class="c1">#stamp2 /= self.nano2e      </span>
		<span class="c1">#stamp3 /= self.nano2e      </span>
		<span class="n">stamp_var</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nano2e</span><span class="o">**</span><span class="mi">2</span>

		<span class="c1">#ivarstamp = varstamp.copy()</span>
		<span class="n">stamp_var</span><span class="o">.</span><span class="n">invertSelf</span><span class="p">()</span>
		<span class="c1"># Remask pixels that were masked in the original inverse variance stamp.</span>
		<span class="c1">#ivarstamp *= mask</span>
		<span class="c1"># This is now inv variance</span>
		<span class="k">return</span> <span class="n">stamp_var</span></div>

<div class="viewcode-block" id="BuildStamp.convolve_and_draw"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.BuildStamp.convolve_and_draw">[docs]</a>	<span class="k">def</span> <span class="nf">convolve_and_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Convolve the object with the PSF and then draw it.&quot;&quot;&quot;</span>
		<span class="n">obj</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">Convolve</span><span class="p">([</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localpsf</span><span class="p">],</span> <span class="n">gsparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gsparams</span><span class="p">)</span>
		<span class="c1"># drawImage() requires local wcs</span>
		<span class="c1">#try:</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">stamp</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">localwcs</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;no_pixel&#39;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">stamp</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">localwcs</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;no_pixel&#39;</span><span class="p">,</span>\
								  <span class="n">nx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span><span class="p">,</span><span class="n">ny</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span><span class="p">)</span>
		
		<span class="c1">#except SystemExit:</span>
		<span class="c1">#except BaseException:</span>
		<span class="c1">#    #logging.error(traceback.format_exc())</span>
		<span class="c1">#    print(&#39;got back drawImage!&#39;)</span>
		<span class="c1">#    raise ValueError</span>
		<span class="c1">#try: </span>
		<span class="c1">#except:</span>
		<span class="c1">#    print(&quot;Unexpected error:&quot;, sys.exc_info()[0])</span>
		<span class="c1">#    raise</span>
		<span class="n">stamp</span><span class="o">.</span><span class="n">setCenter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypos</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">stamp</span></div>

<div class="viewcode-block" id="BuildStamp.star"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.BuildStamp.star">[docs]</a>	<span class="k">def</span> <span class="nf">star</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Render a star (PSF).&quot;&quot;&quot;</span>
		<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;decals_sim&#39;</span><span class="p">)</span>
		<span class="c1"># Use input flux as the 7&#39;&#39; aperture flux</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">setlocal</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
		<span class="n">psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">localpsf</span><span class="o">.</span><span class="n">withFlux</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">stamp</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">localwcs</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;no_pixel&#39;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">stamp</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">localwcs</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;no_pixel&#39;</span><span class="p">,</span>\
								  <span class="n">nx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span><span class="p">,</span><span class="n">ny</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span><span class="p">)</span>
		<span class="c1"># Fraction flux in 7&#39;&#39;, FIXED pixelscale</span>
		<span class="n">diam</span> <span class="o">=</span> <span class="mi">7</span><span class="o">/</span><span class="mf">0.262</span>
		<span class="c1"># Aperture fits on stamp</span>
		<span class="n">width</span><span class="o">=</span> <span class="n">stamp</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">xmax</span><span class="o">-</span><span class="n">stamp</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">xmin</span>
		<span class="n">height</span><span class="o">=</span> <span class="n">stamp</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">ymax</span><span class="o">-</span><span class="n">stamp</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">ymin</span>
		<span class="k">if</span> <span class="n">diam</span> <span class="o">&gt;</span> <span class="n">width</span> <span class="ow">and</span> <span class="n">diam</span> <span class="o">&gt;</span> <span class="n">height</span><span class="p">:</span>
			<span class="n">nxy</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">diam</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span>
			<span class="n">stamp</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span><span class="n">nx</span><span class="o">=</span><span class="n">nxy</span><span class="p">,</span><span class="n">ny</span><span class="o">=</span><span class="n">nxy</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">localwcs</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;no_pixel&#39;</span><span class="p">)</span>
		<span class="k">assert</span><span class="p">(</span><span class="n">diam</span> <span class="o">&lt;=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stamp</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">xmax</span><span class="o">-</span><span class="n">stamp</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">xmin</span><span class="p">))</span>
		<span class="k">assert</span><span class="p">(</span><span class="n">diam</span> <span class="o">&lt;=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stamp</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">ymax</span><span class="o">-</span><span class="n">stamp</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">ymin</span><span class="p">))</span>
		<span class="c1"># Aperture photometry</span>
		<span class="n">apers</span><span class="o">=</span> <span class="n">photutils</span><span class="o">.</span><span class="n">CircularAperture</span><span class="p">((</span><span class="n">stamp</span><span class="o">.</span><span class="n">trueCenter</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">stamp</span><span class="o">.</span><span class="n">trueCenter</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="n">r</span><span class="o">=</span><span class="n">diam</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
		<span class="n">apy_table</span> <span class="o">=</span> <span class="n">photutils</span><span class="o">.</span><span class="n">aperture_photometry</span><span class="p">(</span><span class="n">stamp</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">apers</span><span class="p">)</span>
		<span class="n">apflux</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">apy_table</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
		<span class="c1"># Incrase flux so input flux contained in aperture</span>
		<span class="n">flux</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;flux&#39;</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2.</span><span class="o">-</span><span class="n">apflux</span><span class="o">/</span><span class="n">stamp</span><span class="o">.</span><span class="n">added_flux</span><span class="p">)</span> <span class="c1"># [nanomaggies]</span>
		<span class="n">psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">localpsf</span><span class="o">.</span><span class="n">withFlux</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">stamp</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">localwcs</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;no_pixel&#39;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">stamp</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">localwcs</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;no_pixel&#39;</span><span class="p">,</span>\
								  <span class="n">nx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span><span class="p">,</span><span class="n">ny</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stamp_size</span><span class="p">)</span>
		<span class="c1"># stamp looses less than 0.01% of requested flux</span>
		<span class="k">if</span> <span class="n">stamp</span><span class="o">.</span><span class="n">added_flux</span><span class="o">/</span><span class="n">flux</span> <span class="o">&lt;=</span> <span class="mf">0.9999</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;stamp lost more than 0.01 percent of requested flux, stamp_flux/flux=</span><span class="si">%.7f</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">stamp</span><span class="o">.</span><span class="n">added_flux</span><span class="o">/</span><span class="n">flux</span><span class="p">)</span>
		<span class="c1"># test if obj[self.band+&#39;FLUX&#39;] really is in the 7&#39;&#39; aperture</span>
		<span class="c1">#apers= photutils.CircularAperture((stamp.trueCenter().x,stamp.trueCenter().y), r=diam/2)</span>
		<span class="c1">#apy_table = photutils.aperture_photometry(stamp.array, apers)</span>
		<span class="c1">#apflux= np.array(apy_table[&#39;aperture_sum&#39;])[0]</span>
		<span class="c1">#print(&quot;7&#39;&#39; flux/input flux= &quot;,apflux/obj[self.band+&#39;FLUX&#39;])</span>
		
		<span class="c1"># Convert stamp&#39;s center to its corresponding center on full tractor image</span>
		<span class="n">stamp</span><span class="o">.</span><span class="n">setCenter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypos</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">stamp</span> </div>

<div class="viewcode-block" id="BuildStamp.elg"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.BuildStamp.elg">[docs]</a>	<span class="k">def</span> <span class="nf">elg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Create an ELG (disk-like) galaxy.&quot;&quot;&quot;</span>
		<span class="c1"># Create localpsf object</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">setlocal</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
		<span class="n">objflux</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;flux&#39;</span><span class="p">)</span> <span class="c1"># [nanomaggies]</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">galobj</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">Sersic</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sersicn&#39;</span><span class="p">)),</span> <span class="n">half_light_radius</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rhalf&#39;</span><span class="p">)),</span>\
								<span class="n">flux</span><span class="o">=</span><span class="n">objflux</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gsparams</span><span class="p">)</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span> 
		<span class="n">galobj</span> <span class="o">=</span> <span class="n">galobj</span><span class="o">.</span><span class="n">shear</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ba&#39;</span><span class="p">)),</span> <span class="n">beta</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;phi&#39;</span><span class="p">))</span><span class="o">*</span><span class="n">galsim</span><span class="o">.</span><span class="n">degrees</span><span class="p">)</span>
		<span class="n">stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convolve_and_draw</span><span class="p">(</span><span class="n">galobj</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">stamp</span></div>

<div class="viewcode-block" id="BuildStamp.lrg"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.BuildStamp.lrg">[docs]</a>	<span class="k">def</span> <span class="nf">lrg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Create an LRG just like did for ELG&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">elg</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div>

<div class="viewcode-block" id="BuildStamp.qso"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.BuildStamp.qso">[docs]</a>	<span class="k">def</span> <span class="nf">qso</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Create a QSO just like a star&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div></div>


<span class="c1">#def no_overlapping_radec(ra,dec, bounds, random_state=None, dist=5.0/3600):</span>
<div class="viewcode-block" id="no_overlapping_radec"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.no_overlapping_radec">[docs]</a><span class="k">def</span> <span class="nf">no_overlapping_radec</span><span class="p">(</span><span class="n">Samp</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="mf">5.</span><span class="o">/</span><span class="mi">3600</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Returns indices of sources that are too close</span>

<span class="sd">	We do not inject sources if they are too close to another</span>
<span class="sd">		simulated source. They are skipped and injected in a </span>
<span class="sd">		later </span>

<span class="sd">	Args:</span>
<span class="sd">		Samp: fits_table for the properties of sources in the brick</span>
<span class="sd">			usually a subset of all sources in the brick determined by</span>
<span class="sd">			rowstart (rs)</span>
<span class="sd">		dist: arcsec, minimum separation simulated sources are allowed </span>
<span class="sd">			to have</span>

<span class="sd">	Returns:</span>
<span class="sd">		bool array, indices of simulated sources that are too close</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;decals_sim&#39;</span><span class="p">)</span>
    <span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="o">=</span> <span class="n">Samp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">),</span><span class="n">Samp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dec&#39;</span><span class="p">)</span>
    <span class="c1">#if random_state is None:</span>
    <span class="c1">#    random_state = np.random.RandomState()</span>
    <span class="c1"># ra,dec indices of just neighbors within &quot;dist&quot; away, just nerest neighbor of those</span>
    <span class="n">cat1</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>
    <span class="n">cat2</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>
    <span class="n">i2</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">d3d</span> <span class="o">=</span> <span class="n">cat1</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span><span class="n">cat2</span><span class="p">,</span><span class="n">nthneighbor</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># don&#39;t match to self</span>
    <span class="c1"># Cut to large separations</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d2d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dist</span> </div>

    <span class="c1">#cnt = 1</span>
    <span class="c1">##log.info(&quot;astrom: after iter=%d, have overlapping ra,dec %d/%d&quot;, cnt, len(m2),ra.shape[0])</span>
    <span class="c1">#log.info(&quot;Astrpy: after iter=%d, have overlapping ra,dec %d/%d&quot;, cnt, len(m2),ra.shape[0])</span>
    <span class="c1">#while len(m2) &gt; 0:</span>
    <span class="c1">#    ra[m2]= random_state.uniform(bounds[0], bounds[1], len(m2))</span>
    <span class="c1">#    dec[m2]= random_state.uniform(bounds[2], bounds[3], len(m2))</span>
    <span class="c1">#    # Any more matches? </span>
    <span class="c1">#    cat1 = SkyCoord(ra=ra*units.degree, dec=dec*units.degree)</span>
    <span class="c1">#    cat2 = SkyCoord(ra=ra*units.degree, dec=dec*units.degree)</span>
    <span class="c1">#    m2, d2d, d3d = cat1.match_to_catalog_sky(cat2,nthneighbor=2) # don&#39;t match to self</span>
    <span class="c1">#    b= np.array(d2d) &lt;= dist</span>
    <span class="c1">#    m2= np.array(m2)[b]</span>
    <span class="c1">#    #</span>
    <span class="c1">#    cnt += 1</span>
    <span class="c1">#    log.info(&quot;after iter=%d, have overlapping ra,dec %d/%d&quot;, cnt, len(m2),ra.shape[0])</span>
    <span class="c1">#    if cnt &gt; 30:</span>
    <span class="c1">#        log.error(&#39;Crash, could not get non-overlapping ra,dec in 30 iterations&#39;)</span>
    <span class="c1">#        raise ValueError</span>
    <span class="c1">#return ra, dec</span>

<span class="c1">#def build_simcat(nobj=None, brickname=None, brickwcs=None, meta=None, seed=None, noOverlap=True):</span>
<div class="viewcode-block" id="build_simcat"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.build_simcat">[docs]</a><span class="k">def</span> <span class="nf">build_simcat</span><span class="p">(</span><span class="n">Samp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">brickwcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates the simulated source catalog for a given brick (not CCD).</span>

<span class="sd">	The WCS for the brick (not CCD) is used to convert ra,dec of source</span>
<span class="sd">		to x,y pixel location in brickspace</span>

<span class="sd">	Args:</span>
<span class="sd">		Samp: fits_table for the properties of sources in the brick</span>
<span class="sd">			usually a subset of all sources in the brick determined by</span>
<span class="sd">			rowstart (rs)</span>
<span class="sd">		brickwcs: WCS object for the brick</span>
<span class="sd">		meta: &#39;metacat&#39; table </span>
<span class="sd">			fits_table with configuration-like params for the simulated sources</span>

<span class="sd">	Returns: </span>
<span class="sd">		tuple of</span>
<span class="sd">		cat:</span>
<span class="sd">		skipping_ids:</span>
<span class="sd">	&quot;&quot;&quot;</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;decals_sim&#39;</span><span class="p">)</span>

    <span class="c1">#rand = np.random.RandomState(seed)</span>

    <span class="c1"># Assign central coordinates uniformly but remove simulated sources which</span>
    <span class="c1"># are too near to one another.  Iterate until we have the requisite number</span>
    <span class="c1"># of objects.</span>
    <span class="c1">#bounds = brickwcs.radec_bounds()</span>
    <span class="c1">#ra = rand.uniform(bounds[0], bounds[1], nobj)</span>
    <span class="c1">#dec = rand.uniform(bounds[2], bounds[3], nobj)</span>
    <span class="c1">#if noOverlap:</span>
        <span class="c1">#ra, dec= no_overlapping_radec(ra,dec, bounds,</span>
        <span class="c1">#                              random_state=rand,</span>
        <span class="c1">#                              dist=5./3600)</span>
    <span class="c1"># Cut to ra,dec that are sufficiently separated (&gt; 5&#39;&#39; away from each other)</span>
    <span class="n">I</span><span class="o">=</span> <span class="n">no_overlapping_radec</span><span class="p">(</span><span class="n">Samp</span><span class="p">,</span><span class="n">dist</span><span class="o">=</span><span class="mf">5.</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span>
    <span class="n">skipping_ids</span><span class="o">=</span> <span class="n">Samp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)[</span><span class="n">I</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
    <span class="n">Samp</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
    
    <span class="n">xxyy</span> <span class="o">=</span> <span class="n">brickwcs</span><span class="o">.</span><span class="n">radec2pixelxy</span><span class="p">(</span><span class="n">Samp</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span><span class="n">Samp</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>

    <span class="c1">#cat = Table()</span>
    <span class="c1">#cat[&#39;ID&#39;] = Column(Samp.get(&#39;id&#39;),dtype=&#39;i4&#39;) #np.arange(nobj, dtype=&#39;i4&#39;))</span>
    <span class="c1">#cat[&#39;RA&#39;] = Column(Samp.ra, dtype=&#39;f8&#39;)</span>
    <span class="c1">#cat[&#39;DEC&#39;] = Column(Samp.dec, dtype=&#39;f8&#39;)</span>
    <span class="c1">#cat[&#39;X&#39;] = Column(xxyy[1][:], dtype=&#39;f4&#39;)</span>
    <span class="c1">#cat[&#39;Y&#39;] = Column(xxyy[2][:], dtype=&#39;f4&#39;)</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">fits_table</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;seed&#39;</span><span class="p">,</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span><span class="s1">&#39;dec&#39;</span><span class="p">]:</span>
        <span class="n">cat</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Samp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="n">cat</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">xxyy</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])</span>
    <span class="n">cat</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">xxyy</span><span class="p">[</span><span class="mi">2</span><span class="p">][:])</span>

    <span class="n">typ</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;objtype&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Mags</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">bright_galaxies</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">typ</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;elg&#39;</span><span class="p">,</span><span class="s1">&#39;lrg&#39;</span><span class="p">]):</span>
            <span class="c1"># Galaxies get stellar flux, so they are easy to see in images</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">flux&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">,</span> <span class="mf">1E9</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.4</span><span class="o">*</span><span class="n">Samp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;star&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">)))</span> <span class="p">)</span> <span class="c1"># [nanomaggies]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Actual galaxy colors</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">flux&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">,</span> <span class="mf">1E9</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.4</span><span class="o">*</span><span class="n">Samp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span><span class="n">key</span><span class="p">)))</span> <span class="p">)</span> <span class="c1"># [nanomaggies]</span>
        <span class="c1"># Galaxy Properties</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;elg&#39;</span><span class="p">,</span><span class="s1">&#39;lrg&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">tab_key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;sersicn&#39;</span><span class="p">,</span><span class="s1">&#39;rhalf&#39;</span><span class="p">,</span><span class="s1">&#39;ba&#39;</span><span class="p">,</span><span class="s1">&#39;phi&#39;</span><span class="p">],[</span><span class="s1">&#39;n&#39;</span><span class="p">,</span><span class="s1">&#39;re&#39;</span><span class="p">,</span><span class="s1">&#39;ba&#39;</span><span class="p">,</span><span class="s1">&#39;pa&#39;</span><span class="p">]):</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Samp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span><span class="n">tab_key</span><span class="p">)</span> <span class="p">))</span>
        <span class="c1"># Sersic n: GALSIM n = [0.3,6.2] for numerical stability,see</span>
        <span class="c1"># https://github.com/GalSim-developers/GalSim/issues/{325,450}</span>
        <span class="c1"># I&#39;ll use [0.4,6.1]</span>
        <span class="n">vals</span><span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">sersicn</span>
        <span class="n">vals</span><span class="p">[</span><span class="n">cat</span><span class="o">.</span><span class="n">sersicn</span> <span class="o">&lt;</span> <span class="mf">0.4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.4</span>
        <span class="n">vals</span><span class="p">[</span><span class="n">cat</span><span class="o">.</span><span class="n">sersicn</span> <span class="o">&gt;</span> <span class="mf">6.1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">6.1</span>
        <span class="n">cat</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;sersicn&#39;</span><span class="p">,</span><span class="n">vals</span><span class="p">)</span>
        <span class="c1">#cat[&#39;R50_1&#39;] = Column(Samp.rhalf, dtype=&#39;f4&#39;)</span>
        <span class="c1">#cat[&#39;BA_1&#39;] = Column(Samp.ba, dtype=&#39;f4&#39;)</span>
        <span class="c1">#cat[&#39;PHI_1&#39;] = Column(Samp.phi, dtype=&#39;f4&#39;)</span>
    <span class="k">return</span> <span class="n">cat</span><span class="p">,</span> <span class="n">skipping_ids</span></div>



<div class="viewcode-block" id="get_parser"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.get_parser">[docs]</a><span class="k">def</span> <span class="nf">get_parser</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;return parser object, tells it what options to look for</span>
<span class="sd">    options can come from a list of strings or command line&#39;&#39;&#39;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span>
                                     <span class="n">ArgumentDefaultsHelpFormatter</span><span class="p">,</span>
                                     <span class="n">description</span><span class="o">=</span><span class="s1">&#39;DECaLS simulations.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--objtype&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;star&#39;</span><span class="p">,</span><span class="s1">&#39;elg&#39;</span><span class="p">,</span> <span class="s1">&#39;lrg&#39;</span><span class="p">,</span> <span class="s1">&#39;qso&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;star&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;--brick&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;2428p117&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--DR&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;--nobj&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of objects to simulate (required input)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-rs&#39;</span><span class="p">,</span> <span class="s1">&#39;--rowstart&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;zero indexed, row of ra,dec,mags table, after it is cut to brick, to start on&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--prefix&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;tells which input sample to use&#39;</span><span class="p">)</span>
    <span class="c1">#parser.add_argument(&#39;-ic&#39;, &#39;--ith_chunk&#39;, type=long, default=None, metavar=&#39;&#39;, </span>
    <span class="c1">#                    help=&#39;run the ith chunk, 0-999&#39;)</span>
    <span class="c1">#parser.add_argument(&#39;-c&#39;, &#39;--nchunk&#39;, type=long, default=1, metavar=&#39;&#39;, </span>
    <span class="c1">#                    help=&#39;run chunks 0 to nchunk&#39;)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--threads&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of threads to use when calling The Tractor&#39;</span><span class="p">)</span>
    <span class="c1">#parser.add_argument(&#39;-s&#39;, &#39;--seed&#39;, type=long, default=None, metavar=&#39;&#39;, </span>
    <span class="c1">#                    help=&#39;random number seed, determines chunk seeds 0-999&#39;)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-z&#39;</span><span class="p">,</span> <span class="s1">&#39;--zoom&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3600</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;see runbrick.py; (default is 0 3600 0 3600)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-survey-dir&#39;</span><span class="p">,</span> <span class="s1">&#39;--survey_dir&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Location of survey-ccds*.fits.gz&#39;</span><span class="p">)</span>
    <span class="c1">#parser.add_argument(&#39;--rmag-range&#39;, nargs=2, type=float, default=(18, 26), metavar=&#39;&#39;, </span>
    <span class="c1">#                    help=&#39;r-band magnitude range&#39;)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--add_sim_noise&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;set to add noise to simulated sources&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--folding_threshold&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mf">1.e-5</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;for galsim.GSParams&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-testA&#39;</span><span class="p">,</span><span class="s1">&#39;--image_eq_model&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;set to set image,inverr by model only (ignore real image,invvar)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--all-blobs&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Process all the blobs, not just those that contain simulated sources.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--stage&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tims&#39;</span><span class="p">,</span> <span class="s1">&#39;image_coadds&#39;</span><span class="p">,</span> <span class="s1">&#39;srcs&#39;</span><span class="p">,</span> <span class="s1">&#39;fitblobs&#39;</span><span class="p">,</span> <span class="s1">&#39;coadds&#39;</span><span class="p">],</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run up to the given stage&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--early_coadds&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;add this option to make the JPGs before detection/model fitting&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cutouts&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Stop after stage tims and save .npy cutouts of every simulated source&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--stamp_size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>\
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Stamp/Cutout size in pixels&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--bright_galaxies&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Galaxies get stellar colors for DEEP Obiwan training&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--bricklist&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;bricks-eboss-ngc.txt&#39;</span><span class="p">,</span>\
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;if using mpi4py, $LEGACY_SURVEY_DIR/bricklist&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--nproc&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>\
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;if using mpi4py&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;toggle on verbose output&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span></div>
 
<div class="viewcode-block" id="create_metadata"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.create_metadata">[docs]</a><span class="k">def</span> <span class="nf">create_metadata</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;fits_table with configuration-like params for the simulated sources</span>
<span class="sd">    </span>
<span class="sd">    TODO: Should metacat table have a rowstart column?</span>
<span class="sd">    TODO: One metacat table per brick, instead of one per `rs*` directory?</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">      kwargs: configuration-like params for the simulated sources</span>
<span class="sd">        {&#39;brickname&#39;: which chunk of sky</span>
<span class="sd">        &#39;objtype&#39;: star,elg,lrg,qso</span>
<span class="sd">        &#39;nobj&#39;: number of simulated sources for this run</span>
<span class="sd">        &#39;stamp_size&#39;: pixels, width and height of simulated images</span>
<span class="sd">        &#39;cutouts&#39;: whether .npy cutouts of every simulated source were written</span>
<span class="sd">        &#39;bright_galaxies&#39;: whether bright_galaxies flag is set</span>
<span class="sd">        }</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">      Nothing</span>
<span class="sd">      writes the &#39;metacat&#39; fits_table to disk and stores it</span>
<span class="sd">      in the kwargs input arg</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;decals_sim&#39;</span><span class="p">)</span>
    <span class="c1"># Pack the input parameters into a meta-data table and write out.</span>
    <span class="c1">#metacols = [</span>
    <span class="c1">#    (&#39;BRICKNAME&#39;, &#39;S10&#39;),</span>
    <span class="c1">#    (&#39;OBJTYPE&#39;, &#39;S10&#39;),</span>
    <span class="c1">#    (&#39;NOBJ&#39;, &#39;i4&#39;),</span>
    <span class="c1">#    (&#39;CHUNKSIZE&#39;, &#39;i2&#39;),</span>
    <span class="c1">#    (&#39;NCHUNK&#39;, &#39;i2&#39;),</span>
    <span class="c1">#    (&#39;ZOOM&#39;, &#39;i4&#39;, (4,)),</span>
    <span class="c1">#    (&#39;SEED&#39;, &#39;S20&#39;),</span>
    <span class="c1">#    (&#39;RMAG_RANGE&#39;, &#39;f4&#39;, (2,))]</span>
    <span class="c1">#metacat = Table(np.zeros(1, dtype=metacols))</span>
    <span class="n">metacat</span> <span class="o">=</span> <span class="n">fits_table</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;brickname&#39;</span><span class="p">,</span><span class="s1">&#39;objtype&#39;</span><span class="p">]:</span> <span class="c1">#,&#39;nchunk&#39;]:</span>
	<span class="n">metacat</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="p">))</span>
	<span class="n">metacat</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;nobj&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nobj</span><span class="p">]</span> <span class="p">))</span>
	<span class="n">metacat</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;zoom&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">zoom</span><span class="p">]</span> <span class="p">))</span>
	<span class="n">metacat</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;cutouts&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cutouts</span><span class="p">]</span> <span class="p">))</span>
	<span class="n">metacat</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;stamp_size&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stamp_size</span><span class="p">]</span> <span class="p">))</span>
	<span class="n">metacat</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;bright_galaxies&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bright_galaxies</span><span class="p">]</span> <span class="p">))</span>
	<span class="c1">#metacat[&#39;RMAG_RANGE&#39;] = kwargs[&#39;args&#39;].rmag_range</span>
	<span class="c1">#if not kwargs[&#39;args&#39;].seed:</span>
	<span class="c1">#    log.info(&#39;Random seed = {}&#39;.format(kwargs[&#39;args&#39;].seed))</span>
	<span class="c1">#    metacat[&#39;SEED&#39;] = kwargs[&#39;args&#39;].seed</span>
    <span class="c1">#metacat_dir = os.path.join(kwargs[&#39;decals_sim_dir&#39;], kwargs[&#39;objtype&#39;],kwargs[&#39;brickname&#39;][:3],kwargs[&#39;brickname&#39;])    </span>
    <span class="n">metacat_dir</span> <span class="o">=</span> <span class="n">get_savedir</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metacat_dir</span><span class="p">):</span> 
	<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">metacat_dir</span><span class="p">)</span>
    
    <span class="n">metafile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metacat_dir</span><span class="p">,</span> <span class="s1">&#39;metacat&#39;</span><span class="o">+</span><span class="n">get_fnsuffix</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metafile</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metafile</span><span class="p">):</span>
	<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metafile</span><span class="p">)</span>
    <span class="n">metacat</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">metafile</span><span class="p">)</span>
    
    <span class="c1"># Store new stuff</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;metacat&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">metacat</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;metacat_dir&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">metacat_dir</span></div>


<div class="viewcode-block" id="create_ith_simcat"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.create_ith_simcat">[docs]</a><span class="k">def</span> <span class="nf">create_ith_simcat</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;Write &#39;simcat&#39; and &#39;skipped_ids&#39; tables for a given sample of sources</span>

<span class="sd">        Args:</span>
<span class="sd">          d: {&#39;Samp&#39;: fits_table for the properties of sources in the brick</span>
<span class="sd">	     &#39;brickwcs&#39;: WCS object for the brick</span>
<span class="sd">	     &#39;metacat&#39;: fits_table with configuration params for the simulated sources</span>
<span class="sd">             }</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">	  Nothing, saves the &#39;simcat&#39; and &#39;skipped_ids&#39; tables</span>
<span class="sd">	  Adds &#39;simcat&#39; table to dict &#39;d&#39;</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">assert</span><span class="p">(</span><span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
	<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;decals_sim&#39;</span><span class="p">)</span>
	<span class="c1">#chunksuffix = &#39;{:02d}&#39;.format(ith_chunk)</span>
	<span class="c1"># Build and write out the simulated object catalog.</span>
	<span class="c1">#seed= d[&#39;seeds&#39;][ith_chunk]</span>
	<span class="c1">#simcat = build_simcat(d[&#39;nobj&#39;], d[&#39;brickname&#39;], d[&#39;brickwcs&#39;], d[&#39;metacat&#39;], seed)</span>
	<span class="n">simcat</span><span class="p">,</span> <span class="n">skipped_ids</span> <span class="o">=</span> <span class="n">build_simcat</span><span class="p">(</span><span class="n">Samp</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;Samp&#39;</span><span class="p">],</span><span class="n">brickwcs</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;brickwcs&#39;</span><span class="p">],</span><span class="n">meta</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;metacat&#39;</span><span class="p">])</span>
	<span class="c1"># Simcat </span>
	<span class="n">simcat_dir</span> <span class="o">=</span> <span class="n">get_savedir</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span> <span class="c1">#os.path.join(d[&#39;metacat_dir&#39;],&#39;row%d-%d&#39; % (rowstart,rowend)) #&#39;%3.3d&#39; % ith_chunk)    </span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">simcat_dir</span><span class="p">):</span> 
		<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">simcat_dir</span><span class="p">)</span>
	<span class="c1">#simcatfile = os.path.join(simcat_dir, &#39;simcat-{}-{}-row{}-{}.fits&#39;.format(d[&#39;brickname&#39;], d[&#39;objtype&#39;],rowstart,rowend)) # chunksuffix))</span>
	<span class="n">simcatfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">simcat_dir</span><span class="p">,</span> <span class="s1">&#39;simcat&#39;</span><span class="o">+</span><span class="n">get_fnsuffix</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">))</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">simcatfile</span><span class="p">):</span>
		<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">simcatfile</span><span class="p">)</span>
	<span class="n">simcat</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">simcatfile</span><span class="p">)</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Wrote </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simcatfile</span><span class="p">))</span>
	<span class="c1"># Skipped Ids</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">skipped_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
		<span class="n">skip_table</span><span class="o">=</span> <span class="n">fits_table</span><span class="p">()</span>
		<span class="n">skip_table</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;ids&#39;</span><span class="p">,</span><span class="n">skipped_ids</span><span class="p">)</span>
		<span class="n">name</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">simcat_dir</span><span class="p">,</span><span class="s1">&#39;skippedids&#39;</span><span class="o">+</span><span class="n">get_fnsuffix</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
			<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
		<span class="n">skip_table</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Wrote </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
	<span class="c1"># add to dict</span>
	<span class="n">d</span><span class="p">[</span><span class="s1">&#39;simcat&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">simcat</span>
	<span class="n">d</span><span class="p">[</span><span class="s1">&#39;simcat_dir&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">simcat_dir</span></div>

<div class="viewcode-block" id="get_runbrick_setup"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.get_runbrick_setup">[docs]</a><span class="k">def</span> <span class="nf">get_runbrick_setup</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert runbrick.py cmd line options into `**kwargs` for run_brick()</span>
<span class="sd">    </span>
<span class="sd">    The command line options depend on the Data Release (e.g. the</span>
<span class="sd">      legacypipe code version. The cmd line options associated with </span>
<span class="sd">      each DR get modified and repackaged into a dict in </span>
<span class="sd">      legacypipe.runbrick so this converter is required to call run_brick</span>
<span class="sd">      appropriately</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">      **kwargs: dict of the cmd line options to obiwan.kenobi.py</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">      dict to use when calling legacypipe.runbrick.run_brick like</span>
<span class="sd">        run_brick(brickname, survey, `**dict`)		</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DR</span><span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;DR&#39;</span><span class="p">]</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">DR</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
    <span class="kn">from</span> <span class="nn">legacypipe.runbrick</span> <span class="k">import</span> <span class="n">get_runbrick_kwargs</span>
    <span class="kn">from</span> <span class="nn">legacypipe.runbrick</span> <span class="k">import</span> <span class="n">get_parser</span> <span class="k">as</span> <span class="n">get_runbrick_parser</span>
    <span class="n">zm</span><span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;zoom&#39;</span><span class="p">]</span>
    <span class="n">cmd_line</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;--no-write&#39;</span><span class="p">,</span> <span class="s1">&#39;--skip&#39;</span><span class="p">,</span><span class="s1">&#39;--force-all&#39;</span><span class="p">,</span>
	       <span class="s1">&#39;--zoom&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">zm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">zm</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">zm</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">zm</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	       <span class="s1">&#39;--no-wise&#39;</span><span class="p">,</span> <span class="s1">&#39;--threads&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;threads&#39;</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;early_coadds&#39;</span><span class="p">]:</span>
	<span class="n">cmd_line</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;--early-coadds&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;stage&#39;</span><span class="p">]:</span>
	<span class="n">cmd_line</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;--stage&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;stage&#39;</span><span class="p">]]</span>
    <span class="c1"># Data-Release specific</span>
    <span class="k">if</span> <span class="n">DR</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
	<span class="n">cmd_line</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;--run&#39;</span><span class="p">,</span> <span class="s1">&#39;dr3&#39;</span><span class="p">,</span> <span class="s1">&#39;--hybrid-psf&#39;</span><span class="p">,</span><span class="s1">&#39;--nsigma&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">DR</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
	<span class="n">cmd_line</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;--run&#39;</span><span class="p">,</span> <span class="s1">&#39;dr4v2&#39;</span><span class="p">,</span> <span class="s1">&#39;--hybrid-psf&#39;</span><span class="p">,</span><span class="s1">&#39;--nsigma&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">DR</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
	<span class="c1"># defaults: rex (use --simp), nsigma 6 ,hybrid-psf (--no-hybrid-psf otherwise)</span>
	<span class="c1"># depth cut already done (use --depth-cut to do depth cut anyway)</span>
	<span class="n">cmd_line</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;--run&#39;</span><span class="p">,</span> <span class="s1">&#39;dr5&#39;</span><span class="p">]</span> 
    
    <span class="n">rb_parser</span><span class="o">=</span> <span class="n">get_runbrick_parser</span><span class="p">()</span>
    <span class="n">rb_opt</span> <span class="o">=</span> <span class="n">rb_parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">cmd_line</span><span class="p">)</span>
    <span class="n">rb_optdict</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">rb_opt</span><span class="p">)</span>
    <span class="c1"># remove keys as Dustin&#39; does</span>
    <span class="n">_</span><span class="o">=</span> <span class="n">rb_optdict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ps&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">_</span><span class="o">=</span> <span class="n">rb_optdict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">rb_kwargs</span><span class="o">=</span> <span class="n">get_runbrick_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">rb_optdict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rb_kwargs</span></div>

<div class="viewcode-block" id="do_one_chunk"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.do_one_chunk">[docs]</a><span class="k">def</span> <span class="nf">do_one_chunk</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs the legacypipe/Tractor pipeline on images with simulated sources</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">      d: {&#39;args&#39;: obiwan.kenobi.py cmd line argparse.Namespace object</span>
<span class="sd">          &#39;brickname&#39;: chunk of sky</span>
<span class="sd">          &#39;metacat&#39;: fits_table	configuration params for the simulated sources</span>
<span class="sd">          &#39;simcat&#39;: fits_table simulated source catalog for a given brick (not CCD).</span>
<span class="sd">    </span>
<span class="sd">    Note:</span>
<span class="sd">      runb_brick() is &#39;main&#39; for the legacypipe/Tractor pipeline</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">      Nothing, but this func end ups writing out all the obiwan results </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">simdecals</span> <span class="o">=</span> <span class="n">SimDecals</span><span class="p">(</span><span class="n">DR</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">DR</span><span class="p">,</span>\
			  <span class="n">metacat</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;metacat&#39;</span><span class="p">],</span> <span class="n">simcat</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;simcat&#39;</span><span class="p">],</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;simcat_dir&#39;</span><span class="p">],</span> \
			  <span class="n">add_sim_noise</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_sim_noise</span><span class="p">,</span> <span class="n">folding_threshold</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">folding_threshold</span><span class="p">,</span>\
			  <span class="n">image_eq_model</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">image_eq_model</span><span class="p">)</span>
    <span class="c1"># Use Tractor to just process the blobs containing the simulated sources.</span>
    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">all_blobs</span><span class="p">:</span>
	<span class="n">blobxy</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
	<span class="n">blobxy</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;simcat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">),</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;simcat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">))</span>
    
    <span class="c1"># Default runbrick call sequence</span>
    <span class="n">obiwan_kwargs</span><span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">])</span> 
    <span class="n">runbrick_kwargs</span><span class="o">=</span> <span class="n">get_runbrick_setup</span><span class="p">(</span><span class="o">**</span><span class="n">obiwan_kwargs</span><span class="p">)</span>
    <span class="c1"># Obiwan modifications</span>
    <span class="n">runbrick_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">blobxy</span><span class="o">=</span><span class="n">blobxy</span><span class="p">)</span>
    <span class="c1">#plotbase=&#39;obiwan&#39;)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calling run_brick with: &#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;brickname= </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;brickname&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;simdecals= &#39;</span><span class="p">,</span><span class="n">simdecals</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;runbrick_kwards= &#39;</span><span class="p">,</span><span class="n">runbrick_kwargs</span><span class="p">)</span>
    <span class="c1"># Run it: run_brick(brick, survey obj, **kwargs)</span>
    <span class="n">run_brick</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;brickname&#39;</span><span class="p">],</span> <span class="n">simdecals</span><span class="p">,</span> <span class="o">**</span><span class="n">runbrick_kwargs</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">dobash</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;UNIX cmd: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ValueError</span>

<div class="viewcode-block" id="do_ith_cleanup"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.do_ith_cleanup">[docs]</a><span class="k">def</span> <span class="nf">do_ith_cleanup</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Moves all obiwan+legacypipe outputs to a new directory stucture</span>

<span class="sd">    Uses rsync to move everthing, if all the rsync&#39;s succeed then all the </span>
<span class="sd">        original files and directories are removed </span>

<span class="sd">    Args:</span>
<span class="sd">        d: dict with keys brickname, simcat_dir</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> 
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;decals_sim&#39;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cleaning up...&#39;</span><span class="p">)</span>
    <span class="n">brick</span><span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;brickname&#39;</span><span class="p">]</span>
    <span class="n">bri</span><span class="o">=</span> <span class="n">brick</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">outdir</span><span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;simcat_dir&#39;</span><span class="p">]</span>
    <span class="c1"># coadd/123/1238p245/* -&gt; coadd/</span>
    <span class="c1"># metrics/123/* -&gt; metrics/</span>
    <span class="c1"># tractor/123/* -&gt; tractor/</span>
    <span class="c1"># tractor-i/123/* -&gt; tractor-i/</span>
    <span class="c1"># *.fits -&gt; obiwan/</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dobash</span><span class="p">(</span><span class="s1">&#39;rsync -av </span><span class="si">%s</span><span class="s1">/coadd/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/* </span><span class="si">%s</span><span class="s1">/coadd/&#39;</span> <span class="o">%</span> 
                <span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">bri</span><span class="p">,</span><span class="n">brick</span><span class="p">,</span> <span class="n">outdir</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">,</span><span class="s1">&#39;tractor&#39;</span><span class="p">,</span><span class="s1">&#39;tractor-i&#39;</span><span class="p">]:</span>
            <span class="n">dobash</span><span class="p">(</span><span class="s1">&#39;rsync -av </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/* </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/&#39;</span> <span class="o">%</span> 
                    <span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">bri</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span><span class="n">name</span><span class="p">))</span>
        <span class="n">dobash</span><span class="p">(</span><span class="s1">&#39;mkdir -p </span><span class="si">%s</span><span class="s1">/obiwan&#39;</span> <span class="o">%</span> <span class="n">outdir</span><span class="p">)</span>
        <span class="n">dobash</span><span class="p">(</span><span class="s1">&#39;rsync -av </span><span class="si">%s</span><span class="s1">/*.fits </span><span class="si">%s</span><span class="s1">/obiwan/&#39;</span> <span class="o">%</span> 
                <span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">outdir</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;issue repackaging </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">output_dir</span><span class="p">)</span>

    <span class="c1"># If here, then safe to remove originals</span>
    <span class="n">dobash</span><span class="p">(</span><span class="s1">&#39;rm -r </span><span class="si">%s</span><span class="s1">/coadd/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">bri</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">,</span><span class="s1">&#39;tractor&#39;</span><span class="p">,</span><span class="s1">&#39;tractor-i&#39;</span><span class="p">]:</span>
        <span class="n">dobash</span><span class="p">(</span><span class="s1">&#39;rm -r </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">bri</span><span class="p">))</span>
    <span class="n">dobash</span><span class="p">(</span><span class="s1">&#39;rm </span><span class="si">%s</span><span class="s1">/*.fits&#39;</span> <span class="o">%</span> <span class="n">outdir</span><span class="p">)</span>
    <span class="c1"># Only &quot;rowstars 0&quot; keeps its coadds</span>
    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;rowst&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dobash</span><span class="p">(</span><span class="s1">&#39;rm </span><span class="si">%s</span><span class="s1">/coadd/*.fits.fz&#39;</span> <span class="o">%</span> <span class="n">outdir</span><span class="p">)</span>
        <span class="n">dobash</span><span class="p">(</span><span class="s1">&#39;rm </span><span class="si">%s</span><span class="s1">/coadd/*.fits&#39;</span> <span class="o">%</span> <span class="n">outdir</span><span class="p">)</span></div>
        


<span class="k">def</span> <span class="nf">get_sample_fn</span><span class="p">(</span><span class="n">brick</span><span class="p">,</span><span class="n">decals_sim_dir</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="n">fn</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decals_sim_dir</span><span class="p">,</span><span class="s1">&#39;input_sample&#39;</span><span class="p">,</span><span class="s1">&#39;bybrick&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">sample_</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">brick</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">fn</span>
    <span class="c1">#return os.path.join(decals_sim_dir,&#39;softlinked_table&#39;) #&#39;sample-merged.fits&#39;)</span>

<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../index.html#obiwan.kenobi.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Main routine which parses the optional inputs.&quot;&quot;&quot;</span>
    <span class="n">t0</span><span class="o">=</span> <span class="n">Time</span><span class="p">()</span>
    <span class="c1"># Command line options</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Read from cmd line</span>
        <span class="n">parser</span><span class="o">=</span> <span class="n">get_parser</span><span class="p">()</span>  
        <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># args is already a argparse.Namespace obj</span>
        <span class="k">pass</span> 
    <span class="c1"># Print calling sequence</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Args:&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>   
 
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cutouts</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="s1">&#39;tims&#39;</span>
    <span class="c1"># Setup loggers</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">lvl</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lvl</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">lvl</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span> <span class="c1">#,format=&#39;%(message)s&#39;)</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;decals_sim&#39;</span><span class="p">)</span>
    <span class="c1"># Sort through args </span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;decals_sim.py args=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="c1">#max_nobj=500</span>
    <span class="c1">#max_nchunk=1000</span>
    <span class="c1">#if args.ith_chunk is not None: assert(args.ith_chunk &lt;= max_nchunk-1)</span>
    <span class="c1">#assert(args.nchunk &lt;= max_nchunk)</span>
    <span class="c1">#assert(args.nobj &lt;= max_nobj)</span>
    <span class="c1">#if args.ith_chunk is not None: </span>
    <span class="c1">#    assert(args.nchunk == 1) #if choose a chunk, only doing 1 chunk</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">brickname</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">brick</span>
    <span class="n">objtype</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">objtype</span>
    <span class="n">maxobjs</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">nobj</span>

    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;LSB&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">objtype</span> <span class="o">==</span> <span class="n">obj</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> objtype not yet supported!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objtype</span><span class="p">))</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="c1"># Output dir</span>
    <span class="k">if</span> <span class="s1">&#39;DECALS_SIM_DIR&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">decals_sim_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DECALS_SIM_DIR&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">decals_sim_dir</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
        
    <span class="c1">#nchunk = args.nchunk</span>
    <span class="c1">#rand = np.random.RandomState(args.seed) # determines seed for all chunks</span>
    <span class="c1">#seeds = rand.random_integers(0,2**18, max_nchunk)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Object type = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objtype</span><span class="p">))</span>
    <span class="c1">#log.info(&#39;Number of objects = {}&#39;.format(nobj))</span>
    <span class="c1">#log.info(&#39;Number of chunks = {}&#39;.format(nchunk))</span>

    <span class="c1"># Optionally zoom into a portion of the brick</span>
    <span class="n">survey</span> <span class="o">=</span> <span class="n">LegacySurveyData</span><span class="p">()</span>
    <span class="n">brickinfo</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">get_brick_by_name</span><span class="p">(</span><span class="n">brickname</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">brickname</span><span class="p">)</span>
    <span class="n">brickwcs</span> <span class="o">=</span> <span class="n">wcs_for_brick</span><span class="p">(</span><span class="n">brickinfo</span><span class="p">)</span>
    <span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">pixscale</span> <span class="o">=</span> <span class="n">brickwcs</span><span class="o">.</span><span class="n">get_width</span><span class="p">(),</span> <span class="n">brickwcs</span><span class="o">.</span><span class="n">get_height</span><span class="p">(),</span> <span class="n">brickwcs</span><span class="o">.</span><span class="n">pixel_scale</span><span class="p">()</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Brick = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">brickname</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">zoom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># See also runbrick.stage_tims()</span>
        <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">zoom</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span>
        <span class="n">brickwcs</span> <span class="o">=</span> <span class="n">brickwcs</span><span class="o">.</span><span class="n">get_subimage</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Zoom (pixel boundaries) = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">zoom</span><span class="p">))</span>
    <span class="n">targetrd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">brickwcs</span><span class="o">.</span><span class="n">pixelxy2radec</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span>
                         <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="n">H</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">H</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]])</span>

    <span class="n">radec_center</span> <span class="o">=</span> <span class="n">brickwcs</span><span class="o">.</span><span class="n">radec_center</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;RA, Dec center = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">radec_center</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Brick = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">brickname</span><span class="p">))</span>
    <span class="n">t0</span><span class="o">=</span> <span class="n">ptime</span><span class="p">(</span><span class="s1">&#39;First part of Main()&#39;</span><span class="p">,</span><span class="n">t0</span><span class="p">)</span>
    
    <span class="c1">#if args.ith_chunk is not None: </span>
    <span class="c1">#    chunk_list= [args.ith_chunk]</span>
    <span class="c1">#else: </span>
    <span class="c1">#    chunk_list= range(nchunk)</span>
    <span class="c1">#chunk_list= [ int((args.rowstart)/maxobjs) ]</span>

    <span class="c1"># Ra,dec,mag table</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;before PSQL&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Non PSQL way</span>
        <span class="c1">#fn= get_sample_fn(brickname,decals_sim_dir,prefix=args.prefix)</span>
        <span class="n">fn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DECALS_SIM_DIR&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;elg_randoms/rank_1_seed_1.fits&#39;</span><span class="p">)</span> 
        <span class="n">Samp</span><span class="o">=</span> <span class="n">fits_table</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">Samp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_rhalf&#39;</span> <span class="o">%</span> <span class="n">objtype</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_re&#39;</span> <span class="o">%</span> <span class="n">objtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Samp</span><span class="o">=</span> <span class="n">getSrcsInBrick</span><span class="p">(</span><span class="n">brickname</span><span class="p">,</span><span class="n">objtype</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after PSQL&#39;</span><span class="p">)</span> 
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> samples, for brick </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Samp</span><span class="p">),</span><span class="n">brickname</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First 2 sources have: &#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sam</span> <span class="ow">in</span> <span class="n">Samp</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ra=</span><span class="si">%f</span><span class="s1">, dec=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sam</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span><span class="n">sam</span><span class="o">.</span><span class="n">dec</span><span class="p">))</span>
    <span class="c1"># Already did these cuts in decals_sim_radeccolors </span>
    <span class="c1">#r0,r1,d0,d1= brickwcs.radec_bounds()</span>
    <span class="c1">#Samp.cut( (Samp.ra &gt;= r0)*(Samp.ra &lt;= r1)*\</span>
    <span class="c1">#          (Samp.dec &gt;= d0)*(Samp.dec &lt;= d1) )</span>
    <span class="c1"># Sort by Sersic n low -&gt; high (if elg or lrg)</span>
    <span class="k">if</span> <span class="n">objtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;elg&#39;</span><span class="p">,</span><span class="s1">&#39;lrg&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cutouts</span><span class="p">:</span>
            <span class="c1"># rhalf ~ 1-2&#39;&#39; at z ~ 1, n~1 </span>
            <span class="c1">#Samp=Samp[ (Samp.get(&#39;%s_re&#39; % objtype) &lt;= 10.)*\</span>
            <span class="c1">#           (Samp.get(&#39;%s_n&#39; % objtype) &lt;= 2.) ]</span>
            <span class="n">Samp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_re&#39;</span> <span class="o">%</span> <span class="n">objtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">Samp</span><span class="p">)))</span>
            <span class="n">Samp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_n&#39;</span> <span class="o">%</span> <span class="n">objtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">Samp</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Usual obiwan</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sorting by sersic n&#39;</span><span class="p">)</span>
            <span class="n">Samp</span><span class="o">=</span><span class="n">Samp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span> <span class="n">Samp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_n&#39;</span> <span class="o">%</span> <span class="n">objtype</span><span class="p">)</span> <span class="p">)]</span>
        <span class="c1">#    # Dont sort by sersic n for deeplearning cutouts</span>
        <span class="c1">#    print(&#39;NOT sorting by sersic n&#39;)</span>
        <span class="c1">#else:</span>
    <span class="n">rowst</span><span class="p">,</span><span class="n">rowend</span><span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">rowstart</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">rowstart</span><span class="o">+</span><span class="n">maxobjs</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cutouts</span><span class="p">:</span>
        <span class="c1"># Gridded ra,dec for args.stamp_size x stamp_size postage stamps </span>
        <span class="n">size_arcsec</span><span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">stamp_size</span> <span class="o">*</span> <span class="mf">0.262</span> <span class="o">*</span> <span class="mi">2</span> <span class="c1">#arcsec, 2 for added buffer</span>
        <span class="c1"># 20x20 grid</span>
        <span class="n">dd</span><span class="o">=</span> <span class="n">size_arcsec</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="c1">#&#39;&#39; offsect from center</span>
        <span class="n">dd</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="o">-</span><span class="n">dd</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">dd</span><span class="p">))</span>
        <span class="n">dd</span><span class="o">/=</span> <span class="mf">3600.</span> <span class="c1">#arcsec -&gt; deg</span>
        <span class="c1"># Don&#39;t exceed brick half width - 100&#39;&#39;</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">0.25</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">100.</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span>
        <span class="n">brickc_ra</span><span class="p">,</span><span class="n">brickc_dec</span><span class="o">=</span> <span class="n">radec_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">radec_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dec</span><span class="p">,</span><span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">dd</span><span class="o">+</span> <span class="n">brickc_dec</span><span class="p">,</span> <span class="n">dd</span><span class="o">+</span> <span class="n">brickc_ra</span><span class="p">)</span> 
        <span class="n">dec</span><span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">ra</span><span class="o">=</span> <span class="n">ra</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Samp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">dec</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">keep</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">Samp</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span>
        <span class="n">Samp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span><span class="n">ra</span><span class="p">)</span>
        <span class="n">Samp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span><span class="n">dec</span><span class="p">)</span>
    <span class="c1"># Rowstart -&gt; Rowend</span>
    <span class="n">Samp</span><span class="o">=</span> <span class="n">Samp</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">rowstart</span><span class="p">:</span><span class="n">args</span><span class="o">.</span><span class="n">rowstart</span><span class="o">+</span><span class="n">maxobjs</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Max sample size=</span><span class="si">%d</span><span class="s1">, actual sample size=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxobjs</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Samp</span><span class="p">)))</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Samp</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">maxobjs</span><span class="p">)</span>
    <span class="n">t0</span><span class="o">=</span> <span class="n">ptime</span><span class="p">(</span><span class="s1">&#39;Got input_sample&#39;</span><span class="p">,</span><span class="n">t0</span><span class="p">)</span>

    <span class="c1"># Store args in dict for easy func passing</span>
    <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">Samp</span><span class="o">=</span><span class="n">Samp</span><span class="p">,</span>\
                <span class="n">brickname</span><span class="o">=</span><span class="n">brickname</span><span class="p">,</span> \
                <span class="n">decals_sim_dir</span><span class="o">=</span> <span class="n">decals_sim_dir</span><span class="p">,</span>\
                <span class="n">brickwcs</span><span class="o">=</span> <span class="n">brickwcs</span><span class="p">,</span> \
                <span class="n">objtype</span><span class="o">=</span><span class="n">objtype</span><span class="p">,</span>\
                <span class="n">nobj</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">Samp</span><span class="p">),</span>\
                <span class="n">maxobjs</span><span class="o">=</span><span class="n">maxobjs</span><span class="p">,</span>\
                <span class="n">rowst</span><span class="o">=</span><span class="n">rowst</span><span class="p">,</span>\
                <span class="n">rowend</span><span class="o">=</span><span class="n">rowend</span><span class="p">,</span>\
                <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># Stop if starting row exceeds length of radec,color table</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Samp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fn</span><span class="o">=</span> <span class="n">get_savedir</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_exceeded.txt&#39;</span>
        <span class="n">junk</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;touch </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrote </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;starting row=</span><span class="si">%d</span><span class="s1"> exceeds number of artificial sources, quit&#39;</span> <span class="o">%</span> <span class="n">rowst</span><span class="p">)</span>
    
    <span class="c1"># Create simulated catalogues and run Tractor</span>
    <span class="n">create_metadata</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">t0</span><span class="o">=</span> <span class="n">ptime</span><span class="p">(</span><span class="s1">&#39;create_metadata&#39;</span><span class="p">,</span><span class="n">t0</span><span class="p">)</span>
    <span class="c1"># do chunks</span>
    <span class="c1">#for ith_chunk in chunk_list:</span>
    <span class="c1">#log.info(&#39;Working on chunk {:02d}/{:02d}&#39;.format(ith_chunk,kwargs[&#39;nchunk&#39;]-1))</span>
    <span class="c1"># Random ra,dec and source properties</span>
    <span class="n">create_ith_simcat</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">t0</span><span class="o">=</span> <span class="n">ptime</span><span class="p">(</span><span class="s1">&#39;create_ith_simcat&#39;</span><span class="p">,</span><span class="n">t0</span><span class="p">)</span>
    <span class="c1"># Run tractor</span>
    <span class="n">do_one_chunk</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">t0</span><span class="o">=</span> <span class="n">ptime</span><span class="p">(</span><span class="s1">&#39;do_one_chunk&#39;</span><span class="p">,</span><span class="n">t0</span><span class="p">)</span>
    <span class="c1"># Clean up output</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cutouts</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">do_ith_cleanup</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">t0</span><span class="o">=</span> <span class="n">ptime</span><span class="p">(</span><span class="s1">&#39;do_ith_cleanup&#39;</span><span class="p">,</span><span class="n">t0</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;All done!&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span></div>
     
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2014-2017, DESI Collaboration.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>