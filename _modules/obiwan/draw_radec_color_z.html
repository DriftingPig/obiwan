
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>obiwan.draw_radec_color_z &#8212; obiwan 1.2.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for obiwan.draw_radec_color_z</h1><div class="highlight"><pre>
<span></span><span class="c1"># See LICENSE.rst for BSD 3-clause license info</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">=========================</span>
<span class="sd">obiwan.draw_radec_color_z</span>
<span class="sd">=========================</span>

<span class="sd">mpi4py to draw N random ra,dec with grzW1,Re,redshift info from KDEs</span>
<span class="sd">These N ra,dec rows are written to N/n_tasks fits files</span>
<span class="sd">fits2db to load those N/n_tasks fits files into the PostgresQL DB</span>
<span class="sd">Add bricks table to DB and index on that</span>
<span class="sd">func(brick) -- returns all ra,dec in a given brick</span>
<span class="sd">Write n_bricks fits files containing these various ra,dec</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="k">import</span> <span class="n">make_axes_locatable</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">astrometry.util.ttime</span> <span class="k">import</span> <span class="n">Time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">from</span> <span class="nn">astrometry.util.fits</span> <span class="k">import</span> <span class="n">fits_table</span><span class="p">,</span> <span class="n">merge_tables</span>
<span class="kn">from</span> <span class="nn">theValidator.catalogues</span> <span class="k">import</span> <span class="n">CatalogueFuncs</span>

<span class="kn">from</span> <span class="nn">legacypipe.survey</span> <span class="k">import</span> <span class="n">LegacySurveyData</span><span class="p">,</span> <span class="n">wcs_for_brick</span>

<span class="c1">######## </span>
<span class="c1">## Ted&#39;s</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">contextmanager</span>

<div class="viewcode-block" id="stdouterr_redirected"><a class="viewcode-back" href="../../index.html#obiwan.draw_radec_color_z.stdouterr_redirected">[docs]</a><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">stdouterr_redirected</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Based on http://stackoverflow.com/questions/5081657</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
    <span class="n">fde</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>

    <span class="c1">##### assert that Python and C stdio write using the same file descriptor</span>
    <span class="c1">####assert libc.fileno(ctypes.c_void_p.in_dll(libc, &quot;stdout&quot;)) == fd == 1</span>

    <span class="k">def</span> <span class="nf">_redirect_stdout</span><span class="p">(</span><span class="n">to</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># + implicit flush()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">fd</span><span class="p">)</span> <span class="c1"># fd writes to &#39;to&#39; file</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="c1"># Python writes to fd</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># + implicit flush()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">fde</span><span class="p">)</span> <span class="c1"># fd writes to &#39;to&#39; file</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">fde</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="c1"># Python writes to fd</span>
        
    <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">fd</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">old_stdout</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">comm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Begin log redirection to </span><span class="si">{}</span><span class="s2"> at </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">pto</span> <span class="o">=</span> <span class="n">to</span>
        <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">pto</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">pto</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pto</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">_redirect_stdout</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pto</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pto</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">_redirect_stdout</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="c1"># allow code to be run with the redirected stdout</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">_redirect_stdout</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">old_stdout</span><span class="p">)</span> <span class="c1"># restore stdout.</span>
                                            <span class="c1"># buffering and flags such as</span>
                                            <span class="c1"># CLOEXEC may be different</span>
            <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># concatenate per-process files</span>
                <span class="n">comm</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;================= Process </span><span class="si">{}</span><span class="s2"> =================</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                            <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
                                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="n">comm</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">comm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;End log redirection to </span><span class="si">{}</span><span class="s2"> at </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            
    <span class="k">return</span></div>
<span class="c1">##############</span>

<span class="k">def</span> <span class="nf">ptime</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="n">t0</span><span class="p">):</span>
    <span class="n">tnow</span><span class="o">=</span><span class="n">Time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TIMING:</span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">text</span><span class="p">,</span><span class="n">tnow</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tnow</span>

<span class="k">def</span> <span class="nf">read_lines</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">fin</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lines</span><span class="o">=</span><span class="n">fin</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">fin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;lines not read properly from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span> <span class="p">)</span>

<span class="k">def</span> <span class="nf">dobash</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;UNIX cmd: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ValueError</span>

<div class="viewcode-block" id="get_area"><a class="viewcode-back" href="../../index.html#obiwan.draw_radec_color_z.get_area">[docs]</a><span class="k">def</span> <span class="nf">get_area</span><span class="p">(</span><span class="n">radec</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;returns area on sphere between ra1,ra2,dec2,dec1</span>
<span class="sd">    https://github.com/desihub/imaginglss/model/brick.py#L64, self.area=...</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span>
    <span class="c1"># Wrap around</span>
    <span class="k">if</span> <span class="n">radec</span><span class="p">[</span><span class="s1">&#39;ra2&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">radec</span><span class="p">[</span><span class="s1">&#39;ra1&#39;</span><span class="p">]:</span>
        <span class="n">ra2</span><span class="o">=</span><span class="n">radec</span><span class="p">[</span><span class="s1">&#39;ra2&#39;</span><span class="p">]</span><span class="o">+</span><span class="mf">360.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ra2</span><span class="o">=</span><span class="n">radec</span><span class="p">[</span><span class="s1">&#39;ra2&#39;</span><span class="p">]</span>
    
    <span class="n">area</span><span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">radec</span><span class="p">[</span><span class="s1">&#39;dec2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">deg</span><span class="p">)</span><span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">radec</span><span class="p">[</span><span class="s1">&#39;dec1&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">deg</span><span class="p">))</span> <span class="o">*</span> \
          <span class="p">(</span><span class="n">ra2</span> <span class="o">-</span> <span class="n">radec</span><span class="p">[</span><span class="s1">&#39;ra1&#39;</span><span class="p">])</span> <span class="o">*</span> \
          <span class="n">deg</span><span class="o">*</span> <span class="mi">129600</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">approx_area</span><span class="o">=</span> <span class="p">(</span><span class="n">radec</span><span class="p">[</span><span class="s1">&#39;dec2&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">radec</span><span class="p">[</span><span class="s1">&#39;dec1&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">ra2</span><span class="o">-</span><span class="n">radec</span><span class="p">[</span><span class="s1">&#39;ra1&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;approx area=</span><span class="si">%.2f</span><span class="s1"> deg2, actual area=</span><span class="si">%.2f</span><span class="s1"> deg2&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">approx_area</span><span class="p">,</span><span class="n">area</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">area</span></div>

<div class="viewcode-block" id="get_radec"><a class="viewcode-back" href="../../index.html#obiwan.draw_radec_color_z.get_radec">[docs]</a><span class="k">def</span> <span class="nf">get_radec</span><span class="p">(</span><span class="n">radec</span><span class="p">,</span>\
              <span class="n">ndraws</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;Draws ndraws samples of Ra,Dec from the unit sphere.</span>

<span class="sd">	Args:</span>
<span class="sd">		radec: dict with keys ra1,ra2,dec1,dec2</span>
<span class="sd">			the ra,dec limits for the sample</span>
<span class="sd">		ndraws: number of samples</span>
<span class="sd">		randome_state: numpy random number generator</span>

<span class="sd">	Returns:</span>
<span class="sd">		ra,dec: tuple of arrays having length ndraws</span>

<span class="sd">	Note: </span>
<span class="sd">		Taken from </span>
<span class="sd">		https://github.com/desihub/imaginglss/blob/master/scripts/imglss-mpi-make-random.py#L55</span>
<span class="sd">	&quot;&quot;&quot;</span>
    <span class="n">ramin</span><span class="p">,</span><span class="n">ramax</span><span class="o">=</span> <span class="n">radec</span><span class="p">[</span><span class="s1">&#39;ra1&#39;</span><span class="p">],</span><span class="n">radec</span><span class="p">[</span><span class="s1">&#39;ra2&#39;</span><span class="p">]</span>
    <span class="n">dcmin</span><span class="p">,</span><span class="n">dcmax</span><span class="o">=</span> <span class="n">radec</span><span class="p">[</span><span class="s1">&#39;dec1&#39;</span><span class="p">],</span><span class="n">radec</span><span class="p">[</span><span class="s1">&#39;dec2&#39;</span><span class="p">]</span>
    <span class="n">u1</span><span class="p">,</span><span class="n">u2</span><span class="o">=</span> <span class="n">random_state</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ndraws</span><span class="p">)</span> <span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">cmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dcmin</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
    <span class="n">cmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dcmax</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">RA</span>   <span class="o">=</span> <span class="n">ramin</span> <span class="o">+</span> <span class="n">u1</span><span class="o">*</span><span class="p">(</span><span class="n">ramax</span><span class="o">-</span><span class="n">ramin</span><span class="p">)</span>
    <span class="n">DEC</span>  <span class="o">=</span> <span class="mi">90</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cmin</span><span class="o">+</span><span class="n">u2</span><span class="o">*</span><span class="p">(</span><span class="n">cmax</span><span class="o">-</span><span class="n">cmin</span><span class="p">))</span><span class="o">*</span><span class="mf">180.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">return</span> <span class="n">RA</span><span class="p">,</span><span class="n">DEC</span></div>

<div class="viewcode-block" id="KdeSample"><a class="viewcode-back" href="../../index.html#obiwan.draw_radec_color_z.KdeSample">[docs]</a><span class="k">class</span> <span class="nc">KdeSample</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;Sample color + redshift + morphology from each galaxy KDE</span>

<span class="sd">	Note: </span>
<span class="sd">		uses saved KDE from obiwan.priors.KernelOfTruth()	</span>

<span class="sd">	Args:</span>
<span class="sd">		objtype: star,elg,lrg,qso</span>
<span class="sd">		pickle_dir: where the fit KDE was written</span>

<span class="sd">	Attributes:</span>
<span class="sd">		objtype: star,elg,lrg,qso</span>
<span class="sd">		pickle_dir: where the fit KDE was written</span>
<span class="sd">		kde: fit KDE</span>
<span class="sd">	&quot;&quot;&quot;</span>
		
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">objtype</span><span class="o">=</span><span class="s1">&#39;star&#39;</span><span class="p">,</span><span class="n">pickle_dir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">objtype</span><span class="o">=</span> <span class="n">objtype</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kdefn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pickle_dir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-kde.pickle&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">objtype</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kde</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kde</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">get_kde</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">fout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kdefn</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
		<span class="n">kde</span><span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fout</span><span class="p">)</span>
		<span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">kde</span>

	<span class="k">def</span> <span class="nf">get_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ndraws</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">()):</span>
		<span class="n">samp</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kde</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="n">ndraws</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objtype</span> <span class="o">==</span> <span class="s1">&#39;star&#39;</span><span class="p">:</span>
			<span class="c1">#labels=[&#39;r wdust&#39;,&#39;r-z&#39;,&#39;g-r&#39;]</span>
			<span class="n">r</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">z</span><span class="o">=</span> <span class="n">r</span><span class="o">-</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">g</span><span class="o">=</span> <span class="n">r</span><span class="o">+</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
			<span class="k">return</span> <span class="n">g</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">z</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">objtype</span> <span class="o">==</span> <span class="s1">&#39;qso&#39;</span><span class="p">:</span>
			<span class="c1">#labels=[&#39;r wdust&#39;,&#39;r-z&#39;,&#39;g-r&#39;]</span>
			<span class="n">r</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">z</span><span class="o">=</span> <span class="n">r</span><span class="o">-</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">g</span><span class="o">=</span> <span class="n">r</span><span class="o">+</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
			<span class="n">redshift</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
			<span class="k">return</span> <span class="n">g</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">redshift</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">objtype</span> <span class="o">==</span> <span class="s1">&#39;elg&#39;</span><span class="p">:</span>
			<span class="c1">#labels=[&#39;r wdust&#39;,&#39;r-z&#39;,&#39;g-r&#39;] </span>
			<span class="n">r</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">z</span><span class="o">=</span> <span class="n">r</span><span class="o">-</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">g</span><span class="o">=</span> <span class="n">r</span><span class="o">+</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
			<span class="n">redshift</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
			<span class="n">rhalf</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>
			<span class="k">return</span> <span class="n">g</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">redshift</span><span class="p">,</span><span class="n">rhalf</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">objtype</span> <span class="o">==</span> <span class="s1">&#39;lrg&#39;</span><span class="p">:</span>
			<span class="c1">#labels=[&#39;z wdust&#39;,&#39;r-z&#39;,&#39;r-W1&#39;,&#39;g wdust&#39;]</span>
			<span class="n">z</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">r</span><span class="o">=</span> <span class="n">z</span><span class="o">+</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">w1</span><span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
			<span class="n">redshift</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
			<span class="n">g</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>
			<span class="n">rhalf</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span>
			<span class="k">return</span> <span class="n">g</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">w1</span><span class="p">,</span><span class="n">redshift</span><span class="p">,</span><span class="n">rhalf</span>
		<span class="k">else</span><span class="p">:</span> 
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;objecttype= </span><span class="si">%s</span><span class="s1">, not supported&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">objtype</span><span class="p">)</span></div>



<div class="viewcode-block" id="KDEColors"><a class="viewcode-back" href="../../index.html#obiwan.draw_radec_color_z.KDEColors">[docs]</a><span class="k">class</span> <span class="nc">KDEColors</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;Sample color + redshift from each galaxy KDE</span>

<span class="sd">	Note: </span>
<span class="sd">		uses saved KDE from obiwan.priors.KernelOfTruth()	</span>

<span class="sd">	Args:</span>
<span class="sd">		objtype: star,elg,lrg,qso</span>
<span class="sd">		pickle_dir: where the fit KDE was written</span>

<span class="sd">	Attributes:</span>
<span class="sd">		objtype: star,elg,lrg,qso</span>
<span class="sd">		pickle_dir: where the fit KDE was written</span>
<span class="sd">		kde: fit KDE</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">objtype</span><span class="o">=</span><span class="s1">&#39;star&#39;</span><span class="p">,</span><span class="n">pickle_dir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">objtype</span><span class="o">=</span> <span class="n">objtype</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kdefn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pickle_dir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-kde.pickle&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">objtype</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kde</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kde</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">get_kde</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">fout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kdefn</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
		<span class="n">kde</span><span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fout</span><span class="p">)</span>
		<span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">kde</span>

	<span class="k">def</span> <span class="nf">get_colors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ndraws</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">()):</span>
		<span class="n">samp</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kde</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="n">ndraws</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objtype</span> <span class="o">==</span> <span class="s1">&#39;star&#39;</span><span class="p">:</span>
			<span class="c1">#labels=[&#39;r wdust&#39;,&#39;r-z&#39;,&#39;g-r&#39;]</span>
			<span class="n">r</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">z</span><span class="o">=</span> <span class="n">r</span><span class="o">-</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">g</span><span class="o">=</span> <span class="n">r</span><span class="o">+</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
			<span class="k">return</span> <span class="n">g</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">z</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">objtype</span> <span class="o">==</span> <span class="s1">&#39;qso&#39;</span><span class="p">:</span>
			<span class="c1">#labels=[&#39;r wdust&#39;,&#39;r-z&#39;,&#39;g-r&#39;]</span>
			<span class="n">r</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">z</span><span class="o">=</span> <span class="n">r</span><span class="o">-</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">g</span><span class="o">=</span> <span class="n">r</span><span class="o">+</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
			<span class="n">redshift</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
			<span class="k">return</span> <span class="n">g</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">redshift</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">objtype</span> <span class="o">==</span> <span class="s1">&#39;elg&#39;</span><span class="p">:</span>
			<span class="c1">#labels=[&#39;r wdust&#39;,&#39;r-z&#39;,&#39;g-r&#39;] </span>
			<span class="n">r</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">z</span><span class="o">=</span> <span class="n">r</span><span class="o">-</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">g</span><span class="o">=</span> <span class="n">r</span><span class="o">+</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
			<span class="n">redshift</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
			<span class="k">return</span> <span class="n">g</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">redshift</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">objtype</span> <span class="o">==</span> <span class="s1">&#39;lrg&#39;</span><span class="p">:</span>
			<span class="c1">#labels=[&#39;z wdust&#39;,&#39;r-z&#39;,&#39;r-W1&#39;,&#39;g wdust&#39;]</span>
			<span class="n">z</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">r</span><span class="o">=</span> <span class="n">z</span><span class="o">+</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">redshift</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
			<span class="n">g</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>
			<span class="k">return</span> <span class="n">g</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">redshift</span>
		<span class="k">else</span><span class="p">:</span> 
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;objecttype= </span><span class="si">%s</span><span class="s1">, not supported&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">objtype</span><span class="p">)</span></div>

<div class="viewcode-block" id="KDEshapes"><a class="viewcode-back" href="../../index.html#obiwan.draw_radec_color_z.KDEshapes">[docs]</a><span class="k">class</span> <span class="nc">KDEshapes</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;Sample morphology from each galaxy KDE</span>

<span class="sd">	Note: </span>
<span class="sd">		uses saved KDE from obiwan.priors.KernelOfTruth()	</span>

<span class="sd">	Args:</span>
<span class="sd">		objtype: star,elg,lrg,qso</span>
<span class="sd">		pickle_dir: where the fit KDE was written</span>

<span class="sd">	Attributes:</span>
<span class="sd">		objtype: star,elg,lrg,qso</span>
<span class="sd">		pickle_dir: where the fit KDE was written</span>
<span class="sd">		kde: fit KDE</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">objtype</span><span class="o">=</span><span class="s1">&#39;elg&#39;</span><span class="p">,</span><span class="n">pickle_dir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
		<span class="k">assert</span><span class="p">(</span><span class="n">objtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lrg&#39;</span><span class="p">,</span><span class="s1">&#39;elg&#39;</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">objtype</span><span class="o">=</span> <span class="n">objtype</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kdefn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pickle_dir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-kde.pickle&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">objtype</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kde</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kde</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">get_kde</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">fout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kdefn</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
		<span class="n">kde</span><span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fout</span><span class="p">)</span>
		<span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">kde</span>

	<span class="k">def</span> <span class="nf">get_shapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ndraws</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">()):</span>
		<span class="n">samp</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kde</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="n">ndraws</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
		<span class="c1"># Same for elg,lrg</span>
		<span class="n">re</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">n</span><span class="o">=</span>  <span class="n">samp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
		<span class="n">ba</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
		<span class="n">pa</span><span class="o">=</span> <span class="n">samp</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
		<span class="c1"># pa ~ flat PDF</span>
		<span class="n">pa</span><span class="o">=</span>  <span class="n">random_state</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">,</span> <span class="n">ndraws</span><span class="p">)</span>
		<span class="c1"># ba can be [1,1.2] due to KDE algorithm, make these 1</span>
		<span class="n">ba</span><span class="p">[</span> <span class="n">ba</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="p">]</span><span class="o">=</span> <span class="mf">0.1</span>
		<span class="n">ba</span><span class="p">[</span> <span class="n">ba</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">]</span><span class="o">=</span> <span class="mf">1.</span>
		<span class="c1"># Sanity Check</span>
		<span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">re</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span>\
					  <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)))</span>
		<span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">ba</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span>\
					  <span class="p">(</span><span class="n">ba</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">)))</span>
		<span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">pa</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span>\
					  <span class="p">(</span><span class="n">pa</span> <span class="o">&lt;=</span> <span class="mi">180</span><span class="p">)))</span>
		
		<span class="k">return</span> <span class="n">re</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">ba</span><span class="p">,</span><span class="n">pa</span></div>

<span class="k">def</span> <span class="nf">get_sample_dir</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_randoms&#39;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>

<div class="viewcode-block" id="mkdir_needed"><a class="viewcode-back" href="../../index.html#obiwan.draw_radec_color_z.mkdir_needed">[docs]</a><span class="k">def</span> <span class="nf">mkdir_needed</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;make each needed directory </span>
<span class="sd">    d= dictionary, vars(args)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dirs</span><span class="o">=</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;outdir&#39;</span><span class="p">]]</span>
    <span class="n">dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">get_sample_dir</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;outdir&#39;</span><span class="p">],</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">])</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dr</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span></div>

<div class="viewcode-block" id="write_calling_seq"><a class="viewcode-back" href="../../index.html#obiwan.draw_radec_color_z.write_calling_seq">[docs]</a><span class="k">def</span> <span class="nf">write_calling_seq</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;each `*_randoms/` directory should have a file listing how randoms were created</span>

<span class="sd">    Args:</span>
<span class="sd">      d: dict, vars(args)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dr</span><span class="o">=</span> <span class="n">get_sample_dir</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;outdir&#39;</span><span class="p">],</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">])</span>
    <span class="n">fn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span><span class="s1">&#39;README.txt&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">foo</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">foo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrote </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">get_bybrick_dir</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">):</span> 
    <span class="n">dr</span><span class="o">=</span> <span class="n">get_sample_dir</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span><span class="s1">&#39;bybrick&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_sample_fn</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">rank_</span><span class="si">%d</span><span class="s1">_seed_</span><span class="si">%d</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">seed</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_sample_fns</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="n">dr</span><span class="o">=</span> <span class="n">get_sample_dir</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
    <span class="n">fn</span><span class="o">=</span> <span class="n">get_sample_fn</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">fn</span><span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;sample_1.fits&#39;</span><span class="p">,</span><span class="s1">&#39;sample_*.fits&#39;</span><span class="p">)</span>
    <span class="n">fns</span><span class="o">=</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no fns found&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fns</span>

<span class="k">def</span> <span class="nf">get_brick_sample_fn</span><span class="p">(</span><span class="n">brickname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">fn</span><span class="o">=</span> <span class="n">get_sample_fn</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;sample_&#39;</span><span class="p">,</span><span class="s1">&#39;sample_</span><span class="si">%s</span><span class="s1">_&#39;</span> <span class="o">%</span> <span class="n">brickname</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_brick_sample_fns</span><span class="p">(</span><span class="n">brickname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">dr</span><span class="o">=</span> <span class="n">get_bybrick_dir</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
    <span class="n">fn</span><span class="o">=</span> <span class="n">get_brick_sample_fn</span><span class="p">(</span><span class="n">brickname</span><span class="o">=</span><span class="n">brickname</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="mi">239</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">fn</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="c1"># Haven&#39;t been deleted yet, so glob for all of them</span>
        <span class="n">fn</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span><span class="n">fn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;239.fits&#39;</span><span class="p">,</span><span class="s1">&#39;*.fits&#39;</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">fns</span><span class="o">=</span><span class="n">glob</span><span class="p">(</span><span class="n">fn</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no fns found with wildcard: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="s1">&#39;nofns_wildcard.txt&#39;</span><span class="p">),</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">foo</span><span class="p">:</span>
            <span class="n">foo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">fns</span>

<span class="k">def</span> <span class="nf">get_brick_merged_fn</span><span class="p">(</span><span class="n">brickname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">dr</span><span class="o">=</span> <span class="n">get_bybrick_dir</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
    <span class="n">fn</span><span class="o">=</span> <span class="n">get_brick_sample_fn</span><span class="p">(</span><span class="n">brickname</span><span class="o">=</span><span class="n">brickname</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">fn</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span><span class="n">fn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_1.fits&#39;</span><span class="p">,</span><span class="s1">&#39;.fits&#39;</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">fn</span>


<span class="k">def</span> <span class="nf">survey_bricks_cut2radec</span><span class="p">(</span><span class="n">radec</span><span class="p">):</span>
    <span class="c1">#fn=os.path.join(os.getenv(&#39;LEGACY_SURVEY_DIR&#39;),&#39;survey-bricks-5rows-eboss-ngc.fits.gz&#39;)</span>
    <span class="n">fn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;LEGACY_SURVEY_DIR&#39;</span><span class="p">),</span><span class="s1">&#39;survey-bricks.fits.gz&#39;</span><span class="p">)</span>
    <span class="n">tab</span><span class="o">=</span> <span class="n">fits_table</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">tab</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span> <span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">ra</span> <span class="o">&gt;=</span> <span class="n">radec</span><span class="p">[</span><span class="s1">&#39;ra1&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">ra</span> <span class="o">&lt;=</span> <span class="n">radec</span><span class="p">[</span><span class="s1">&#39;ra2&#39;</span><span class="p">])</span><span class="o">*</span>\
             <span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">dec</span> <span class="o">&gt;=</span> <span class="n">radec</span><span class="p">[</span><span class="s1">&#39;dec1&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">dec</span> <span class="o">&lt;=</span> <span class="n">radec</span><span class="p">[</span><span class="s1">&#39;dec2&#39;</span><span class="p">])</span>
           <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> bricks, cutting to radec&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">tab</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tab</span>
            
<div class="viewcode-block" id="draw_points"><a class="viewcode-back" href="../../index.html#obiwan.draw_radec_color_z.draw_points">[docs]</a><span class="k">def</span> <span class="nf">draw_points</span><span class="p">(</span><span class="n">radec</span><span class="p">,</span><span class="n">unique_ids</span><span class="p">,</span><span class="n">obj</span><span class="o">=</span><span class="s1">&#39;star&#39;</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Args:</span>
<span class="sd">		radec: dict with keys ra1,ra2,dec1,dec2</span>
<span class="sd">			the ra,dec limits for the sample</span>
<span class="sd">		unique_ids: list of unique integers for each draw</span>
<span class="sd">		obj: star,elg,lrg,qso</span>
<span class="sd">		seed: to initialize random number generator</span>
<span class="sd">		outdir: where the fit KDE files are</span>

<span class="sd">	Returns:</span>
<span class="sd">		Nothing, but write a fits_table containing the unique id, ra, dec</span>
<span class="sd">			and color + redshift + morphology info for each source</span>
<span class="sd">	&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;entered draw_points&#39;</span><span class="p">)</span>
    <span class="n">ndraws</span><span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_ids</span><span class="p">)</span>
    <span class="n">random_state</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="o">=</span> <span class="n">get_radec</span><span class="p">(</span><span class="n">radec</span><span class="p">,</span><span class="n">ndraws</span><span class="o">=</span><span class="n">ndraws</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="c1"># Joint Sample</span>
    <span class="n">mags</span><span class="o">=</span><span class="p">{}</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KdeSample&#39;</span><span class="p">)</span>
    <span class="n">kde_obj</span><span class="o">=</span> <span class="n">KdeSample</span><span class="p">(</span><span class="n">objtype</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">pickle_dir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="o">==</span> <span class="s1">&#39;star&#39;</span><span class="p">:</span>
        <span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_g&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">],</span><span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_r&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">],</span><span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_z&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">]</span><span class="o">=</span> \
                    <span class="n">kde_obj</span><span class="o">.</span><span class="n">get_colors</span><span class="p">(</span><span class="n">ndraws</span><span class="o">=</span><span class="n">ndraws</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">obj</span> <span class="o">==</span> <span class="s1">&#39;elg&#39;</span><span class="p">:</span>
        <span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_g&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">],</span><span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_r&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">],</span><span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_z&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">],</span>\
        <span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_redshift&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">],</span> <span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_rhalf&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">]</span><span class="o">=</span> \
                    <span class="n">kde_obj</span><span class="o">.</span><span class="n">get_sample</span><span class="p">(</span><span class="n">ndraws</span><span class="o">=</span><span class="n">ndraws</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">obj</span> <span class="o">==</span> <span class="s1">&#39;lrg&#39;</span><span class="p">:</span>
        <span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_g&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">],</span><span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_r&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">],</span><span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_z&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">],</span><span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_w1&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">],</span>\
        <span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_redshift&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">],</span> <span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_rhalf&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">]</span><span class="o">=</span> \
                    <span class="n">kde_obj</span><span class="o">.</span><span class="n">get_sample</span><span class="p">(</span><span class="n">ndraws</span><span class="o">=</span><span class="n">ndraws</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">obj</span> <span class="o">==</span> <span class="s1">&#39;qso&#39;</span><span class="p">:</span>
        <span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_g&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">],</span><span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_r&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">],</span><span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_z&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">],</span><span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_redshift&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">]</span><span class="o">=</span> \
                    <span class="n">kde_obj</span><span class="o">.</span><span class="n">get_colors</span><span class="p">(</span><span class="n">ndraws</span><span class="o">=</span><span class="n">ndraws</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="c1"># Add n,ba,pa to sample</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;elg&#39;</span><span class="p">,</span><span class="s1">&#39;lrg&#39;</span><span class="p">]:</span>
        <span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_n&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ndraws</span><span class="p">)</span>
        <span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_ba&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">ndraws</span><span class="p">)</span>
        <span class="n">mags</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_pa&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">180.</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">ndraws</span><span class="p">)</span>
    <span class="c1"># Shapes</span>
    <span class="c1">#gfit={}</span>
    <span class="c1">#for obj in [&#39;lrg&#39;,&#39;elg&#39;]:</span>
    <span class="c1">#    kde_obj= KDEshapes(objobje=obj,pickle_dir=outdir)</span>
    <span class="c1">#    gfit[&#39;%s_re&#39;%obj],gfit[&#39;%s_n&#39;%obj],gfit[&#39;%s_ba&#39;%obj],gfit[&#39;%s_pa&#39;%obj]= \</span>
    <span class="c1">#                kde_obj.get_shapes(ndraws=ndraws,random_state=random_state)</span>
    <span class="c1"># Create Sample table</span>
    <span class="n">T</span><span class="o">=</span><span class="n">fits_table</span><span class="p">()</span>
    <span class="n">T</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="n">unique_ids</span><span class="p">)</span>
    <span class="n">T</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;seed&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndraws</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">+</span><span class="n">seed</span><span class="p">)</span>
    <span class="c1"># PSQL &quot;integer&quot; is 4 bytes</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;seed&#39;</span><span class="p">]:</span>
        <span class="n">T</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
    <span class="n">T</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span><span class="n">ra</span><span class="p">)</span>
    <span class="n">T</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span><span class="n">dec</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mags</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">T</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">mags</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="c1">#for key in gfit.keys():</span>
    <span class="c1">#    T.set(key,gfit[key])</span>
    <span class="c1"># Save table</span>
    <span class="n">fn</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_sample_dir</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">obj</span><span class="p">),</span><span class="n">get_sample_fn</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Overwriting </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
    <span class="n">T</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrote </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span></div>

<div class="viewcode-block" id="organize_by_brick"><a class="viewcode-back" href="../../index.html#obiwan.draw_radec_color_z.organize_by_brick">[docs]</a><span class="k">def</span> <span class="nf">organize_by_brick</span><span class="p">(</span><span class="n">sample_fns</span><span class="p">,</span><span class="n">sbricks</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    For each sample_fn, split into bricks</span>
<span class="sd">    get  brick sample fn for that brick and sample</span>
<span class="sd">    write it if does not exist</span>
<span class="sd">    sample_fn -- sample_seed.fits file assigned to that mpi task</span>
<span class="sd">    sbricks -- survey bricks table cut to radec region</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">dr</span><span class="o">=</span> <span class="n">get_bybrick_dir</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sample_fn</span> <span class="ow">in</span> <span class="n">sample_fns</span><span class="p">:</span>
        <span class="c1"># Skip if already looped over bricks for this sample</span>
        <span class="n">check_done</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="n">get_sample_fn</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">check_done</span><span class="o">=</span> <span class="n">check_done</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span><span class="s1">&#39;_done.txt&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">check_done</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;check_done exists: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">check_done</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># </span>
        <span class="n">sample</span><span class="o">=</span> <span class="n">fits_table</span><span class="p">(</span><span class="n">sample_fn</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sample min,max ra,dec= </span><span class="si">%f</span><span class="s1"> </span><span class="si">%f</span><span class="s1"> </span><span class="si">%f</span><span class="s1"> </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">sample</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>\
                                                      <span class="n">sample</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">sample</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="c1"># Loop over survey bricks</span>
        <span class="n">survey</span> <span class="o">=</span> <span class="n">LegacySurveyData</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sbrick</span> <span class="ow">in</span> <span class="n">sbricks</span><span class="p">:</span>
            <span class="c1"># Get output fn for this brick and sample</span>
            <span class="n">fn</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="n">get_brick_sample_fn</span><span class="p">(</span><span class="n">brickname</span><span class="o">=</span><span class="n">sbrick</span><span class="o">.</span><span class="n">brickname</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># Cut sample by brick&#39;s bounds</span>
            <span class="n">brickinfo</span> <span class="o">=</span> <span class="n">survey</span><span class="o">.</span><span class="n">get_brick_by_name</span><span class="p">(</span><span class="n">sbrick</span><span class="o">.</span><span class="n">brickname</span><span class="p">)</span>
            <span class="n">brickwcs</span> <span class="o">=</span> <span class="n">wcs_for_brick</span><span class="p">(</span><span class="n">brickinfo</span><span class="p">)</span>
            <span class="n">ra1</span><span class="p">,</span><span class="n">ra2</span><span class="p">,</span><span class="n">dec1</span><span class="p">,</span><span class="n">dec2</span><span class="o">=</span> <span class="n">brickwcs</span><span class="o">.</span><span class="n">radec_bounds</span><span class="p">()</span>
            <span class="n">keep</span><span class="o">=</span>  <span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">ra</span> <span class="o">&gt;=</span> <span class="n">ra1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">ra</span> <span class="o">&lt;=</span> <span class="n">ra2</span><span class="p">)</span><span class="o">*</span>\
                   <span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">dec</span> <span class="o">&gt;=</span> <span class="n">dec1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">dec</span> <span class="o">&lt;=</span> <span class="n">dec2</span><span class="p">)</span>
            <span class="n">sample2</span><span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">keep</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sample2</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span>
                <span class="n">sample2</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrote </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: sample=</span><span class="si">%s</span><span class="s1"> has no ra,dec in brick=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sample_fn</span><span class="p">,</span><span class="n">sbrick</span><span class="o">.</span><span class="n">brickname</span><span class="p">))</span>
        <span class="c1"># This sample is done</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">check_done</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">foo</span><span class="p">:</span>
            <span class="n">foo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">merge_bybrick</span><span class="p">(</span><span class="n">bricks</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">cleanup</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">brick</span> <span class="ow">in</span> <span class="n">bricks</span><span class="p">:</span>
        <span class="n">outfn</span><span class="o">=</span> <span class="n">get_brick_merged_fn</span><span class="p">(</span><span class="n">brickname</span><span class="o">=</span><span class="n">brick</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">cleanup</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfn</span><span class="p">):</span>
                <span class="c1"># Safe to remove the pieces that went into outfn</span>
                <span class="n">rm_fns</span><span class="o">=</span> <span class="n">get_brick_sample_fns</span><span class="p">(</span><span class="n">brickname</span><span class="o">=</span><span class="n">brick</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">rm_fns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;removing files like: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rm_fns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">rm_fn</span> <span class="ow">in</span> <span class="n">rm_fns</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rm_fn</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">continue</span> 
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfn</span><span class="p">):</span>
            <span class="c1"># We are creating outfn, don&#39;t spend time deleting</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;outfn=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outfn</span><span class="p">)</span>
            <span class="n">fns</span><span class="o">=</span> <span class="n">get_brick_sample_fns</span><span class="p">(</span><span class="n">brickname</span><span class="o">=</span><span class="n">brick</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Wildcard found nothing see outdir/nofns_wildcard.txt</span>
                <span class="k">continue</span> 
            <span class="n">cats</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">fn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fns</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reading </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">fns</span><span class="p">)))</span>
                <span class="k">try</span><span class="p">:</span> 
                    <span class="n">tab</span><span class="o">=</span> <span class="n">fits_table</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> 
                    <span class="n">cats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">tab</span> <span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fits file does not exist: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
            <span class="n">cat</span><span class="o">=</span> <span class="n">merge_tables</span><span class="p">(</span><span class="n">cats</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;fillzero&#39;</span><span class="p">)</span> 
            <span class="n">cat</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outfn</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrote </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outfn</span><span class="p">)</span>
        
        

<span class="c1">#def merge_draws(outdir=&#39;./&#39;,prefix=&#39;&#39;):</span>
<span class="c1">#    &#39;&#39;&#39;merges all fits tables created by draw_points()&#39;&#39;&#39;</span>
<span class="c1">#    # Btable has 5 rows: bricks for the run,ra1,ra2,dec1,dec2 </span>
<span class="c1">#    btable= get_bricks_fn(outdir)</span>
<span class="c1">#    print(&#39;Merging sample tables for %d brick directories&#39; % len(btable))</span>
<span class="c1">#    for brick in btable.brickname:</span>
<span class="c1">#        T= CatalogueFuncs().stack(fns,textfile=False)</span>
<span class="c1">#        # Save</span>
<span class="c1">#        name= get_merged_fn(brick,outdir,prefix=prefix)</span>
<span class="c1">#        if os.path.exists(name):</span>
<span class="c1">#            os.remove(name)</span>
<span class="c1">#            print(&#39;Overwriting %s&#39; % name)</span>
<span class="c1">#        T.writeto(name)</span>
<span class="c1">#        print(&#39;wrote %s&#39; % name)</span>
       

<span class="k">class</span> <span class="nc">PlotTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Plotting Tabulated Quantities&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">=</span> <span class="n">outdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">=</span> <span class="n">prefix</span>
        <span class="c1"># Table </span>
        <span class="n">merge_fn</span><span class="o">=</span> <span class="n">get_merge_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">merge_fn</span><span class="p">)</span>
        <span class="n">tab</span><span class="o">=</span> <span class="n">fits_table</span><span class="p">(</span> <span class="n">merge_fn</span> <span class="p">)</span>
        <span class="c1"># RA, DEC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radec</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span>
        <span class="c1"># Source Properties</span>
        <span class="n">xyrange</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x_star</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">2.2</span><span class="p">],</span>\
                 <span class="n">y_star</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">2.</span><span class="p">],</span>\
                 <span class="n">x_elg</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">2.2</span><span class="p">],</span>\
                 <span class="n">y_elg</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">2.</span><span class="p">],</span>\
                 <span class="n">x_lrg</span><span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">3.</span><span class="p">],</span>\
                 <span class="n">y_lrg</span><span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>\
                 <span class="n">x1_qso</span><span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">3.</span><span class="p">],</span>\
                 <span class="n">y1_qso</span><span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">2.5</span><span class="p">],</span>\
                 <span class="n">x2_qso</span><span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">4.5</span><span class="p">],</span>\
                 <span class="n">y2_qso</span><span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">3.5</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;star&#39;</span><span class="p">,</span><span class="s1">&#39;lrg&#39;</span><span class="p">,</span><span class="s1">&#39;elg&#39;</span><span class="p">,</span><span class="s1">&#39;qso&#39;</span><span class="p">]:</span>
            <span class="c1"># Colors, redshift</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="o">==</span> <span class="s1">&#39;star&#39;</span><span class="p">:</span>
                <span class="n">x</span><span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">star_r</span>
                <span class="n">y</span><span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">star_r</span> <span class="o">-</span> <span class="n">tab</span><span class="o">.</span><span class="n">star_z</span>
                <span class="n">z</span><span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">star_g</span> <span class="o">-</span> <span class="n">tab</span><span class="o">.</span><span class="n">star_r</span>
                <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;r-z&#39;</span><span class="p">,</span><span class="s1">&#39;g-r&#39;</span><span class="p">]</span>
                <span class="n">xylims</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x1</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">24</span><span class="p">),</span><span class="n">y1</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.3</span><span class="p">),</span>\
                            <span class="n">x2</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mf">3.5</span><span class="p">),</span><span class="n">y2</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">X</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">elif</span> <span class="n">obj</span> <span class="o">==</span> <span class="s1">&#39;elg&#39;</span><span class="p">:</span>
                <span class="n">x</span><span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">elg_r</span>
                <span class="n">y</span><span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">elg_r</span> <span class="o">-</span> <span class="n">tab</span><span class="o">.</span><span class="n">elg_z</span>
                <span class="n">z</span><span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">elg_g</span> <span class="o">-</span> <span class="n">tab</span><span class="o">.</span><span class="n">elg_r</span>
                <span class="n">d4</span><span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">elg_redshift</span>
                <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;r-z&#39;</span><span class="p">,</span><span class="s1">&#39;g-r&#39;</span><span class="p">,</span><span class="s1">&#39;redshift&#39;</span><span class="p">]</span>
                <span class="n">xylims</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x1</span><span class="o">=</span><span class="p">(</span><span class="mf">20.5</span><span class="p">,</span><span class="mf">25.5</span><span class="p">),</span><span class="n">y1</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.8</span><span class="p">),</span>\
                            <span class="n">x2</span><span class="o">=</span><span class="n">xyrange</span><span class="p">[</span><span class="s1">&#39;x_elg&#39;</span><span class="p">],</span><span class="n">y2</span><span class="o">=</span><span class="n">xyrange</span><span class="p">[</span><span class="s1">&#39;y_elg&#39;</span><span class="p">],</span>\
                            <span class="n">x3</span><span class="o">=</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">1.6</span><span class="p">),</span><span class="n">y3</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.0</span><span class="p">))</span>
                <span class="n">X</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">d4</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">elif</span> <span class="n">obj</span> <span class="o">==</span> <span class="s1">&#39;lrg&#39;</span><span class="p">:</span>
                <span class="n">x</span><span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">lrg_z</span>
                <span class="n">y</span><span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">lrg_r</span> <span class="o">-</span> <span class="n">tab</span><span class="o">.</span><span class="n">lrg_z</span>
                <span class="n">z</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="c1">#rW1[&#39;red_galaxy&#39;]</span>
                <span class="n">d4</span><span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">lrg_redshift</span>
                <span class="n">M</span><span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">lrg_g</span>
                <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">,</span><span class="s1">&#39;r-z&#39;</span><span class="p">,</span><span class="s1">&#39;r-W1&#39;</span><span class="p">,</span><span class="s1">&#39;redshift&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">]</span>
                <span class="n">xylims</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x1</span><span class="o">=</span><span class="p">(</span><span class="mf">17.</span><span class="p">,</span><span class="mf">22.</span><span class="p">),</span><span class="n">y1</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.7</span><span class="p">),</span>\
                            <span class="n">x2</span><span class="o">=</span><span class="n">xyrange</span><span class="p">[</span><span class="s1">&#39;x_lrg&#39;</span><span class="p">],</span><span class="n">y2</span><span class="o">=</span><span class="n">xyrange</span><span class="p">[</span><span class="s1">&#39;y_lrg&#39;</span><span class="p">],</span>\
                            <span class="n">x3</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.6</span><span class="p">),</span><span class="n">y3</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.</span><span class="p">),</span>\
                            <span class="n">x4</span><span class="o">=</span><span class="p">(</span><span class="mf">17.</span><span class="p">,</span><span class="mi">29</span><span class="p">),</span><span class="n">y4</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.7</span><span class="p">))</span>
                <span class="n">X</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">d4</span><span class="p">,</span><span class="n">M</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">elif</span> <span class="n">obj</span> <span class="o">==</span> <span class="s1">&#39;qso&#39;</span><span class="p">:</span>
                <span class="n">x</span><span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">qso_r</span>
                <span class="n">y</span><span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">qso_r</span> <span class="o">-</span> <span class="n">tab</span><span class="o">.</span><span class="n">qso_z</span>
                <span class="n">z</span><span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">qso_g</span> <span class="o">-</span> <span class="n">tab</span><span class="o">.</span><span class="n">qso_r</span>
                <span class="n">d4</span><span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">qso_redshift</span>
                <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;r-z&#39;</span><span class="p">,</span><span class="s1">&#39;g-r&#39;</span><span class="p">,</span><span class="s1">&#39;redshift&#39;</span><span class="p">]</span>
                <span class="n">hiz</span><span class="o">=</span><span class="mf">2.1</span>
                <span class="n">xylims</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x1</span><span class="o">=</span><span class="p">(</span><span class="mf">15.</span><span class="p">,</span><span class="mi">24</span><span class="p">),</span><span class="n">y1</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span>\
                            <span class="n">x2</span><span class="o">=</span><span class="n">xyrange</span><span class="p">[</span><span class="s1">&#39;x1_qso&#39;</span><span class="p">],</span><span class="n">y2</span><span class="o">=</span><span class="n">xyrange</span><span class="p">[</span><span class="s1">&#39;y1_qso&#39;</span><span class="p">],</span>\
                            <span class="n">x3</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">hiz</span><span class="o">+</span><span class="mf">0.2</span><span class="p">),</span><span class="n">y3</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">))</span>
                <span class="n">X</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">d4</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
 
            <span class="c1"># Shapes</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;elg&#39;</span><span class="p">,</span><span class="s1">&#39;lrg&#39;</span><span class="p">]:</span>
                <span class="n">re</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">ba</span><span class="p">,</span><span class="n">pa</span><span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_re&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">),</span><span class="n">tab</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_n&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">),</span><span class="n">tab</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_ba&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">),</span><span class="n">tab</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_pa&#39;</span><span class="o">%</span><span class="n">obj</span><span class="p">)</span> 
                <span class="n">shape_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;re&#39;</span><span class="p">,</span><span class="s1">&#39;n&#39;</span><span class="p">,</span><span class="s1">&#39;ba&#39;</span><span class="p">,</span><span class="s1">&#39;pa&#39;</span><span class="p">]</span>
                <span class="n">shape_xylims</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x1</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span>\
                            <span class="n">x2</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span>\
                            <span class="n">x3</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">1.2</span><span class="p">),</span>\
                            <span class="n">x4</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="mi">200</span><span class="p">))</span>
                <span class="n">X_shapes</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">re</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">ba</span><span class="p">,</span><span class="n">pa</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            
            <span class="c1"># Plots</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="o">==</span> <span class="s1">&#39;star&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_1band_and_color</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span><span class="n">xylims</span><span class="o">=</span><span class="n">xylims</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">obj</span> <span class="o">==</span> <span class="s1">&#39;qso&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_1band_color_and_redshift</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span><span class="n">xylims</span><span class="o">=</span><span class="n">xylims</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lrg&#39;</span><span class="p">,</span><span class="s1">&#39;elg&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_1band_color_and_redshift</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span><span class="n">xylims</span><span class="o">=</span><span class="n">xylims</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_galaxy_shapes</span><span class="p">(</span><span class="n">X_shapes</span><span class="p">,</span><span class="n">shape_labels</span><span class="p">,</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span><span class="n">xylims</span><span class="o">=</span><span class="n">shape_xylims</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">radec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tab</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span><span class="n">tab</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span>\
                    <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span><span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">xlab</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;RA (deg)&#39;</span><span class="p">)</span>
        <span class="n">ylab</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;DEC (deg)&#39;</span><span class="p">)</span>
        <span class="n">fn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">sample-merged-radec.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">bbox_extra_artists</span><span class="o">=</span><span class="p">[</span><span class="n">xlab</span><span class="p">,</span><span class="n">ylab</span><span class="p">],</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrote </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">plot_1band_and_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">obj</span><span class="o">=</span><span class="s1">&#39;star&#39;</span><span class="p">,</span><span class="n">xylims</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;xylims -- dict of x1,y1,x2,y2,... where x1 is tuple of low,hi for first plot xaxis&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="o">==</span> <span class="s1">&#39;lrg&#39;</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="c1"># Data</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">normed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">X</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span>\
                      <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span><span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xylims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;x2&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;y2&#39;</span><span class="p">])</span>
        <span class="n">xlab</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-large&#39;</span><span class="p">)</span>
        <span class="n">xlab</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-large&#39;</span><span class="p">)</span>
        <span class="n">ylab</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-large&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="o">==</span> <span class="s1">&#39;lrg&#39;</span><span class="p">:</span>
            <span class="c1"># G distribution even though no Targeting cuts on g</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span><span class="n">normed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xylims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;x3&#39;</span><span class="p">])</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;y3&#39;</span><span class="p">])</span>
            <span class="n">xlab</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-large&#39;</span><span class="p">)</span>
        <span class="n">fn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">sample-merged-colors-</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span><span class="n">obj</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">bbox_extra_artists</span><span class="o">=</span><span class="p">[</span><span class="n">xlab</span><span class="p">],</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrote </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_1band_color_and_redshift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">obj</span><span class="o">=</span><span class="s1">&#39;elg&#39;</span><span class="p">,</span><span class="n">xylims</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;xylims -- dict of x1,y1,x2,y2,... where x1 is tuple of low,hi for first plot xaxis&#39;&#39;&#39;</span>
        <span class="c1"># Colormap the color-color plot by redshift</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">([</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">])</span>
        <span class="n">bounds</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;x3&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;x3&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="o">==</span> <span class="s1">&#39;lrg&#39;</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="c1"># Data</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">normed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># color bar with color plot</span>
        <span class="n">axobj</span><span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">X</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="n">X</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span>\
                                 <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span><span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>\
                                 <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>\
                                 <span class="n">vmin</span><span class="o">=</span><span class="n">bounds</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">vmax</span><span class="o">=</span><span class="n">bounds</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">divider3</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">cax3</span> <span class="o">=</span> <span class="n">divider3</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">cbar3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">axobj</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax3</span><span class="p">,</span>\
                             <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">boundaries</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
        <span class="n">cbar3</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;redshift&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span><span class="n">normed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xylims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;x2&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;y2&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;x3&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;y3&#39;</span><span class="p">])</span>
        <span class="n">xlab</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-large&#39;</span><span class="p">)</span>
        <span class="n">xlab</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-large&#39;</span><span class="p">)</span>
        <span class="n">ylab</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-large&#39;</span><span class="p">)</span>
        <span class="n">xlab</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-large&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="o">==</span> <span class="s1">&#39;lrg&#39;</span><span class="p">:</span>
            <span class="c1"># G distribution even though no Targeting cuts on g</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span><span class="n">normed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xylims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;x4&#39;</span><span class="p">])</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;y4&#39;</span><span class="p">])</span>
            <span class="n">xlab</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-large&#39;</span><span class="p">)</span>
        <span class="n">fn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">sample-merged-colors-redshift-</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span><span class="n">obj</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">bbox_extra_artists</span><span class="o">=</span><span class="p">[</span><span class="n">xlab</span><span class="p">],</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrote </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">plot_galaxy_shapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">obj</span><span class="o">=</span><span class="s1">&#39;elg&#39;</span><span class="p">,</span><span class="n">xylims</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;xylims -- dict of x1,y1,x2,y2,... where x1 is tuple of low,hi for first plot xaxis&#39;&#39;&#39;</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="c1"># ba,pa can be slightly greater 1.,180</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span>\
                      <span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)))</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">X</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span>\
                      <span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">)))</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">X</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span>\
                      <span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">180</span><span class="p">)))</span>
        <span class="c1"># plot</span>
        <span class="k">for</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="c1"># Bin Re</span>
            <span class="k">if</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="n">cnt</span><span class="p">],</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span><span class="n">normed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="n">cnt</span><span class="p">],</span><span class="n">normed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># lims</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">xylims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xylims</span><span class="p">[</span><span class="s1">&#39;x</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
                <span class="c1">#ax[cnt,1].set_xlim(xylims[&#39;x2&#39;])</span>
                <span class="c1">#ax[cnt,2].set_xlim(xylims[&#39;x3&#39;])</span>
                <span class="n">xlab</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">col</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-large&#39;</span><span class="p">)</span>
                <span class="c1">#xlab=ax[cnt,1].set_xlabel(labels[1],fontsize=&#39;x-large&#39;)</span>
        <span class="n">fn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">sample-merged-shapes-</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span><span class="n">obj</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">bbox_extra_artists</span><span class="o">=</span><span class="p">[</span><span class="n">xlab</span><span class="p">],</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrote </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="n">fns</span><span class="p">):</span>
    <span class="n">cat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">fn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fns</span><span class="p">):</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reading </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">fns</span><span class="p">)))</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="n">tab</span><span class="o">=</span> <span class="n">fits_table</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> 
            <span class="n">cat</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">cat</span><span class="p">,</span><span class="n">tab</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fits file does not exist: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cat</span>

<span class="k">def</span> <span class="nf">get_parser</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Generate a legacypipe-compatible CCDs file from a set of reduced imaging.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dowhat&#39;</span><span class="p">,</span><span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span><span class="s1">&#39;bybrick&#39;</span><span class="p">,</span><span class="s1">&#39;merge&#39;</span><span class="p">,</span><span class="s1">&#39;cleanup&#39;</span><span class="p">,</span><span class="s1">&#39;check&#39;</span><span class="p">],</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;001&#39;</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--obj&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;star&#39;</span><span class="p">,</span><span class="s1">&#39;elg&#39;</span><span class="p">,</span> <span class="s1">&#39;lrg&#39;</span><span class="p">,</span> <span class="s1">&#39;qso&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ra1&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;bigbox&#39;</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ra2&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;bigbox&#39;</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dec1&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;bigbox&#39;</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dec2&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;bigbox&#39;</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--spacing&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;choosing N radec pionts so points have spacingxspacing arcsec spacing&#39;</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ndraws&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;default space by 10x10 arcsec, number of draws for all mpi tasks&#39;</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--prefix&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Prefix to prepend to the output files.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--outdir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;./radec_points_dir&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Output directory.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--nproc&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of CPUs to use.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span> 

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">Time</span><span class="p">()</span>
    <span class="n">tbegin</span><span class="o">=</span><span class="n">t0</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TIMING:after-imports &#39;</span><span class="p">,</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

    <span class="n">parser</span><span class="o">=</span> <span class="n">get_parser</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TIMING:after argparse&#39;</span><span class="p">,</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

    <span class="c1"># Before mpi, make needed dirs</span>
    <span class="n">mkdir_needed</span><span class="p">(</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>

    <span class="c1"># Write calling sequence to file</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nproc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">mpi4py.MPI</span> <span class="k">import</span> <span class="n">COMM_WORLD</span> <span class="k">as</span> <span class="n">comm</span>
        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">write_calling_seq</span><span class="p">(</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">write_calling_seq</span><span class="p">(</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>
         
    <span class="n">radec</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">radec</span><span class="p">[</span><span class="s1">&#39;ra1&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ra1</span>
    <span class="n">radec</span><span class="p">[</span><span class="s1">&#39;ra2&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ra2</span>
    <span class="n">radec</span><span class="p">[</span><span class="s1">&#39;dec1&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dec1</span>
    <span class="n">radec</span><span class="p">[</span><span class="s1">&#39;dec2&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dec2</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ndraws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Number that could fill a grid with 5x5 arcsec spacing</span>
        <span class="n">ndraws</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">get_area</span><span class="p">(</span><span class="n">radec</span><span class="p">)</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">spacing</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mf">3600.</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ndraws</span><span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">ndraws</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ndraws= </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ndraws</span><span class="p">)</span>
    <span class="n">unique_ids</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ndraws</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Draws per mpi task</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nproc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">unique_ids</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">unique_ids</span><span class="p">,</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span><span class="p">)[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span> 
        <span class="c1">#nper= len(unique_ids) #int(ndraws/float(comm.size))</span>
    <span class="c1">#else: </span>
    <span class="c1">#    nper= ndraws</span>
    <span class="n">t0</span><span class="o">=</span><span class="n">ptime</span><span class="p">(</span><span class="s1">&#39;parse-args&#39;</span><span class="p">,</span><span class="n">t0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nproc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;using mpi&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span>
        <span class="c1">#cnt=0</span>
        <span class="c1">#while os.path.exists(get_fn(args.outdir,seed)):</span>
        <span class="c1">#    print(&#39;skipping, exists: %s&#39; % get_fn(args.outdir,seed))</span>
        <span class="c1">#    cnt+=1</span>
        <span class="c1">#    seed= comm.rank+ comm.size*cnt</span>
        <span class="c1"># Divide and conquer: each task saves a sample</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dowhat</span> <span class="o">==</span> <span class="s1">&#39;sample&#39;</span><span class="p">:</span>
            <span class="c1"># Write {outdir}/input_sample/{prefix}sample_{seed}.fits files</span>
            <span class="c1"># Root 0 makes dirs</span>
            <span class="c1">#if comm.rank == 0:</span>
            <span class="c1">#    dr= get_sample_dir(outdir=args.outdir)</span>
            <span class="c1">#    if not os.path.exists(dr):</span>
            <span class="c1">#        os.makedirs(dr)</span>
            <span class="c1">#    data=dict(dr=dr)</span>
            <span class="c1">#else: </span>
            <span class="c1">#    data=None</span>
            <span class="c1"># Bcast the dir</span>
            <span class="c1">#comm.bcast(data, root=0)</span>
            <span class="c1">#print(&#39;rank=%d, data[&quot;dr&quot;]= &#39; % comm.rank,data[&#39;dr&#39;])</span>
            <span class="n">draw_points</span><span class="p">(</span><span class="n">radec</span><span class="p">,</span><span class="n">unique_ids</span><span class="p">,</span><span class="n">obj</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">dowhat</span> <span class="o">==</span> <span class="s1">&#39;bybrick&#39;</span><span class="p">:</span>
            <span class="c1"># Write {outdir}/input_sample/bybrick/{prefix}sample_{brick}_{seed}.fits files</span>
            <span class="c1"># Root 0 reads survey bricks, makes dirs</span>
            <span class="c1">#if comm.rank == 0:</span>
            <span class="c1">#    d= dict(btable= survey_bricks_cut2radec(radec) )</span>
            <span class="c1">#    # Root 0 makes all dirs could need    </span>
            <span class="c1">#    dr= get_bybrick_dir(outdir=args.outdir)</span>
            <span class="c1">#    if not os.path.exists(dr):</span>
            <span class="c1">#        os.makedirs(dr)</span>
            <span class="c1">#else:</span>
            <span class="c1">#    d=None</span>
            <span class="c1"># Bcast survey bricks</span>
            <span class="c1">#if comm.rank == 1:</span>
            <span class="c1">#    print(&#39;rank 1 before bcast&#39;)</span>
            <span class="c1">#comm.bcast(d, root=0)</span>
            <span class="c1">#if comm.rank == 1:</span>
            <span class="c1">#    print(&#39;rank 1 after bcast&#39;)</span>
            <span class="c1"># All workers</span>
            <span class="c1"># Assign list of samples to each worker</span>
            <span class="n">sample_fns</span><span class="o">=</span> <span class="n">get_sample_fns</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
            <span class="n">sample_fns</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">sample_fns</span><span class="p">,</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span><span class="p">)[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rank </span><span class="si">%d</span><span class="s1">, sample_fns=&#39;</span> <span class="o">%</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span><span class="n">sample_fns</span><span class="p">)</span>
            <span class="c1"># Loop over survey bricks, write brick sample files</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;before read table: rank=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>
            <span class="n">btable</span><span class="o">=</span> <span class="n">survey_bricks_cut2radec</span><span class="p">(</span><span class="n">radec</span><span class="p">)</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after read table: rank=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>
            <span class="n">organize_by_brick</span><span class="p">(</span><span class="n">sample_fns</span><span class="p">,</span><span class="n">btable</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
            <span class="c1"># DONE at this point        </span>
            <span class="c1">#Each task gets its sample file</span>
            <span class="c1">## Divide and conquer: 15k bricks in eBOSS NGC</span>
            <span class="c1">#inds= np.arange(len(btable))</span>
            <span class="c1">#inds= np.array_split(inds,comm.size)[comm.rank]</span>
            <span class="c1">#btable.cut(inds)</span>
            <span class="c1"># Gather, done</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">dowhat</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;merge&#39;</span><span class="p">,</span><span class="s1">&#39;cleanup&#39;</span><span class="p">]:</span>
            <span class="n">brickfn</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="s1">&#39;bricks_for_sample.txt&#39;</span><span class="p">)</span>
            <span class="c1"># See if we can read text file as opposed to entire fits table</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">brickfn</span><span class="p">):</span>
                <span class="n">bricks</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">brickfn</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
                <span class="n">bricks</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">bricks</span><span class="p">,</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span><span class="p">)[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">btable</span><span class="o">=</span> <span class="n">survey_bricks_cut2radec</span><span class="p">(</span><span class="n">radec</span><span class="p">)</span>
                <span class="n">bricks</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">btable</span><span class="o">.</span><span class="n">brickname</span><span class="p">,</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span><span class="p">)[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">brickfn</span><span class="p">):</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">brickfn</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">foo</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">btable</span><span class="o">.</span><span class="n">brickname</span><span class="p">:</span>
                                <span class="n">foo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">b</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrote </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">brickfn</span><span class="p">)</span> 
            <span class="c1"># Either create brick samples or remove them if all have been created and concatenated</span>
            <span class="n">cleanup</span><span class="o">=</span><span class="kc">False</span> 
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dowhat</span> <span class="o">==</span> <span class="s1">&#39;cleanup&#39;</span><span class="p">:</span>
                <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">merge_bybrick</span><span class="p">(</span><span class="n">bricks</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span><span class="n">cleanup</span><span class="o">=</span><span class="n">cleanup</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">dowhat</span> <span class="o">==</span> <span class="s1">&#39;check&#39;</span><span class="p">:</span>
            <span class="n">fns</span><span class="o">=</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="s1">&#39;input_sample/bybrick/</span><span class="si">%s</span><span class="s1">sample_*[0-9][0-9].fits&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">prefix</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="n">fns</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">fns</span><span class="p">,</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span><span class="p">)[</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span> 
            <span class="n">ids</span><span class="o">=</span> <span class="n">combine</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span>
            <span class="n">all_ids</span><span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of unique ids=</span><span class="si">%d</span><span class="s1">, total number ra,dec pts=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_ids</span><span class="p">)),</span><span class="nb">len</span><span class="p">(</span><span class="n">all_ids</span><span class="p">)))</span>
        <span class="c1">#if comm.rank == 0:</span>
        <span class="c1">#    merge_draws(outdir=args.outdir,prefix=args.prefix)</span>
            <span class="c1">#plotobj= PlotTable(outdir=args.outdir,prefix=args.prefix)</span>
        <span class="c1">#images_split= np.array_split(images, comm.size)</span>
        <span class="c1"># HACK, not sure if need to wait for all proc to finish </span>
        <span class="c1">#confirm_files = comm.gather( images_split[comm.rank], root=0 )</span>
        <span class="c1">#if comm.rank == 0:</span>
        <span class="c1">#    print(&#39;Rank 0 gathered the results:&#39;)</span>
        <span class="c1">#    print(&#39;len(images)=%d, len(gathered)=%d&#39; % (len(images),len(confirm_files)))</span>
        <span class="c1">#    tnow= Time()</span>
        <span class="c1">#    print(&quot;TIMING:total %s&quot; % (tnow-tbegin,))</span>
        <span class="c1">#    print(&quot;Done&quot;)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
        <span class="n">seed</span><span class="o">=</span> <span class="mi">1</span>
        <span class="c1">#cnt=1</span>
        <span class="c1">#while os.path.exists(get_fn(args.outdir,seed)):</span>
        <span class="c1">#    print(&#39;skipping, exists: %s&#39; % get_fn(args.outdir,seed))</span>
        <span class="c1">#    cnt+=1</span>
        <span class="c1">#    seed= cnt</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dowhat</span> <span class="o">==</span> <span class="s1">&#39;sample&#39;</span><span class="p">:</span>
            <span class="c1"># Write {outdir}/input_sample/{prefix}sample_{seed}.fits files</span>
            <span class="n">dr</span><span class="o">=</span> <span class="n">get_sample_dir</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="n">obj</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dr</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span>
            <span class="n">draw_points</span><span class="p">(</span><span class="n">radec</span><span class="p">,</span><span class="n">unique_ids</span><span class="p">,</span><span class="n">obj</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">dowhat</span> <span class="o">==</span> <span class="s1">&#39;bybrick&#39;</span><span class="p">:</span>
            <span class="c1"># Assign list of samples to each worker</span>
            <span class="n">sample_fns</span><span class="o">=</span> <span class="n">get_sample_fns</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
            <span class="n">sample_fns</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">sample_fns</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sample_fns=&#39;</span><span class="p">,</span><span class="n">sample_fns</span><span class="p">)</span>
            <span class="c1"># Loop over survey bricks, write brick sample files</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;before read table:&#39;</span><span class="p">)</span>
            <span class="n">btable</span><span class="o">=</span> <span class="n">survey_bricks_cut2radec</span><span class="p">(</span><span class="n">radec</span><span class="p">)</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after read table:&#39;</span><span class="p">)</span>
            <span class="n">organize_by_brick</span><span class="p">(</span><span class="n">sample_fns</span><span class="p">,</span><span class="n">btable</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="mi">154</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
            <span class="c1"># DEPRECATED:</span>
            <span class="c1">## Write {outdir}/input_sample/bybrick/{prefix}sample_{brick}_{seed}.fits files</span>
            <span class="c1">#btable= survey_bricks_cut2radec(radec)</span>
            <span class="c1">#with open(&#39;eboss_ngc_bricks.txt&#39;,&#39;w&#39;) as foo:</span>
            <span class="c1">#    for brick in btable.brickname:</span>
            <span class="c1">#        foo.write(&#39;%s\n&#39; % brick)</span>
            <span class="c1">#dr= get_bybrick_dir(outdir=args.outdir)</span>
            <span class="c1">#if not os.path.exists(dr):</span>
            <span class="c1">#    os.makedirs(dr)</span>
            <span class="c1">## split each sample into its bricks</span>
            <span class="c1">#sample_fns= get_sample_fns(outdir=args.outdir,prefix=args.prefix)</span>
            <span class="c1">#sample_fns= np.array_split(sample_fns,1)[0] </span>
            <span class="c1">## Loop over survey bricks, write brick sample files</span>
            <span class="c1">#organize_by_brick(sample_fns,btable,outdir=args.outdir,seed=seed,prefix=args.prefix)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">dowhat</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;merge&#39;</span><span class="p">,</span><span class="s1">&#39;cleanup&#39;</span><span class="p">]:</span>
            <span class="n">brickfn</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="s1">&#39;bricks_for_sample.txt&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">brickfn</span><span class="p">):</span>
                <span class="c1"># Quicker to read 1 column text file</span>
                <span class="n">bricks</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">brickfn</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
                <span class="n">bricks</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">bricks</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">btable</span><span class="o">=</span> <span class="n">survey_bricks_cut2radec</span><span class="p">(</span><span class="n">radec</span><span class="p">)</span>
                <span class="n">bricks</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">btable</span><span class="o">.</span><span class="n">brickname</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">brickfn</span><span class="p">):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">brickfn</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">foo</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">btable</span><span class="o">.</span><span class="n">brickname</span><span class="p">:</span>
                            <span class="n">foo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">b</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrote </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">brickfn</span><span class="p">)</span> 
            <span class="c1"># Each task gets a list of bricks, merges sample for each brick, removes indiv brick samps </span>
            <span class="n">cleanup</span><span class="o">=</span><span class="kc">False</span> 
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dowhat</span> <span class="o">==</span> <span class="s1">&#39;cleanup&#39;</span><span class="p">:</span>
                <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cleanup=&#39;</span><span class="p">,</span><span class="n">cleanup</span><span class="p">)</span>
            <span class="n">merge_bybrick</span><span class="p">(</span><span class="n">bricks</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span><span class="n">cleanup</span><span class="o">=</span><span class="n">cleanup</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">dowhat</span> <span class="o">==</span> <span class="s1">&#39;check&#39;</span><span class="p">:</span>
            <span class="n">fns</span><span class="o">=</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="s1">&#39;input_sample/bybrick/</span><span class="si">%s</span><span class="s1">sample_*[0-9][0-9].fits&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">prefix</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="n">fns</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">fns</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;len(fns)=&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">fns</span><span class="p">))</span> 
            <span class="n">all_ids</span><span class="o">=</span> <span class="n">combine</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of unique ids=</span><span class="si">%d</span><span class="s1">, total number ra,dec pts=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_ids</span><span class="p">)),</span><span class="nb">len</span><span class="p">(</span><span class="n">all_ids</span><span class="p">)))</span>
        <span class="c1">#</span>
        <span class="c1"># Gather, done</span>
        <span class="c1">#merge_draws(outdir=args.outdir,prefix=args.prefix)</span>
        <span class="c1">#plotobj= PlotTable(outdir=args.outdir,prefix=args.prefix)</span>
        <span class="c1"># Plot table for sanity check</span>
        
        <span class="c1">## Create the file</span>
        <span class="c1">#t0=ptime(&#39;b4-run&#39;,t0)</span>
        <span class="c1">#runit(image_fn, measureargs,\</span>
        <span class="c1">#      zptsfile=zptsfile,zptstarsfile=zptstarsfile)</span>
        <span class="c1">#t0=ptime(&#39;after-run&#39;,t0)</span>
        <span class="c1">#tnow= Time()</span>
        <span class="c1">#print(&quot;TIMING:total %s&quot; % (tnow-tbegin,))</span>
        <span class="c1">#print(&quot;Done&quot;)</span>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2014-2017, DESI Collaboration.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>