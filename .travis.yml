# Travis-CI.org build script
# WARNING: env: and matrix: missing here, but in desitemplate
language: python
python:
  - "2.7"
#  - "3.6"

os:
    - linux
    # - osx
dist: trusty
#dist: precise
sudo: false
#sudo: required

# Additonal apt-get installs
addons:
  apt:
    packages:
		# sphinx builds 
		#- graphviz
		#- texlive-latex-extra
		# legacypipe 
		- dvipng
		- libnetpbm10
		- libnetpbm10-dev
		- netpbm
		- wcslib-dev
		- libcfitsio3
		- libcfitsio3-dev
		- swig
		- gsl-bin
		- libgsl0-dev

cache:
  directories:
  - $HOME/astrometry.net
  - $HOME/dust

install:
    #- if [[ $MAIN_CMD == 'pycodestyle' ]]; then pip install pycodestyle; fi
    #- if [[ $SETUP_CMD == build_sphinx* ]]; then pip install Sphinx; fi
    #- if [[ $SETUP_CMD == 'test --coverage' ]]; then pip install coverage coveralls; fi
    - export WCSLIB_INC="-I/usr/include/wcslib-4.20"
    - export WCSLIB_LIB="-lwcs"

	- pip install -r requirements.txt
	# Legacypipe
    #- pip install Sphinx==1.5.4   # 1.5.6?
    #- pip install numpy
    #- pip install scipy
    #- pip install matplotlib
    #- pip install numpydoc
    #- pip install astropy #==2.0rc1
    #- pip install photutils
	## Obiwan
    #- pip install cython
    #- pip install h5py
    #- pip install pandas
    #- pip install psycopg2
    #- pip install scikit-image
    #- pip install scikit-learn
	# https://github.com/coveralls-clients/coveralls-python
    - pip install coveralls
    # Legacypipe
    - pip install --no-deps --upgrade git+https://github.com/esheldon/fitsio.git#egg=fitsio
    - pip install -v --no-deps --upgrade git+https://github.com/dstndstn/tractor.git

before_script:
    - if [ ! -d "$HOME/astrometry.net" ]; then (cd $HOME; git clone https://github.com/dstndstn/astrometry.net.git); fi
    - (cd $HOME/astrometry.net && git pull) || (rm -Rf $HOME/astrometry.net && cd $HOME && git clone https://github.com/dstndstn/astrometry.net.git);
    - (cd $HOME/astrometry.net && make && make py)

    - mkdir -p $HOME/dust/maps
    - (cd $HOME/dust/maps && wget -c http://portal.nersc.gov/project/cosmo/temp/dstn/travis-ci/maps/SFD_dust_4096_ngp.fits)
    - (cd $HOME/dust/maps && wget -c http://portal.nersc.gov/project/cosmo/temp/dstn/travis-ci/maps/SFD_dust_4096_sgp.fits)
    - export DUST_DIR=$HOME/dust

script:
    - export PYTHONPATH=${PYTHONPATH}:$(pwd)/py:$HOME/astrometry.net
    #- ls $HOME
    #- ls $HOME/astrometry.net
    # Run tests with coverage, results to file named test
	- cd py
	- coverage run obiwan/test/obiwan_test_suite.py test

after_success:
    - (cd py && coveralls debug)
    - (cd py && coveralls)



